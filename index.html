<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geffen Cockpit Dashboard</title>
  <style>
    :root{
      /* Futuristic blue + metallic */
      --bg0:#070B1A;
      --bg1:#0B1230;
      --panel:#0C1638;
      --panel2:#0A1230;

      --ink:#EAF0FF;
      --muted:#B7C2E6;

      --electric:#2D7DFF;
      --electric2:#1E5BFF;
      --cyan:#7BE7FF;

      --metal:#9AA7C1;
      --metal2:#6D7A96;

      --gold:#FFE066;
      --red:#FF5A5A;

      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.18);

      --radius: 18px;
      --radius2: 26px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --serif: ui-serif, Georgia, "Times New Roman", serif;

      /* Ring sizing (bigger box + stable orbit calc in JS) */
      --ringSize: 700px;         /* larger ring stage */
      --nodeW: 180px;
      --nodeH: 64px;
      --ringPad: 34px;           /* safety padding so cards never clip */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(45,125,255,.18), transparent 55%),
                  radial-gradient(1100px 620px at 80% 18%, rgba(123,231,255,.12), transparent 60%),
                  radial-gradient(900px 520px at 60% 95%, rgba(255,224,102,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ===== Dynamic starfield layers ===== */
    .starsA, .starsB, .starsC, .scanlines, .fog{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
    }

    /* Far stars */
    .starsA{
      background-image:
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,.35) 40%, transparent 45%),
        radial-gradient(1px 1px at 120px 180px, rgba(255,255,255,.25) 40%, transparent 45%),
        radial-gradient(1px 1px at 260px 90px, rgba(255,255,255,.22) 40%, transparent 45%),
        radial-gradient(1px 1px at 420px 220px, rgba(255,255,255,.30) 40%, transparent 45%),
        radial-gradient(1px 1px at 640px 140px, rgba(255,255,255,.18) 40%, transparent 45%),
        radial-gradient(1px 1px at 780px 260px, rgba(255,255,255,.22) 40%, transparent 45%);
      background-size: 980px 560px;
      opacity:.35;
      filter: blur(.15px);
      animation: starDriftA 48s linear infinite;
    }
    @keyframes starDriftA{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(-160px, 60px, 0); }
    }

    /* Mid stars */
    .starsB{
      background-image:
        radial-gradient(1.5px 1.5px at 60px 90px, rgba(123,231,255,.26) 35%, transparent 40%),
        radial-gradient(1.5px 1.5px at 240px 260px, rgba(255,255,255,.26) 35%, transparent 40%),
        radial-gradient(1.5px 1.5px at 520px 140px, rgba(255,255,255,.22) 35%, transparent 40%),
        radial-gradient(1.5px 1.5px at 860px 320px, rgba(123,231,255,.22) 35%, transparent 40%),
        radial-gradient(1.5px 1.5px at 740px 80px, rgba(255,255,255,.20) 35%, transparent 40%);
      background-size: 1120px 640px;
      opacity:.30;
      animation: starDriftB 34s linear infinite;
      mix-blend-mode: screen;
    }
    @keyframes starDriftB{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(-240px, 90px, 0); }
    }

    /* Near sparkles */
    .starsC{
      background-image:
        radial-gradient(2px 2px at 110px 120px, rgba(123,231,255,.22) 35%, transparent 40%),
        radial-gradient(2px 2px at 410px 290px, rgba(255,224,102,.16) 35%, transparent 40%),
        radial-gradient(2px 2px at 690px 160px, rgba(123,231,255,.20) 35%, transparent 40%),
        radial-gradient(2px 2px at 980px 360px, rgba(255,255,255,.18) 35%, transparent 40%);
      background-size: 1280px 720px;
      opacity:.18;
      animation: starDriftC 26s linear infinite;
    }
    @keyframes starDriftC{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(-320px, 120px, 0); }
    }

    .scanlines{
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity:.16;
      mix-blend-mode: overlay;
    }

    .fog{
      background:
        radial-gradient(1000px 600px at 25% 60%, rgba(123,231,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 45%, rgba(45,125,255,.09), transparent 60%),
        radial-gradient(700px 420px at 50% 85%, rgba(255,224,102,.06), transparent 65%);
      filter: blur(12px);
      opacity:.6;
      animation: fogMove 14s ease-in-out infinite alternate;
    }
    @keyframes fogMove{
      from{ transform: translate3d(-10px, 0, 0) scale(1.02); }
      to{ transform: translate3d(12px, -8px, 0) scale(1.03); }
    }

    /* ===== Electricity crackle helpers ===== */
    @keyframes edgeCrackle{
      0%, 86%, 100% { opacity:0; transform: translate3d(0,0,0) scale(1); }
      88% { opacity:.55; transform: translate3d(1px,-1px,0) scale(1.01); }
      90% { opacity:.22; transform: translate3d(-1px,1px,0) scale(1.00); }
      92% { opacity:.45; transform: translate3d(2px,0,0) scale(1.01); }
      94% { opacity:0; transform: translate3d(0,0,0) scale(1); }
    }
    @keyframes warnPulse{
      0%, 100% { box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 10px 22px rgba(0,0,0,.35); }
      50% { box-shadow: 0 0 0 1px rgba(123,231,255,.22) inset, 0 0 18px rgba(45,125,255,.32), 0 10px 22px rgba(0,0,0,.35); }
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:5;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,11,26,.78), rgba(7,11,26,.42));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .topbarInner{
      max-width: 1300px;
      margin:0 auto;
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .brand .title{
      font-family: var(--serif);
      letter-spacing:.6px;
      font-weight: 800;
      font-size: 18px;
      line-height:1.1;
      color: var(--ink);
      text-shadow: 0 0 18px rgba(45,125,255,.25);
    }
    .brand .subtitle{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
    }

    .clockBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-family: var(--mono);
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.75));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      min-width: 280px;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .clockBox::after{
      content:"";
      position:absolute; inset:-8px;
      background:
        radial-gradient(18px 10px at 12% 40%, rgba(123,231,255,0), rgba(123,231,255,0) 58%, rgba(123,231,255,.38) 64%, rgba(123,231,255,0) 74%),
        radial-gradient(22px 12px at 78% 70%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.32) 66%, rgba(45,125,255,0) 78%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 7.4s infinite;
    }
    .clockTop{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:center;
    }
    .clockBox .date{ color: rgba(234,240,255,.75); font-size: 12px; }
    .clockBox .time{ color: var(--ink); font-size: 15px; font-weight: 900; }
    .clockBox .ticks{ color: rgba(123,231,255,.85); font-size: 12px; }
    .countdown{
      display:flex;
      justify-content:center;
      gap:8px;
      font-size: 11px;
      color: rgba(234,240,255,.74);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      position:relative;
      overflow:hidden;
    }
    .countdown b{ color: rgba(234,240,255,.92); }
    .countdown.warn{
      border-color: rgba(123,231,255,.22);
      animation: warnPulse 1.6s ease-in-out infinite;
    }
    .countdown.warn::after{
      content:"";
      position:absolute; inset:-8px;
      background:
        radial-gradient(18px 10px at 20% 40%, rgba(123,231,255,0), rgba(123,231,255,0) 58%, rgba(123,231,255,.45) 64%, rgba(123,231,255,0) 74%),
        radial-gradient(22px 12px at 70% 65%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.35) 66%, rgba(45,125,255,0) 78%),
        radial-gradient(16px 10px at 85% 30%, rgba(255,224,102,0), rgba(255,224,102,0) 62%, rgba(255,224,102,.22) 68%, rgba(255,224,102,0) 80%);
      opacity:.55;
      pointer-events:none;
      animation: edgeCrackle .9s infinite;
    }

    .searchWrap{
      flex: 1;
      min-width: 280px;
      max-width: 560px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    /* occasional crackles on search bar */
    .searchWrap::after{
      content:"";
      position:absolute; inset:-10px;
      background:
        radial-gradient(20px 12px at 18% 50%, rgba(123,231,255,0), rgba(123,231,255,0) 58%, rgba(123,231,255,.38) 64%, rgba(123,231,255,0) 76%),
        radial-gradient(22px 12px at 72% 40%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.32) 66%, rgba(45,125,255,0) 78%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 6.6s infinite;
    }
    .searchWrap .lens{
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(123,231,255,.75);
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
    }
    .searchWrap .lens:after{
      content:"";
      position:absolute;
      width: 10px; height: 2px;
      background: rgba(123,231,255,.75);
      right:-8px; bottom:-3px;
      transform: rotate(45deg);
      border-radius: 3px;
    }
    .searchWrap input{
      flex:1;
      background: transparent;
      border: none;
      outline:none;
      color: var(--ink);
      font-family: var(--mono);
      font-size: 13px;
    }
    .searchWrap button{
      border:none;
      cursor:pointer;
      color: #07101f;
      font-weight: 900;
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset, 0 10px 22px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .18s ease;
      flex: 0 0 auto;
    }
    .searchWrap button:hover{ filter: brightness(1.05); }
    .searchWrap button:active{ transform: translateY(1px); }

    /* Main layout */
    .shell{
      position:relative;
      z-index:1;
      max-width: 1300px;
      margin: 18px auto 40px auto;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr; /* left ring + right cockpit */
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1040px){
      .shell{ grid-template-columns: 1fr; }
      :root{ --ringSize: 620px; }
    }
    @media (max-width: 680px){
      :root{ --ringSize: 560px; --nodeW: 168px; }
    }

    /* Left: ring bay */
    .bay{
      position:relative;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.76), rgba(10,18,48,.62));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      /* IMPORTANT: don't clip the orbit */
      overflow: visible;
      min-height: calc(var(--ringSize) + 120px);
    }
    .bay::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: var(--radius2);
      background:
        radial-gradient(900px 420px at 25% 30%, rgba(45,125,255,.22), transparent 60%),
        radial-gradient(700px 360px at 70% 60%, rgba(123,231,255,.14), transparent 55%),
        radial-gradient(520px 320px at 50% 90%, rgba(255,224,102,.08), transparent 60%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    /* cockpit-style border crackles */
    .bay::after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius: calc(var(--radius2) + 8px);
      background:
        radial-gradient(22px 12px at 15% 12%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.32) 66%, rgba(123,231,255,0) 80%),
        radial-gradient(22px 12px at 85% 18%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.28) 66%, rgba(45,125,255,0) 80%),
        radial-gradient(22px 12px at 65% 92%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.28) 66%, rgba(123,231,255,0) 80%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 8.2s infinite;
      z-index:1;
    }

    .bayHeader{
      position:relative;
      z-index:2;
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      border-radius: var(--radius2);
    }
    .bayHeader .h1{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .bayHeader .h1 b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .bayHeader .h1 span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .bayHeader .datePick{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.70);
    }
    .bayHeader .datePickRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .bayHeader input[type="date"]{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.25);
      color: var(--ink);
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
    }
    .bayHeader input[type="date"]:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }

    .ringStage{
      position:relative;
      z-index:2;
      height: calc(var(--ringSize) + 16px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--ringPad) + 10px) var(--ringPad) 18px var(--ringPad);
      user-select:none;
    }

    .ring{
      width: var(--ringSize);
      height: var(--ringSize);
      border-radius: 50%;
      position:relative;
      transform: translateZ(0);
      outline:none;
    }

    /* Track / ring face */
    .ring:before{
      content:"";
      position:absolute;
      inset: 22px;
      border-radius:50%;
      border: 1px solid rgba(123,231,255,.22);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.16) inset,
        0 0 26px rgba(45,125,255,.14),
        0 0 80px rgba(45,125,255,.08);
      background:
        radial-gradient(circle at 50% 50%, rgba(12,22,56,.40), rgba(7,11,26,.55));
      z-index:0;
    }
    .ring:after{
      content:"";
      position:absolute;
      inset: 64px;
      border-radius:50%;
      border: 1px dashed rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    /* Occasional crackles on the ring track */
    .ringCrackle{
      position:absolute;
      inset: 18px;
      border-radius: 50%;
      pointer-events:none;
      opacity:0;
      z-index:1;
      background:
        radial-gradient(26px 14px at 22% 28%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.30) 66%, rgba(123,231,255,0) 78%),
        radial-gradient(30px 16px at 74% 52%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.26) 66%, rgba(45,125,255,0) 78%),
        radial-gradient(24px 14px at 58% 78%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.22) 66%, rgba(123,231,255,0) 78%);
      animation: edgeCrackle 7.0s infinite;
    }

    /* center holo readout (NOW shows daily schedule) */
    .holo{
      position:absolute;
      inset: 140px;
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(12,22,56,.40), rgba(10,18,48,.18));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px rgba(45,125,255,.10) inset;
      backdrop-filter: blur(8px);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 14px 14px 12px 14px;
      pointer-events:none; /* never steals clicks */
      z-index:2;
    }
    .holo .holoTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .holo .tag{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.85);
    }
    .holo .sub{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.65);
      white-space:nowrap;
    }
    .holo .list{
      display:grid;
      gap: 6px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,240,255,.82);
    }
    .holo .line{
      display:flex;
      gap:10px;
      align-items:flex-start;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .holo .dot{
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: rgba(123,231,255,.85);
      box-shadow: 0 0 10px rgba(123,231,255,.35);
      margin-top: 5px;
      flex: 0 0 auto;
    }
    .holo .line.now{ color: rgba(234,240,255,.96); }
    .holo .line.now .dot{ background: rgba(255,224,102,.85); box-shadow: 0 0 12px rgba(255,224,102,.25); }

    /* orbit nodes */
    .node{
      position:absolute;
      width: var(--nodeW);
      height: var(--nodeH);
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      will-change: transform;
      cursor:pointer;
      z-index:3;
    }

    .cardLink{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      text-decoration:none;
      color: var(--ink);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)),
        linear-gradient(180deg, rgba(12,22,56,.78), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.10) inset,
        0 14px 26px rgba(0,0,0,.38);
      position:relative;
      overflow:hidden;
      transition: transform .12s ease, border-color .18s ease, filter .18s ease;
      pointer-events:auto;
    }
    .cardLink:before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(240px 90px at 30% 30%, rgba(123,231,255,.18), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .cardLink:hover{
      transform: translateY(-2px);
      border-color: rgba(123,231,255,.28);
      filter: brightness(1.05);
    }
    .cardLink:active{
      transform: translateY(-1px);
    }

    .cardLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .cardLeft b{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.08em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cardLeft span{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(234,240,255,.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .glyph{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(123,231,255,.85), rgba(45,125,255,.88));
      box-shadow: 0 0 0 1px rgba(255,255,255,.16) inset, 0 10px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#07101f;
      font-weight: 900;
      font-family: var(--mono);
      flex: 0 0 auto;
    }

    /* energy bar */
    .energyWrap{
      position:relative;
      z-index:2;
      padding: 0 14px 14px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .energyBar{
      width: min(720px, 92%);
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.18) inset;
      position:relative;
      overflow:hidden;
    }
    .energyFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(123,231,255,.95), rgba(45,125,255,.92), rgba(255,224,102,.86));
      box-shadow: 0 0 22px rgba(45,125,255,.24);
      transition: width 1.2s ease;
      position:relative;
    }
    .energyBar .crackle{
      position:absolute;
      inset:-10px -8px;
      background:
        radial-gradient(16px 10px at 20% 40%, rgba(123,231,255,.0), rgba(123,231,255,.0) 55%, rgba(123,231,255,.35) 60%, rgba(123,231,255,0) 70%),
        radial-gradient(18px 12px at 60% 70%, rgba(45,125,255,.0), rgba(45,125,255,.0) 58%, rgba(45,125,255,.30) 63%, rgba(45,125,255,0) 74%),
        radial-gradient(14px 10px at 80% 25%, rgba(255,224,102,.0), rgba(255,224,102,.0) 60%, rgba(255,224,102,.22) 66%, rgba(255,224,102,0) 78%);
      opacity: 0;
      pointer-events:none;
      filter: blur(.2px);
      animation: crackle 5.6s infinite;
    }
    @keyframes crackle{
      0%, 84%, 100% { opacity:0; transform: translate3d(0,0,0); }
      86% { opacity:.65; transform: translate3d(0,-1px,0) scale(1.01); }
      88% { opacity:.25; transform: translate3d(2px,0,0) scale(1.00); }
      90% { opacity:.55; transform: translate3d(-1px,1px,0) scale(1.01); }
      92% { opacity:.0; transform: translate3d(0,0,0); }
    }
    .energyMeta{
      margin-top: 8px;
      width: min(720px, 92%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.70);
    }
    .energyMeta b{ color: rgba(234,240,255,.88); }

    /* Right cockpit panel */
    .cockpit{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.82), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cockpit::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(620px 360px at 30% 10%, rgba(123,231,255,.14), transparent 60%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }
    .cockpit::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius: calc(var(--radius2) + 10px);
      background:
        radial-gradient(22px 12px at 10% 22%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.30) 66%, rgba(123,231,255,0) 80%),
        radial-gradient(22px 12px at 90% 48%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.26) 66%, rgba(45,125,255,0) 80%),
        radial-gradient(22px 12px at 55% 92%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.26) 66%, rgba(123,231,255,0) 80%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 8.8s infinite;
      z-index:1;
    }

    .cockHeader{
      position:relative;
      z-index:2;
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
    }
    .cockHeader .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .cockHeader .left b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .cockHeader .left span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .pill{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 10px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
    }
    .pill::after{
      content:"";
      position:absolute; inset:-10px;
      background:
        radial-gradient(18px 10px at 20% 50%, rgba(123,231,255,0), rgba(123,231,255,0) 58%, rgba(123,231,255,.32) 64%, rgba(123,231,255,0) 76%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 9.4s infinite;
    }
    .pill .spark{
      width: 8px; height: 8px; border-radius:50%;
      background: rgba(123,231,255,.95);
      box-shadow: 0 0 12px rgba(123,231,255,.35);
    }

    .cockBody{
      position:relative;
      z-index:2;
      padding: 14px;
      display:grid;
      gap: 12px;
    }

    .module{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(45,125,255,.08) inset, 0 12px 26px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
    }
    .module::after{
      content:"";
      position:absolute; inset:-10px;
      background:
        radial-gradient(20px 12px at 18% 18%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.26) 66%, rgba(123,231,255,0) 80%),
        radial-gradient(20px 12px at 86% 62%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.22) 66%, rgba(45,125,255,0) 80%);
      opacity:0;
      pointer-events:none;
      animation: edgeCrackle 10.6s infinite;
    }

    .moduleHd{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      position:relative;
      z-index:2;
    }
    .moduleHd b{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.88);
    }
    .moduleHd .mini{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 900;
      padding: 9px 10px;
      border-radius: 14px;
      transition: transform .08s ease, filter .18s ease, background .18s ease;
      user-select:none;
      white-space:nowrap;
      position:relative;
      z-index:2;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      color:#07101f;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 12px 22px rgba(0,0,0,.34);
    }
    .btnGhost{
      color: rgba(234,240,255,.88);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.16) inset;
    }
    .btnDanger{
      color: rgba(255,90,90,.95);
      background: rgba(255,90,90,.08);
      border: 1px solid rgba(255,90,90,.22);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
    }
    .btnGhost:hover,.btnPrimary:hover{ filter: brightness(1.05); }

    .moduleBd{
      padding: 12px;
      display:grid;
      gap: 10px;
      position:relative;
      z-index:2;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 1040px){
      .row2{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: rgba(234,240,255,.70);
      margin: 0 0 6px 0;
    }
    input[type="text"], select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.35);
      color: var(--ink);
      padding: 10px 10px;
      outline:none;
      font-family: var(--mono);
      font-size: 13px;
      transition: box-shadow .15s ease, border-color .15s ease;
      position:relative;
      z-index:2;
    }
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }
    textarea{
      min-height: 120px;
      resize: vertical;
    }

    .todaySchedule{
      display:grid;
      gap: 8px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,240,255,.82);
    }
    .period{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .period .l{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .period .l b{
      font-size: 12px;
      color: rgba(234,240,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .period .l span{
      font-size: 11px;
      color: rgba(234,240,255,.62);
    }
    .period .r{
      flex: 0 0 auto;
      color: rgba(123,231,255,.85);
      font-size: 11px;
      white-space:nowrap;
    }
    .period.now{
      border-color: rgba(123,231,255,.28);
      box-shadow: 0 0 0 1px rgba(45,125,255,.10) inset, 0 0 26px rgba(45,125,255,.12);
      background: rgba(45,125,255,.10);
    }

    .tinyHint{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.62);
      line-height:1.25;
      position:relative;
      z-index:2;
    }

    /* Export / import drawer */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 18px;
    }
    .modal{
      width: min(860px, 96vw);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.88));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 24px 80px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHd{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHd b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(123,231,255,.90);
    }
    .modalBd{
      padding: 14px;
      display:grid;
      gap: 10px;
    }

    .footer{
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 16px 26px 16px;
      color: rgba(183,194,230,.72);
      font-family: var(--mono);
      font-size: 11px;
      text-align:center;
      z-index:1;
      position:relative;
    }
  </style>
</head>

<body>
  <div class="starsA"></div>
  <div class="starsB"></div>
  <div class="starsC"></div>
  <div class="fog"></div>
  <div class="scanlines"></div>

  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="title">GEFFEN COCKPIT</div>
        <div class="subtitle">Retro-future dashboard • wheel to rotate the ring</div>
      </div>

      <form class="searchWrap" action="https://www.google.com/search" method="GET" target="_blank" rel="noopener">
        <div class="lens" aria-hidden="true"></div>
        <input id="googleQ" name="q" type="text" placeholder="Search Google…" autocomplete="off" />
        <button type="submit">SEARCH</button>
      </form>

      <div class="clockBox" aria-label="Clock">
        <div class="clockTop">
          <div class="date" id="dateStr">—</div>
          <div class="time" id="timeStr">—</div>
          <div class="ticks" id="ticksStr">.00</div>
        </div>
        <div class="countdown" id="countdownBox">
          <span>Time until next class:</span> <b id="countdownText">—</b>
        </div>
      </div>
    </div>
  </div>

  <main class="shell">
    <!-- LEFT: Ring bay -->
    <section class="bay">
      <div class="bayHeader">
        <div class="h1">
          <b>Navigation Ring</b>
          <span>Scroll your wheel over the ring to rotate. Click a node to launch.</span>
        </div>
        <div class="datePick" aria-label="Select date to view schedule">
          <div style="opacity:.85;">View date</div>
          <div class="datePickRow">
            <input type="date" id="viewDate" />
          </div>
        </div>
      </div>

      <div class="ringStage">
        <div class="ring" id="ring" aria-label="Link ring" tabindex="0">
          <div class="ringCrackle" aria-hidden="true"></div>

          <!-- center holo (daily schedule view) -->
          <div class="holo" aria-hidden="true">
            <div class="holoTop">
              <div class="tag" id="holoTag">Daily Schedule</div>
              <div class="sub" id="holoStatus">—</div>
            </div>
            <div class="list" id="holoList">
              <div class="line"><div class="dot"></div><div>Enter your schedule on the right.</div></div>
            </div>
          </div>
          <!-- nodes inserted by JS -->
        </div>
      </div>

      <div class="energyWrap">
        <div style="width:100%;display:flex;flex-direction:column;align-items:center;">
          <div class="energyBar" aria-label="Energy bar">
            <div class="energyFill" id="energyFill"></div>
            <div class="crackle"></div>
          </div>
          <div class="energyMeta">
            <div><b>ENERGY GRID</b> <span id="energyPct">0%</span></div>
            <div id="energyNote">Awaiting schedule…</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cockpit -->
    <aside class="cockpit">
      <div class="cockHeader">
        <div class="left">
          <b>Control Console</b>
          <span>Schedule + export. Everything saves locally.</span>
        </div>
        <div class="pill"><span class="spark"></span><span id="dayModePill">—</span></div>
      </div>

      <div class="cockBody">
        <!-- Schedule view -->
        <div class="module">
          <div class="moduleHd">
            <b>Schedule View</b>
            <div class="mini">
              <input type="date" id="viewDateRight" title="Select date" style="border-radius:999px;padding:8px 10px;border:1px solid rgba(255,255,255,.14);background:rgba(7,11,26,.25);color:var(--ink);font-family:var(--mono);font-size:12px;outline:none;" />
              <select id="weekMode" title="Week mode (Blue/Gold)">
                <option value="auto">Auto</option>
                <option value="blue">Blue</option>
                <option value="gold">Gold</option>
              </select>
            </div>
          </div>
          <div class="moduleBd">
            <div class="tinyHint" id="todayHint">
              Auto mode uses a locally saved “Blue anchor date” to determine Blue/Gold.
            </div>
            <div class="todaySchedule" id="todaySchedule">
              <div class="period">
                <div class="l">
                  <b>Not configured yet</b>
                  <span>Open Schedule Setup and save your blocks.</span>
                </div>
                <div class="r">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Export / Import -->
        <div class="module">
          <div class="moduleHd">
            <b>Portability</b>
            <div class="mini">
              <button class="btn btnGhost" id="exportBtn" type="button">Export</button>
              <button class="btn btnGhost" id="importBtn" type="button">Import</button>
            </div>
          </div>
          <div class="moduleBd">
            <div class="tinyHint">Export gives you JSON for schedule settings (and any future modules you add). Import restores it.</div>
          </div>
        </div>

        <!-- Schedule setup (collapsed by default) -->
        <div class="module" id="setupModule">
          <div class="moduleHd">
            <b>Schedule Setup</b>
            <div class="mini">
              <button class="btn btnGhost" id="toggleSetup" type="button">Expand</button>
              <button class="btn btnPrimary" id="saveScheduleBtn" type="button">Save</button>
            </div>
          </div>
          <div class="moduleBd" id="setupBody" style="display:none;">
            <div class="row2">
              <div>
                <label>Blue anchor date</label>
                <input id="blueAnchor" type="text" placeholder="YYYY-MM-DD (a Monday you know is Blue)" />
                <div class="tinyHint">Used for Auto week mode. If blank, Auto can’t determine Blue/Gold reliably.</div>
              </div>
              <div>
                <label>Office hours on H block</label>
                <select id="officeHoursMode">
                  <option value="none">None</option>
                  <option value="blue">Blue week only</option>
                  <option value="gold">Gold week only</option>
                  <option value="both">Both weeks</option>
                </select>
                <div class="tinyHint">If set, any H period will display “Office Hours”.</div>
              </div>
            </div>

            <div class="row2">
              <div><label>A block name</label><input id="A" type="text" placeholder="e.g., 10th Global" /></div>
              <div><label>B block name</label><input id="B" type="text" placeholder="e.g., Adv Civ" /></div>
            </div>
            <div class="row2">
              <div><label>C block name</label><input id="C" type="text" /></div>
              <div><label>D block name</label><input id="D" type="text" /></div>
            </div>
            <div class="row2">
              <div><label>E block name</label><input id="E" type="text" /></div>
              <div><label>F block name</label><input id="F" type="text" /></div>
            </div>
            <div class="row2">
              <div><label>G block name</label><input id="G" type="text" /></div>
              <div><label>H block name</label><input id="H" type="text" /></div>
            </div>

            <div class="tinyHint">
              Once saved, the center holo will show the daily schedule for whatever date you’ve selected.
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Export/Import Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Export/Import">
      <div class="modalHd">
        <b id="modalTitle">Export</b>
        <button class="btn btnGhost" id="closeModal" type="button">Close</button>
      </div>
      <div class="modalBd">
        <div class="tinyHint" id="modalHint">Copy this JSON to move your setup to another computer.</div>
        <textarea id="jsonBox" spellcheck="false"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnGhost" id="copyJsonBtn" type="button">Copy</button>
          <button class="btn btnPrimary" id="applyJsonBtn" type="button" style="display:none;">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Wheel rotates the ring • Schedule saved in your browser (localStorage) • Export JSON for portability
  </div>

  <script>
    /************************************************************
     * LINKS (ring nodes)
     ************************************************************/
    const links = [
      { label:"Discussion Tracker", sub:"class-discussion", href:"https://amhagler.github.io/class-discussion/", glyph:"DT" },
      { label:"Seating Chart", sub:"SC", href:"https://amhagler.github.io/SC/", glyph:"SC" },
      { label:"Rubric", sub:"rubric", href:"https://amhagler.github.io/rubric/", glyph:"RB" },
      { label:"Unit Calendar", sub:"uc", href:"https://amhagler.github.io/uc/", glyph:"UC" },
      { label:"Mafia", sub:"mafia", href:"https://amhagler.github.io/mafia/", glyph:"MF" },
      { label:"Trivia", sub:"tr", href:"https://amhagler.github.io/tr/", glyph:"TR" },
      { label:"Portal", sub:"myschoolapp login", href:"https://geffenacademy.myschoolapp.com/app#login", glyph:"PT" },
      { label:"Gradebook", sub:"SIS gradebook", href:"https://geffenacademy.myschoolapp.com/sis-gradebook/gradebook/27966135?svcid=edu&addin=1", glyph:"GB" },
    ];

    const ring = document.getElementById("ring");
    let rotation = 0; // radians
    let targetRotation = 0;

    function buildNodes(){
      ring.querySelectorAll(".node").forEach(n => n.remove());
      links.forEach((l, idx) => {
        const node = document.createElement("div");
        node.className = "node";
        node.dataset.idx = String(idx);
        node.innerHTML = `
          <a class="cardLink" href="${l.href}" target="_blank" rel="noopener">
            <div class="cardLeft">
              <b>${l.label}</b>
              <span>${l.sub}</span>
            </div>
            <div class="glyph">${l.glyph}</div>
          </a>
        `;
        ring.appendChild(node);
      });
    }
    buildNodes();

    // FIX: orbit radius is computed from ring size + card width so nodes NEVER clip.
    function computeOrbitRadius(){
      const cs = getComputedStyle(document.documentElement);
      const nodeW = parseFloat(cs.getPropertyValue("--nodeW")) || 180;
      const ringPad = parseFloat(cs.getPropertyValue("--ringPad")) || 34;
      const w = ring.clientWidth || 600;
      const half = w / 2;
      // keep a margin beyond node half-width
      return Math.max(140, half - (nodeW / 2) - ringPad);
    }

    function layoutNodes(){
      const nodes = Array.from(ring.querySelectorAll(".node"));
      const r = computeOrbitRadius();
      const n = nodes.length;
      for (let i = 0; i < n; i++){
        const theta = (Math.PI * 2) * (i / n) + rotation;
        const x = Math.cos(theta) * r;
        const y = Math.sin(theta) * r;
        nodes[i].style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      }
    }

    ring.addEventListener("wheel", (e) => {
      e.preventDefault();
      targetRotation += (e.deltaY || 0) * 0.0022;
    }, { passive:false });

    function animate(){
      rotation += (targetRotation - rotation) * 0.10;
      layoutNodes();
      requestAnimationFrame(animate);
    }
    animate();

    /************************************************************
     * CLOCK (hundredths) + countdown to next class
     ************************************************************/
    const dateStr = document.getElementById("dateStr");
    const timeStr = document.getElementById("timeStr");
    const ticksStr = document.getElementById("ticksStr");
    const countdownBox = document.getElementById("countdownBox");
    const countdownText = document.getElementById("countdownText");

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      return `${y}-${m}-${da}`;
    }

    function tickClock(){
      const now = new Date();
      dateStr.textContent = isoDate(now);
      timeStr.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
      ticksStr.textContent = `.${pad2(Math.floor(now.getMilliseconds()/10))}`;
      requestAnimationFrame(tickClock);
    }
    tickClock();

    /************************************************************
     * SCHEDULE DATA (Blue/Gold)
     ************************************************************/
    const blueWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"F" },
        { time:"10:20-11:15", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"D" },
        { time:"10:15-11:10", block:"E" },
        { time:"11:20-12:15", block:"F" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"G" },
        { time:"2:10-3:05", block:"A" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"B" },
        { time:"10:15-11:10", block:"C" },
        { time:"11:20-12:15", block:"D" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"E" },
        { time:"2:10-3:05", block:"F" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"G" },
        { time:"10:00-10:55", block:"A" },
        { time:"11:05-12:00", block:"B" },
        { time:"12:00-1:05", block:"MS/US SuperLunch +Affinity Groups" },
        { time:"1:10-2:05", block:"C" },
        { time:"2:10-3:05", block:"D" },
        { time:"3:10-3:50", block:"H/X1" }
      ]
    };

    const goldWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"E" },
        { time:"10:15-11:10", block:"F" },
        { time:"11:20-12:15", block:"G" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"A" },
        { time:"2:10-3:05", block:"B" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"C" },
        { time:"10:20-11:15", block:"D" },
        { time:"11:20-12:15", block:"E" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"F" },
        { time:"2:10-3:05", block:"G" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"F" },
        { time:"10:15-11:10", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"D" },
        { time:"10:00-10:55", block:"E" },
        { time:"11:00-11:45", block:"H" },
        { time:"11:45-12:35", block:"MS/US Lunch +MS/US Clubs" },
        { time:"12:40-1:35", block:"F" },
        { time:"1:40-2:35", block:"G" },
        { time:"2:40-3:20", block:"X3" }
      ]
    };

    const scheduleByWeek = { blue: blueWeek, gold: goldWeek };
    const dayKeys = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];

    function parseTimeToMinutes(t){
      const [hh, mm] = t.split(":").map(Number);
      let h = hh;
      if (h >= 1 && h <= 6) h += 12;
      return h * 60 + (mm||0);
    }
    function parseRange(range){
      const parts = range.split("-");
      if (parts.length !== 2) return null;
      return { start: parseTimeToMinutes(parts[0].trim()), end: parseTimeToMinutes(parts[1].trim()) };
    }

    /************************************************************
     * LOCAL STORAGE STATE
     ************************************************************/
    const LS_KEY = "geffen_cockpit_v2";

    const defaultState = {
      blueAnchor: "",
      officeHoursMode: "none",
      blocks: { A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"" },
      viewDate: "" // YYYY-MM-DD
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return structuredClone(defaultState);
        const obj = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...obj,
          blocks: { ...structuredClone(defaultState.blocks), ...(obj.blocks||{}) },
        };
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /************************************************************
     * UI refs
     ************************************************************/
    const blueAnchorEl = document.getElementById("blueAnchor");
    const officeHoursModeEl = document.getElementById("officeHoursMode");
    const blockEls = ["A","B","C","D","E","F","G","H"].reduce((acc,k)=>{
      acc[k] = document.getElementById(k);
      return acc;
    }, {});
    const saveScheduleBtn = document.getElementById("saveScheduleBtn");
    const toggleSetupBtn = document.getElementById("toggleSetup");
    const setupBody = document.getElementById("setupBody");

    const weekModeEl = document.getElementById("weekMode");
    const dayModePill = document.getElementById("dayModePill");

    const viewDateEl = document.getElementById("viewDate");
    const viewDateRightEl = document.getElementById("viewDateRight");

    const todayScheduleEl = document.getElementById("todaySchedule");
    const todayHintEl = document.getElementById("todayHint");
    const energyFill = document.getElementById("energyFill");
    const energyPct = document.getElementById("energyPct");
    const energyNote = document.getElementById("energyNote");

    const holoList = document.getElementById("holoList");
    const holoStatus = document.getElementById("holoStatus");
    const holoTag = document.getElementById("holoTag");

    function isValidISODate(s){
      return /^\d{4}-\d{2}-\d{2}$/.test(s);
    }

    /************************************************************
     * Setup UI hydration
     ************************************************************/
    function hydrateSetupUI(){
      blueAnchorEl.value = state.blueAnchor || "";
      officeHoursModeEl.value = state.officeHoursMode || "none";
      for (const k of Object.keys(blockEls)){
        blockEls[k].value = state.blocks[k] || "";
      }
    }
    hydrateSetupUI();

    // date pickers default
    const todayISO = isoDate(new Date());
    if (!isValidISODate(state.viewDate)) state.viewDate = todayISO;
    viewDateEl.value = state.viewDate;
    viewDateRightEl.value = state.viewDate;

    function setViewDate(val){
      if (!isValidISODate(val)) return;
      state.viewDate = val;
      saveState();
      viewDateEl.value = val;
      viewDateRightEl.value = val;
      renderScheduleViews();
    }

    viewDateEl.addEventListener("change", (e)=> setViewDate(e.target.value));
    viewDateRightEl.addEventListener("change", (e)=> setViewDate(e.target.value));

    saveScheduleBtn.addEventListener("click", () => {
      state.blueAnchor = (blueAnchorEl.value || "").trim();
      state.officeHoursMode = officeHoursModeEl.value;
      for (const k of Object.keys(blockEls)){
        state.blocks[k] = (blockEls[k].value || "").trim();
      }
      saveState();
      renderScheduleViews();
      flashPill("Saved");
    });

    let setupCollapsed = true; // collapsed by default
    toggleSetupBtn.addEventListener("click", () => {
      setupCollapsed = !setupCollapsed;
      setupBody.style.display = setupCollapsed ? "none" : "";
      toggleSetupBtn.textContent = setupCollapsed ? "Expand" : "Collapse";
    });

    function flashPill(msg){
      const old = dayModePill.textContent;
      dayModePill.textContent = msg;
      setTimeout(()=> dayModePill.textContent = old, 900);
    }

    /************************************************************
     * Blue/Gold auto mode (anchor-date based)
     ************************************************************/
    function getWeekModeForDate(date){
      const forced = weekModeEl.value;
      if (forced === "blue" || forced === "gold") return forced;

      if (!isValidISODate(state.blueAnchor)) return null;
      const anchor = new Date(state.blueAnchor + "T00:00:00");
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      const toMonday = (x) => {
        const dd = new Date(x.getFullYear(), x.getMonth(), x.getDate());
        const dow = dd.getDay();
        const diff = (dow + 6) % 7;
        dd.setDate(dd.getDate() - diff);
        return dd;
      };

      const aMon = toMonday(anchor);
      const dMon = toMonday(d);

      const weeksDiff = Math.round((dMon - aMon) / (7*24*60*60*1000));
      return (weeksDiff % 2 === 0) ? "blue" : "gold";
    }

    function dayKeyFromDate(d){
      return dayKeys[d.getDay()];
    }

    function blockLabel(block, weekForDate){
      const lunchish = [
        "MS/US Lunch +MS/US Clubs",
        "MS/US SuperLunch +Affinity Groups",
        "H/X1",
        "X3",
        "Educators’ Mtg.",
        "Reading Period",
        "Bulletin"
      ];
      if (lunchish.includes(block)) return block;

      if (block === "H"){
        const mode = state.officeHoursMode || "none";
        if ((mode === "both") ||
            (mode === "blue" && weekForDate === "blue") ||
            (mode === "gold" && weekForDate === "gold")){
          return "Office Hours";
        }
      }

      return state.blocks[block] ? `${state.blocks[block]} (${block})` : block;
    }

    function buildPeriodsForDate(dateObj){
      const dk = dayKeyFromDate(dateObj);
      if (dk === "sunday" || dk === "saturday") return { periods: [], week:null, day:dk };

      const week = getWeekModeForDate(dateObj);
      if (!week) return { periods: [], week:null, day:dk };

      const src = scheduleByWeek[week]?.[dk] || [];
      const periods = src.map(p => {
        const range = parseRange(p.time);
        return { ...p, label: blockLabel(p.block, week), range };
      }).filter(p => p.range);

      return { periods, week, day:dk };
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /************************************************************
     * Render schedule views (right module + center holo + day pill + energy)
     ************************************************************/
    function renderScheduleViews(){
      const view = new Date(state.viewDate + "T00:00:00");
      const now = new Date();
      const isToday = isoDate(now) === state.viewDate;

      const { periods, week, day } = buildPeriodsForDate(view);
      const dayName = day.charAt(0).toUpperCase() + day.slice(1);
      const weekName = week ? week.toUpperCase() : "—";

      if (!week && (day === "saturday" || day === "sunday")){
        dayModePill.textContent = `Weekend • ${dayName}`;
      } else if (!week){
        dayModePill.textContent = `Auto needs anchor date`;
      } else {
        dayModePill.textContent = `${weekName} • ${dayName}`;
      }

      // Hint
      todayHintEl.textContent = (weekModeEl.value === "auto")
        ? (isValidISODate(state.blueAnchor)
            ? `Auto week mode anchored to Blue Monday: ${state.blueAnchor}.`
            : `Auto mode needs a “Blue anchor date” (a Monday you know is Blue).`)
        : `Week mode forced to ${weekModeEl.value.toUpperCase()}.`;

      // Right schedule list
      todayScheduleEl.innerHTML = "";

      if (!periods.length){
        const row = document.createElement("div");
        row.className = "period";
        row.innerHTML = `
          <div class="l">
            <b>${(day === "saturday" || day === "sunday") ? "Weekend" : "Schedule not ready"}</b>
            <span>${(day === "saturday" || day === "sunday") ? "No school blocks today." : "Set a Blue anchor date + save your blocks in Schedule Setup."}</span>
          </div>
          <div class="r">—</div>
        `;
        todayScheduleEl.appendChild(row);

        // Center holo
        holoTag.textContent = `Daily Schedule • ${state.viewDate}`;
        holoStatus.textContent = (day === "saturday" || day === "sunday") ? "Weekend" : "Not configured";
        holoList.innerHTML = `<div class="line"><div class="dot"></div><div>Enter your schedule on the right.</div></div>`;

        // Energy (only meaningful for today)
        energyFill.style.width = "0%";
        energyPct.textContent = "0%";
        energyNote.textContent = (day === "saturday" || day === "sunday") ? "Standby" : "Awaiting schedule…";

        // Countdown
        updateCountdown(null, false);
        return;
      }

      // determine "now" period only if viewing today
      const minutesNow = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
      let active = null;

      periods.forEach(p => {
        const isNow = isToday && (minutesNow >= p.range.start && minutesNow < p.range.end);
        if (isNow) active = p;

        const el = document.createElement("div");
        el.className = "period" + (isNow ? " now" : "");
        el.innerHTML = `
          <div class="l">
            <b>${escapeHtml(p.label)}</b>
            <span>${escapeHtml(p.block)}</span>
          </div>
          <div class="r">${escapeHtml(p.time)}</div>
        `;
        todayScheduleEl.appendChild(el);
      });

      // Center holo schedule (compact)
      holoTag.textContent = `Daily Schedule • ${state.viewDate}`;
      holoStatus.textContent = week ? `${weekName} • ${dayName}` : dayName;
      holoList.innerHTML = "";

      periods.slice(0, 8).forEach(p => {
        const isNow = isToday && (minutesNow >= p.range.start && minutesNow < p.range.end);
        const line = document.createElement("div");
        line.className = "line" + (isNow ? " now" : "");
        line.innerHTML = `<div class="dot"></div><div style="overflow:hidden;text-overflow:ellipsis;">${escapeHtml(p.time)} • ${escapeHtml(p.label)}</div>`;
        holoList.appendChild(line);
      });

      // Energy (only for today; otherwise show neutral)
      if (!isToday){
        energyFill.style.width = "0%";
        energyPct.textContent = "—";
        energyNote.textContent = "Energy grid is live only for today";
      } else {
        let lastEnd = Math.max(...periods.map(p => p.range.end));
        let firstStart = Math.min(...periods.map(p => p.range.start));
        const clamped = Math.min(Math.max(minutesNow, firstStart), lastEnd);
        const prog = (clamped - firstStart) / (lastEnd - firstStart);
        const pct = Math.round(prog * 100);

        energyFill.style.width = `${pct}%`;
        energyPct.textContent = `${pct}%`;

        if (minutesNow < firstStart) energyNote.textContent = "Pre-start";
        else if (minutesNow >= lastEnd) energyNote.textContent = "Complete";
        else if (active) energyNote.textContent = `Now: ${active.block}`;
        else energyNote.textContent = "In transit";
      }

      // Countdown
      if (!isToday){
        updateCountdown("—", false);
      } else {
        const next = findNextClass(periods, minutesNow);
        if (!next){
          updateCountdown("No more classes", false);
        } else {
          const deltaSec = Math.max(0, Math.round((next.range.start - minutesNow) * 60));
          const warn = deltaSec > 0 && deltaSec <= 600; // <= 10 minutes
          updateCountdown(formatCountdown(deltaSec), warn);
        }
      }
    }

    function isClassBlock(block){
      return ["A","B","C","D","E","F","G","H"].includes(block);
    }

    function findNextClass(periods, minutesNow){
      // next *class* start after now
      const classes = periods.filter(p => isClassBlock(p.block));
      // find smallest start > now
      let best = null;
      for (const p of classes){
        if (p.range.start > minutesNow){
          if (!best || p.range.start < best.range.start) best = p;
        }
      }
      // If before school starts, best will be first class. If during a class, still gives the next class.
      return best;
    }

    function formatCountdown(totalSec){
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${m}:${pad2(s)}`;
    }

    function updateCountdown(textOrNull, warn){
      if (textOrNull === null){
        countdownText.textContent = "—";
        countdownBox.classList.remove("warn");
        return;
      }
      countdownText.textContent = textOrNull;
      if (warn) countdownBox.classList.add("warn");
      else countdownBox.classList.remove("warn");
    }

    weekModeEl.addEventListener("change", () => renderScheduleViews());

    // live updates
    setInterval(renderScheduleViews, 800);
    renderScheduleViews();

    /************************************************************
     * EXPORT / IMPORT JSON
     ************************************************************/
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalHint = document.getElementById("modalHint");
    const jsonBox = document.getElementById("jsonBox");
    const closeModal = document.getElementById("closeModal");
    const copyJsonBtn = document.getElementById("copyJsonBtn");
    const applyJsonBtn = document.getElementById("applyJsonBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");

    function openModal(mode){
      overlay.style.display = "flex";
      if (mode === "export"){
        modalTitle.textContent = "Export";
        modalHint.textContent = "Copy this JSON to move your schedule setup to another computer.";
        jsonBox.value = JSON.stringify(state, null, 2);
        applyJsonBtn.style.display = "none";
        jsonBox.readOnly = true;
      } else {
        modalTitle.textContent = "Import";
        modalHint.textContent = "Paste JSON exported from this dashboard and click Apply.";
        jsonBox.value = "";
        applyJsonBtn.style.display = "";
        jsonBox.readOnly = false;
      }
    }
    function closeModalFn(){ overlay.style.display = "none"; }

    exportBtn.addEventListener("click", () => openModal("export"));
    importBtn.addEventListener("click", () => openModal("import"));
    closeModal.addEventListener("click", closeModalFn);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModalFn(); });

    copyJsonBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(jsonBox.value);
        flashPill("Copied");
      }catch(e){
        jsonBox.select();
        document.execCommand("copy");
        flashPill("Copied");
      }
    });

    applyJsonBtn.addEventListener("click", () => {
      try{
        const obj = JSON.parse(jsonBox.value);
        if (typeof obj !== "object" || !obj) throw new Error("Invalid JSON");
        state = {
          ...structuredClone(defaultState),
          ...obj,
          blocks: { ...structuredClone(defaultState.blocks), ...(obj.blocks||{}) },
        };
        if (!isValidISODate(state.viewDate)) state.viewDate = isoDate(new Date());
        saveState();
        hydrateSetupUI();
        setViewDate(state.viewDate);
        renderScheduleViews();
        closeModalFn();
        flashPill("Imported");
      }catch(e){
        alert("Import failed. Make sure you pasted valid JSON exported from this dashboard.");
      }
    });

    /************************************************************
     * Small UX touches
     ************************************************************/
    // focus Google search with /
    window.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement !== document.getElementById("googleQ")){
        e.preventDefault();
        document.getElementById("googleQ").focus();
      }
    });

    // stable ring layout on resize
    window.addEventListener("resize", () => layoutNodes());
  </script>
</body>
</html>
