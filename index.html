<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geffen Cockpit Dashboard</title>
  <style>
    :root{
      /* Futuristic blue + metallic (FF7-ish mako + steel) */
      --bg0:#070B1A;
      --bg1:#0B1230;
      --panel:#0C1638;
      --panel2:#0A1230;

      --ink:#EAF0FF;
      --muted:#B7C2E6;

      --electric:#2D7DFF;
      --electric2:#1E5BFF;
      --cyan:#7BE7FF;

      --mako:#4BFFD3;
      --brass:#D7B56D;
      --brass2:#8A6B2F;
      --steel:#9AA7C1;
      --steel2:#6D7A96;

      --gold:#FFE066;
      --red:#FF5A5A;

      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.18);

      --radius: 18px;
      --radius2: 26px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --serif: ui-serif, Georgia, "Times New Roman", serif;

      /* Ring sizing (circular nodes) */
      --ringSize: 720px;
      --nodeW: 132px;
      --nodeH: 132px;
      --ringPad: 40px;

      /* SMALLER center holo */
      --holoInset: 210px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(45,125,255,.16), transparent 55%),
        radial-gradient(1100px 620px at 80% 18%, rgba(123,231,255,.10), transparent 60%),
        radial-gradient(900px 520px at 60% 95%, rgba(215,181,109,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ===== Matrix/electric cascade background ===== */
    #matrixBg{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(.15px);
    }
    .scanlines, .fog{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
    }
    .scanlines{
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity:.14;
      mix-blend-mode: overlay;
    }
    .fog{
      background:
        radial-gradient(1000px 600px at 25% 60%, rgba(123,231,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 45%, rgba(45,125,255,.08), transparent 60%),
        radial-gradient(720px 420px at 52% 86%, rgba(75,255,211,.06), transparent 65%),
        radial-gradient(700px 420px at 40% 92%, rgba(215,181,109,.06), transparent 70%);
      filter: blur(12px);
      opacity:.55;
      animation: fogMove 16s ease-in-out infinite alternate;
    }
    @keyframes fogMove{
      from{ transform: translate3d(-10px, 0, 0) scale(1.02); }
      to{ transform: translate3d(14px, -9px, 0) scale(1.03); }
    }

    /* ===== Lightning overlay canvas ===== */
    #fxLightning{
      position:fixed;
      inset:0;
      z-index:10;
      pointer-events:none;
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:6;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,11,26,.80), rgba(7,11,26,.42));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .topbarInner{
      max-width: 1320px;
      margin:0 auto;
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      position:relative;
      z-index:2;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .brand .title{
      font-family: var(--serif);
      letter-spacing:.7px;
      font-weight: 900;
      font-size: 18px;
      line-height:1.1;
      color: var(--ink);
      text-shadow: 0 0 18px rgba(45,125,255,.25);
    }
    .brand .subtitle{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
    }

    .clockBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-family: var(--mono);
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.75));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      min-width: 300px;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .clockBox::before{
      content:"";
      position:absolute;
      inset: -2px;
      background:
        radial-gradient(220px 70px at 20% 25%, rgba(215,181,109,.10), transparent 70%),
        radial-gradient(240px 90px at 75% 65%, rgba(75,255,211,.07), transparent 70%);
      pointer-events:none;
      opacity:.9;
    }
    .clockTop{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:center;
      position:relative;
      z-index:2;
    }
    .clockBox .date{ color: rgba(234,240,255,.75); font-size: 12px; }
    .clockBox .time{ color: var(--ink); font-size: 15px; font-weight: 900; }
    .clockBox .ticks{ color: rgba(123,231,255,.85); font-size: 12px; }

    @keyframes warnPulse{
      0%, 100% { box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 10px 22px rgba(0,0,0,.35); }
      50% { box-shadow: 0 0 0 1px rgba(123,231,255,.22) inset, 0 0 18px rgba(45,125,255,.32), 0 10px 22px rgba(0,0,0,.35); }
    }
    .countdown{
      display:flex;
      justify-content:center;
      gap:8px;
      font-size: 11px;
      color: rgba(234,240,255,.74);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .countdown b{ color: rgba(234,240,255,.92); }
    .countdown.warn{
      border-color: rgba(123,231,255,.22);
      animation: warnPulse 1.6s ease-in-out infinite;
    }

    .searchWrap{
      flex: 1;
      min-width: 280px;
      max-width: 580px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .searchWrap::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(300px 80px at 25% 10%, rgba(215,181,109,.09), transparent 70%),
        radial-gradient(260px 90px at 70% 90%, rgba(75,255,211,.06), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }
    .searchWrap .lens{
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(123,231,255,.75);
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
      z-index:2;
    }
    .searchWrap .lens:after{
      content:"";
      position:absolute;
      width: 10px; height: 2px;
      background: rgba(123,231,255,.75);
      right:-8px; bottom:-3px;
      transform: rotate(45deg);
      border-radius: 3px;
    }
    .searchWrap input{
      flex:1;
      background: transparent;
      border: none;
      outline:none;
      color: var(--ink);
      font-family: var(--mono);
      font-size: 13px;
      position:relative;
      z-index:2;
    }
    .searchWrap button{
      border:none;
      cursor:pointer;
      color: #07101f;
      font-weight: 900;
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset, 0 10px 22px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .18s ease;
      flex: 0 0 auto;
      position:relative;
      z-index:2;
    }
    .searchWrap button:hover{ filter: brightness(1.05); }
    .searchWrap button:active{ transform: translateY(1px); }

    /* Main layout */
    .shell{
      position:relative;
      z-index:3;
      max-width: 1320px;
      margin: 18px auto 40px auto;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1040px){
      .shell{ grid-template-columns: 1fr; }
      :root{ --ringSize: 640px; --holoInset: 190px; --nodeW:124px; --nodeH:124px; }
    }
    @media (max-width: 680px){
      :root{ --ringSize: 580px; --holoInset: 175px; --nodeW:116px; --nodeH:116px; }
    }

    /* Left: ring bay */
    .bay{
      position:relative;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.76), rgba(10,18,48,.62));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow: visible;
      min-height: calc(var(--ringSize) + 120px);
    }
    .bay::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: var(--radius2);
      background:
        radial-gradient(920px 420px at 25% 30%, rgba(45,125,255,.20), transparent 60%),
        radial-gradient(720px 360px at 70% 60%, rgba(123,231,255,.14), transparent 55%),
        radial-gradient(520px 320px at 50% 90%, rgba(215,181,109,.10), transparent 60%);
      filter: blur(10px);
      opacity:.95;
      pointer-events:none;
      z-index:0;
    }
    .bay .trim{
      position:absolute;
      inset:10px;
      border-radius: calc(var(--radius2) - 6px);
      border: 1px solid rgba(215,181,109,.20);
      box-shadow: 0 0 0 1px rgba(0,0,0,.22) inset;
      pointer-events:none;
      z-index:1;
      opacity:.85;
    }

    .bayHeader{
      position:relative;
      z-index:4;
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      border-radius: var(--radius2);
    }
    .bayHeader .h1{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .bayHeader .h1 b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .bayHeader .h1 span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .bayHeader .datePick{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.70);
    }
    .bayHeader .datePickRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .bayHeader input[type="date"]{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.25);
      color: var(--ink);
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
    }
    .bayHeader input[type="date"]:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }

    .ringStage{
      position:relative;
      z-index:2;
      height: calc(var(--ringSize) + 16px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--ringPad) + 10px) var(--ringPad) 18px var(--ringPad);
      user-select:none;
    }

    .ring{
      width: var(--ringSize);
      height: var(--ringSize);
      border-radius: 50%;
      position:relative;
      transform: translateZ(0);
      outline:none;
    }

    /* Track / ring face */
    .ring:before{
      content:"";
      position:absolute;
      inset: 22px;
      border-radius:50%;
      border: 1px solid rgba(123,231,255,.22);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.16) inset,
        0 0 26px rgba(45,125,255,.14),
        0 0 80px rgba(45,125,255,.08);
      background:
        radial-gradient(circle at 50% 50%, rgba(12,22,56,.40), rgba(7,11,26,.55));
      z-index:0;
    }
    .ring:after{
      content:"";
      position:absolute;
      inset: 64px;
      border-radius:50%;
      border: 1px dashed rgba(215,181,109,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }

    /* Smaller center holo, and visually “quieter” */
    .holo{
      position:absolute;
      inset: var(--holoInset);
      border-radius: 22px;
      background:
        linear-gradient(180deg, rgba(12,22,56,.30), rgba(10,18,48,.14));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 0 1px rgba(45,125,255,.08) inset;
      backdrop-filter: blur(8px);
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 10px 10px 10px 10px;
      pointer-events:auto; /* allow clicks on schedule links */
      z-index:2;
      opacity:.92;
    }
    .holo .holoTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .holo .tag{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.82);
    }
    .holo .sub{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(234,240,255,.60);
      white-space:nowrap;
    }

    /* schedule block list wrapper so we can place the time marker */
    .holoListWrap{
      position:relative;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .holoList{
      display:grid;
      gap: 8px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.82);
      max-height: 250px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(123,231,255,.35) rgba(0,0,0,.0);
    }
    .holoList::-webkit-scrollbar{ width: 10px; }
    .holoList::-webkit-scrollbar-thumb{
      background: rgba(123,231,255,.24);
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,.0);
      background-clip: padding-box;
    }
    .holoList::-webkit-scrollbar-track{ background: transparent; }

    .periodCard{
      position:relative;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding: 9px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      box-shadow: 0 0 0 1px rgba(45,125,255,.06) inset;
    }
    .periodCard .t{
      flex: 0 0 auto;
      min-width: 78px;
      color: rgba(234,240,255,.72);
      font-size: 10px;
      letter-spacing:.03em;
      margin-top: 1px;
    }
    .periodCard .lbl{
      flex:1;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .periodCard.misc{
      opacity:.78;
      border-color: rgba(255,255,255,.08);
    }
    .periodCard.named{
      border-color: rgba(123,231,255,.22);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.10) inset,
        0 0 18px rgba(45,125,255,.10);
      background:
        radial-gradient(220px 70px at 25% 0%, rgba(45,125,255,.12), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .periodCard.now{
      border-color: rgba(215,181,109,.25);
      box-shadow:
        0 0 0 1px rgba(215,181,109,.14) inset,
        0 0 22px rgba(215,181,109,.10);
    }
    .periodCard a.periodLink{
      color: rgba(234,240,255,.92);
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .periodCard a.periodLink:hover{
      text-decoration: underline;
      text-decoration-color: rgba(123,231,255,.55);
      text-underline-offset: 3px;
    }
    .linkBadge{
      flex: 0 0 auto;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.22);
      color: rgba(123,231,255,.92);
      background: rgba(45,125,255,.10);
      white-space:nowrap;
    }


    /* orbit nodes */
    .node{
      position:absolute;
      width: var(--nodeW);
      height: var(--nodeH);
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      will-change: transform;
      cursor:pointer;
      z-index:5;
    }

    /* Circular rotating cards */
    .cardLink{
      width: 100%;
      height: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 12px 10px;
      border-radius: 50%;
      text-decoration:none;
      color: var(--ink);
      background:
        radial-gradient(90px 70px at 35% 25%, rgba(123,231,255,.18), transparent 70%),
        radial-gradient(90px 70px at 70% 75%, rgba(215,181,109,.10), transparent 75%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)),
        linear-gradient(180deg, rgba(12,22,56,.82), rgba(10,18,48,.72));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.10) inset,
        0 16px 28px rgba(0,0,0,.42);
      transition: transform .12s ease, border-color .18s ease, filter .18s ease;
      position:relative;
      overflow:hidden;
      pointer-events:auto;
    }
    .cardLink::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: 50%;
      background:
        radial-gradient(22px 12px at 22% 30%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.18) 66%, rgba(123,231,255,0) 80%),
        radial-gradient(22px 12px at 78% 62%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.14) 66%, rgba(45,125,255,0) 80%);
      opacity:.0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .cardLink:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(123,231,255,.30);
      filter: brightness(1.06);
    }
    .cardLink:hover::after{ opacity:.9; }
    .cardLink:active{
      transform: translateY(-1px) scale(1.005);
    }
    .cardTitle{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      text-align:center;
      line-height:1.15;
      padding: 0 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .cardSub{
      font-family: var(--mono);
      font-size: 9px;
      color: rgba(234,240,255,.70);
      text-align:center;
      padding: 0 8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .glyph{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        linear-gradient(180deg, rgba(215,181,109,.92), rgba(138,107,47,.74));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 10px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#120f07;
      font-weight: 900;
      font-family: var(--mono);
      flex: 0 0 auto;
    }

    /* energy bar */
    .energyWrap{
      position:relative;
      z-index:4;
      padding: 0 14px 14px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .energyBar{
      width: min(760px, 92%);
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.18) inset;
      position:relative;
      overflow:hidden;
    }
.energyFill{
  height: 100%;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(123,231,255,.95), rgba(45,125,255,.92), rgba(75,255,211,.62));
  box-shadow: 0 0 22px rgba(45,125,255,.24);
  transition: width 1.2s ease;
  position:relative;
  overflow:hidden;

  /* JS will set this each update so speed is constant */
  --pulseDur: 3s;
}
/* subtle electric micro-arc brightness pulse */
.energyFill{
  animation: energyJitter 2.2s steps(2,end) infinite;
}

@keyframes energyJitter{
  0%,100% { filter: brightness(1); }
  50% { filter: brightness(1.06); }
}

/* A subtle “electric sweep” that travels across ONLY the filled area */
/* Electric sweep + crackle texture */
.energyFill::after{
  content:"";
  position:absolute;
  inset: 0;

  /* Layer 1: sweeping bright band */
  background:
    linear-gradient(90deg,
      rgba(45,125,255,0) 0%,
      rgba(45,125,255,.18) 34%,
      rgba(123,231,255,.55) 50%,
      rgba(45,125,255,.18) 66%,
      rgba(45,125,255,0) 100%
    );

  transform: translateX(-120%);
  animation: energySweep var(--pulseDur) linear infinite;
  mix-blend-mode: screen;
  opacity: .70;
  filter: blur(.25px);
  pointer-events:none;
}

/* Layer 2: crackle overlay inside the fill */
.energyFill::before{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;

  /* A noisy “lightning filament” feel using repeating gradients */
  background:
    repeating-linear-gradient(
      115deg,
      rgba(123,231,255,.00) 0px,
      rgba(123,231,255,.00) 6px,
      rgba(123,231,255,.22) 7px,
      rgba(123,231,255,.00) 10px
    ),
    repeating-linear-gradient(
      65deg,
      rgba(45,125,255,.00) 0px,
      rgba(45,125,255,.00) 10px,
      rgba(45,125,255,.18) 11px,
      rgba(45,125,255,.00) 16px
    ),
    radial-gradient(120px 40px at 20% 50%, rgba(75,255,211,.12), transparent 70%),
    radial-gradient(140px 50px at 80% 55%, rgba(123,231,255,.10), transparent 72%);

  mix-blend-mode: screen;
  opacity: .35;
  filter: blur(.35px);

  /* subtle flicker */
  animation: energyFlicker 1.25s steps(2,end) infinite;
}

/* Edge “ionization” glow along the top/bottom of the filled bar */
.energyFill{
  position:relative;
}
.energyFill{
  box-shadow:
    0 0 22px rgba(45,125,255,.24),
    0 0 0 1px rgba(123,231,255,.10) inset;
}
.energyFill{
  background:
    linear-gradient(90deg, rgba(123,231,255,.95), rgba(45,125,255,.92), rgba(75,255,211,.62));
}
.energyFill{
  /* faint top/bottom glow lines */
  background-image:
    linear-gradient(90deg, rgba(123,231,255,.95), rgba(45,125,255,.92), rgba(75,255,211,.62)),
    linear-gradient(180deg, rgba(123,231,255,.22), rgba(123,231,255,0)),
    linear-gradient(0deg, rgba(45,125,255,.18), rgba(45,125,255,0));
  background-blend-mode: normal, screen, screen;
}

@keyframes energySweep{
  from { transform: translateX(-120%); }
  to   { transform: translateX(120%); }
}

@keyframes energyFlicker{
  0%   { opacity: .26; filter: blur(.35px); }
  25%  { opacity: .40; filter: blur(.25px); }
  55%  { opacity: .30; filter: blur(.40px); }
  100% { opacity: .38; filter: blur(.22px); }
}    /* Right cockpit panel */
    .cockpit{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.82), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cockpit::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(620px 360px at 30% 10%, rgba(123,231,255,.14), transparent 60%),
        radial-gradient(520px 260px at 70% 80%, rgba(215,181,109,.08), transparent 65%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }

    .cockHeader{
      position:relative;
      z-index:2;
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
    }
    .cockHeader .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .cockHeader .left b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .cockHeader .left span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .pill{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 10px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .pill .spark{
      width: 8px; height: 8px; border-radius:50%;
      background: rgba(123,231,255,.95);
      box-shadow: 0 0 12px rgba(123,231,255,.35);
    }

    .cockBody{
      position:relative;
      z-index:2;
      padding: 14px;
      display:grid;
      gap: 12px;
    }

    .module{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(45,125,255,.08) inset, 0 12px 26px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
    }
    .module::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(280px 80px at 20% 10%, rgba(215,181,109,.08), transparent 70%),
        radial-gradient(240px 70px at 85% 85%, rgba(75,255,211,.05), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }

    .moduleHd{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      position:relative;
      z-index:2;
    }
    .moduleHd b{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.88);
    }
    .moduleHd .mini{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 900;
      padding: 9px 10px;
      border-radius: 14px;
      transition: transform .08s ease, filter .18s ease, background .18s ease;
      user-select:none;
      white-space:nowrap;
      position:relative;
      z-index:2;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      color:#07101f;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 12px 22px rgba(0,0,0,.34);
    }
    .btnGhost{
      color: rgba(234,240,255,.88);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.16) inset;
    }
    .btnDanger{
      color: rgba(255,90,90,.95);
      background: rgba(255,90,90,.08);
      border: 1px solid rgba(255,90,90,.22);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
    }
    .btnGhost:hover,.btnPrimary:hover{ filter: brightness(1.05); }

    .moduleBd{
      padding: 12px;
      display:grid;
      gap: 10px;
      position:relative;
      z-index:2;
    }

    label{
      display:block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: rgba(234,240,255,.70);
      margin: 0 0 6px 0;
    }
    input[type="text"], select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.35);
      color: var(--ink);
      padding: 10px 10px;
      outline:none;
      font-family: var(--mono);
      font-size: 13px;
      transition: box-shadow .15s ease, border-color .15s ease;
      position:relative;
      z-index:2;
    }
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }
    textarea{ min-height: 120px; resize: vertical; }

    /* Checklist */
    .checkTop{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .checkTop input{ flex:1; }

    .checkMetaRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top: 2px;
    }
    .checkMetaRow .left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .checkMetaRow .right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .checkFilter{
      width: 220px;
      max-width: 100%;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.28);
      color: var(--ink);
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
    }
    .checkFilter:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.14);
    }

    .checkList{
      display:grid;
      gap: 8px;
      margin-top: 2px;
    }
    .checkItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,240,255,.86);
      position:relative;
    }
    .checkItem input[type="checkbox"]{
      width: 18px; height: 18px;
      margin-top: 2px;
      accent-color: var(--cyan);
      flex: 0 0 auto;
    }
    .checkItem .txt{
      flex:1;
      line-height:1.25;
      word-break: break-word;
      min-width: 0;
      cursor: text;
    }
    .checkItem.done{
      opacity:.68;
      border-color: rgba(255,255,255,.10);
    }
    .checkItem.done .txt{
      text-decoration: line-through;
      color: rgba(183,194,230,.76);
    }

    /* drag handle only */
    .dragHandle{
      width: 18px;
      height: 18px;
      margin-top: 1px;
      flex: 0 0 auto;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: grab;
      user-select:none;
      opacity:.85;
    }
    .dragHandle:active{ cursor: grabbing; }
    .dragHandle::before{
      content:"⋮⋮";
      font-size: 12px;
      letter-spacing: -2px;
      color: rgba(234,240,255,.55);
      transform: translateY(-1px);
    }
    .checkItem.dragOver{
      border-color: rgba(123,231,255,.28);
      box-shadow: 0 0 0 1px rgba(45,125,255,.10) inset, 0 0 18px rgba(45,125,255,.12);
    }

    /* actions */
    .checkActions{
      display:flex;
      gap:6px;
      flex: 0 0 auto;
      align-items:center;
      margin-top: -2px;
    }
    .iconBtn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-weight: 900;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 10px;
      color: rgba(234,240,255,.86);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
      user-select:none;
    }
    .iconBtn:hover{ filter: brightness(1.06); }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn.danger{
      color: rgba(255,90,90,.95);
      background: rgba(255,90,90,.08);
      border-color: rgba(255,90,90,.22);
    }
    .iconBtn.priOn{
      color: rgba(255,224,102,.95);
      border-color: rgba(255,224,102,.22);
      background: rgba(255,183,0,.08);
    }

    /* tags + due chips */
    .chipRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(234,240,255,.78);
      white-space:nowrap;
    }
    .chip.tag{
      border-color: rgba(123,231,255,.18);
      background: rgba(45,125,255,.08);
      color: rgba(123,231,255,.90);
    }
    .chip.due{
      border-color: rgba(215,181,109,.18);
      background: rgba(215,181,109,.08);
      color: rgba(234,240,255,.85);
    }

    /* PRIORITY: subtle orange */
    .checkItem.priority{
      border-color: rgba(255,224,102,.22);
      box-shadow:
        0 0 0 1px rgba(255,183,0,.10) inset,
        0 0 18px rgba(255,183,0,.10);
      background:
        radial-gradient(260px 80px at 15% 0%, rgba(255,183,0,.10), transparent 65%),
        rgba(255,255,255,.04);
    }

    /* OVERDUE: subtle red glow */
    @keyframes overdueGlow{
      0%,100%{ box-shadow: 0 0 0 1px rgba(255,90,90,.12) inset, 0 0 10px rgba(255,90,90,.10); }
      50%{ box-shadow: 0 0 0 1px rgba(255,90,90,.18) inset, 0 0 18px rgba(255,90,90,.16); }
    }
    .checkItem.overdue:not(.done){
      border-color: rgba(255,90,90,.22);
      animation: overdueGlow 1.9s ease-in-out infinite;
    }

    /* inline editor */
    .editInput{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.42);
      color: var(--ink);
      padding: 8px 10px;
      outline:none;
      font-family: var(--mono);
      font-size: 12px;
    }
    .editInput:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.16);
    }

    /* toast (undo) */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      z-index: 80;
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.86));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      border-radius: 16px;
      padding: 10px 12px;
      display:none;
      gap: 10px;
      align-items:center;
      max-width: min(920px, 92vw);
      font-family: var(--mono);
      color: rgba(234,240,255,.86);
    }
    .toast.on{ display:flex; }
    .toast .msg{
      font-size: 11px;
      color: rgba(234,240,255,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast .undoBtn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 900;
      padding: 7px 10px;
      border-radius: 999px;
      color:#07101f;
      background: linear-gradient(180deg, rgba(255,224,102,.95), rgba(215,181,109,.88));
      box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset;
      white-space:nowrap;
    }

    .tinyHint{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.62);
      line-height:1.25;
      position:relative;
      z-index:2;
    }

    /* Export / import drawer */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 18px;
    }
    .modal{
      width: min(860px, 96vw);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.88));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 24px 80px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHd{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHd b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(123,231,255,.90);
    }
    .modalBd{
      padding: 14px;
      display:grid;
      gap: 10px;
    }

    .footer{
      max-width: 1320px;
      margin: 0 auto;
      padding: 0 16px 26px 16px;
      color: rgba(183,194,230,.72);
      font-family: var(--mono);
      font-size: 11px;
      text-align:center;
      z-index:3;
      position:relative;
    }
  </style>
</head>

<body>
  <!-- Matrix/electric cascade background -->
  <canvas id="matrixBg" aria-hidden="true"></canvas>

  <!-- Atmospheric overlays -->
  <div class="fog" aria-hidden="true"></div>
  <div class="scanlines" aria-hidden="true"></div>

  <!-- Lightning canvas -->
  <canvas id="fxLightning" aria-hidden="true"></canvas>

  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="title">GEFFEN COCKPIT</div>
        <div class="subtitle">Retro-future dashboard • wheel to rotate the ring • “/” focuses search</div>
      </div>

      <form class="searchWrap" action="https://www.google.com/search" method="GET" target="_blank" rel="noopener">
        <div class="lens" aria-hidden="true"></div>
        <input id="googleQ" name="q" type="text" placeholder="Search Google…" autocomplete="off" />
        <button type="submit">SEARCH</button>
      </form>

      <div class="clockBox" aria-label="Clock">
        <div class="clockTop">
          <div class="date" id="dateStr">—</div>
          <div class="time" id="timeStr">—</div>
          <div class="ticks" id="ticksStr">.00</div>
        </div>
        <div class="countdown" id="countdownBox">
          <span>Time until next class:</span> <b id="countdownText">—</b>
        </div>
      </div>
    </div>
  </div>

  <main class="shell">
    <!-- LEFT: Ring bay -->
    <section class="bay" id="bay">
      <div class="trim" aria-hidden="true"></div>

      <div class="bayHeader">
        <div class="h1">
          <b>Navigation Ring</b>
          <span>Scroll your wheel over the ring to rotate. Click a node to launch.</span>
        </div>
        <div class="datePick" aria-label="Select date to view schedule">
          <div style="opacity:.85;">View date</div>
          <div class="datePickRow">
            <input type="date" id="viewDate" />
          </div>
        </div>
      </div>

      <div class="ringStage">
        <div class="ring" id="ring" aria-label="Link ring" tabindex="0">
          <!-- smaller center holo -->
          <div class="holo" id="holo">
            <div class="holoTop">
              <div class="tag" id="holoTag">Daily Schedule</div>
              <div class="sub" id="holoStatus">—</div>
            </div>

            <div class="holoListWrap">
              <div class="holoList" id="holoList" aria-label="Daily schedule">
                <div class="periodCard misc">
                  <div class="t">—</div>
                  <div class="lbl">Enter your schedule on the right.</div>
                </div>
              </div>
            </div>
          </div>
          <!-- nodes inserted by JS -->
        </div>
      </div>

      <div class="energyWrap">
        <div style="width:100%;display:flex;flex-direction:column;align-items:center;">
          <div class="energyBar" aria-label="Energy bar">
            <div class="energyFill" id="energyFill"></div>
          </div>
          <div class="energyMeta">
            <div><b>ENERGY GRID</b> <span id="energyPct">0%</span></div>
            <div id="energyNote">Awaiting schedule…</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cockpit (Checklist + schedule setup only) -->
    <aside class="cockpit" id="cockpit">
      <div class="cockHeader">
        <div class="left">
          <b>Control Console</b>
          <span>Checklist + schedule entry.</span>
        </div>
        <div class="pill"><span class="spark"></span><span id="dayModePill">—</span></div>
      </div>

      <div class="cockBody">
        <!-- CHECKLIST MODULE -->
        <div class="module">
          <div class="moduleHd">
            <div style="display:flex;gap:10px;align-items:center;">
              <b>Checklist</b>
              <span class="pill" style="padding:6px 10px;border-radius:999px;font-size:11px;">
                <span class="spark" style="width:7px;height:7px;"></span>
                <span id="checkProgress">0/0</span>
              </span>
            </div>
            <div class="mini">
              <button class="btn btnGhost" id="collapseDoneBtn" type="button">Hide Done</button>
              <button class="btn btnGhost" id="clearCheckedBtn" type="button">Clear</button>
              <button class="btn btnGhost" id="exportChecklistBtn" type="button">Export</button>
            </div>
          </div>
          <div class="moduleBd">
            <div class="checkTop">
              <input id="newItemText" type="text" placeholder="Add an agenda item… (use #tags, add @YYYY-MM-DD or @2:30 for due)" />
              <button class="btn btnPrimary" id="addItemBtn" type="button">Add Item</button>
            </div>

            <div class="checkMetaRow">
              <div class="left">
                <input class="checkFilter" id="checkFilter" type="text" placeholder="Filter… (text or #tag)" />
                <div class="tinyHint" id="filterHint" style="margin-top:2px;">Tip: double-click to edit. ★ marks priority (orange).</div>
              </div>
              <div class="right">
                <div class="tinyHint" id="dueHint" style="text-align:right;">Overdue items glow red (when due is set).</div>
              </div>
            </div>

            <div class="checkList" id="checkList"></div>
            <div class="tinyHint">Tip: press Enter to add. Drag using the handle. Export/import lives below.</div>
          </div>
        </div>

        <!-- Portability (schedule + checklist) -->
        <div class="module">
          <div class="moduleHd">
            <b>Portability</b>
            <div class="mini">
              <button class="btn btnGhost" id="exportBtn" type="button">Export</button>
              <button class="btn btnGhost" id="importBtn" type="button">Import</button>
            </div>
          </div>
          <div class="moduleBd">
            <div class="tinyHint">Export gives you JSON for schedule settings + checklist. Import restores it.</div>
          </div>
        </div>

        <!-- Schedule setup (collapsed by default) -->
        <div class="module" id="setupModule">
          <div class="moduleHd">
            <b>Schedule Setup</b>
            <div class="mini">
              <button class="btn btnGhost" id="toggleSetup" type="button">Expand</button>
              <button class="btn btnPrimary" id="saveScheduleBtn" type="button">Save</button>
            </div>
          </div>
          <div class="moduleBd" id="setupBody" style="display:none;">
            <div style="display:grid;gap:10px;">
              <div>
                <label>Blue anchor date</label>
                <input id="blueAnchor" type="text" placeholder="YYYY-MM-DD (a Monday you know is Blue)" />
                <div class="tinyHint">Used for Auto week mode when rendering the schedule in the center of the ring.</div>
              </div>
              <div>
                <label>Office hours on H block</label>
                <select id="officeHoursMode">
                  <option value="none">None</option>
                  <option value="blue">Blue week only</option>
                  <option value="gold">Gold week only</option>
                  <option value="both">Both weeks</option>
                </select>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>A block name</label><input id="A" type="text" placeholder="e.g., Global History 10" /></div>
                <div><label>B block name</label><input id="B" type="text" placeholder="e.g., Advanced ME History" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>C block name</label><input id="C" type="text" /></div>
                <div><label>D block name</label><input id="D" type="text" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>E block name</label><input id="E" type="text" /></div>
                <div><label>F block name</label><input id="F" type="text" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>G block name</label><input id="G" type="text" /></div>
                <div><label>H block name</label><input id="H" type="text" /></div>
              </div>

              <div class="tinyHint" style="margin-top:4px;">Optional: set per-block links (e.g., Google Drive folders). Named class periods become clickable.</div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>A block link</label><input id="linkA" type="text" placeholder="https://..." /></div>
                <div><label>B block link</label><input id="linkB" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>C block link</label><input id="linkC" type="text" placeholder="https://..." /></div>
                <div><label>D block link</label><input id="linkD" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>E block link</label><input id="linkE" type="text" placeholder="https://..." /></div>
                <div><label>F block link</label><input id="linkF" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>G block link</label><input id="linkG" type="text" placeholder="https://..." /></div>
                <div><label>H block link</label><input id="linkH" type="text" placeholder="https://..." /></div>
              </div>

              <div class="tinyHint">Once saved, the center holo shows the schedule for the selected date. The current period is highlighted automatically.</div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Export/Import Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Export/Import">
      <div class="modalHd">
        <b id="modalTitle">Export</b>
        <button class="btn btnGhost" id="closeModal" type="button">Close</button>
      </div>
      <div class="modalBd">
        <div class="tinyHint" id="modalHint">Copy this JSON to move your setup to another computer.</div>
        <textarea id="jsonBox" spellcheck="false"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnGhost" id="copyJsonBtn" type="button">Copy</button>
          <button class="btn btnPrimary" id="applyJsonBtn" type="button" style="display:none;">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Undo toast -->
  <div class="toast" id="toast">
    <div class="msg" id="toastMsg">—</div>
    <button class="undoBtn" id="toastUndo" type="button">UNDO</button>
  </div>

  <div class="footer">
    Wheel rotates the ring • Schedule + checklist saved in your browser (localStorage) • Export JSON for portability
  </div>

  <script>
    /************************************************************
     * LINKS (ring nodes)
     ************************************************************/
    const links = [
      { label:"Discussion", sub:"Tracker", href:"https://amhagler.github.io/class-discussion/", glyph:"DT" },
      { label:"Seating Chart", sub:"Grid", href:"https://amhagler.github.io/SC/", glyph:"SC" },
      { label:"Rubric", sub:"Generator", href:"https://amhagler.github.io/rubric/", glyph:"RB" },
      { label:"Unit Calendar", sub:"Generator", href:"https://amhagler.github.io/uc/", glyph:"UC" },
      { label:"Mafia", sub:"Game", href:"https://amhagler.github.io/mafia/", glyph:"MF" },
      { label:"Trivia", sub:"Game", href:"https://amhagler.github.io/tr/", glyph:"TR" },
      { label:"Portal", sub:"Login", href:"https://geffenacademy.myschoolapp.com/app#login", glyph:"PT" },
      { label:"Gradebook", sub:"Direct", href:"https://geffenacademy.myschoolapp.com/sis-gradebook/gradebook/27966135?svcid=edu&addin=1", glyph:"GB" },
    ];

    const ring = document.getElementById("ring");
    let rotation = 0; // radians
    let targetRotation = 0;

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildNodes(){
      ring.querySelectorAll(".node").forEach(n => n.remove());
      links.forEach((l, idx) => {
        const node = document.createElement("div");
        node.className = "node";
        node.dataset.idx = String(idx);
        node.innerHTML = `
          <a class="cardLink" href="${l.href}" target="_blank" rel="noopener" aria-label="${escapeHtml(l.label)}">
            <div class="glyph">${escapeHtml(l.glyph)}</div>
            <div class="cardTitle">${escapeHtml(l.label)}</div>
            <div class="cardSub">${escapeHtml(l.sub)}</div>
          </a>
        `;
        ring.appendChild(node);
      });
    }
    buildNodes();

    function computeOrbitRadius(){
      const cs = getComputedStyle(document.documentElement);
      const nodeW = parseFloat(cs.getPropertyValue("--nodeW")) || 132;
      const ringPad = parseFloat(cs.getPropertyValue("--ringPad")) || 40;
      const w = ring.clientWidth || 600;
      const half = w / 2;
      return Math.max(160, half - (nodeW / 2) - ringPad);
    }

    function layoutNodes(){
      const nodes = Array.from(ring.querySelectorAll(".node"));
      const r = computeOrbitRadius();
      const n = nodes.length;
      for (let i = 0; i < n; i++){
        const theta = (Math.PI * 2) * (i / n) + rotation;
        const x = Math.cos(theta) * r;
        const y = Math.sin(theta) * r;
        nodes[i].style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      }
    }

    ring.addEventListener("wheel", (e) => {
      e.preventDefault();
      targetRotation += (e.deltaY || 0) * 0.0022;
    }, { passive:false });

    function animateRing(){
      rotation += (targetRotation - rotation) * 0.10;
      layoutNodes();
      requestAnimationFrame(animateRing);
    }
    animateRing();

    /************************************************************
     * CLOCK (hundredths) + countdown to next class
     ************************************************************/
    const dateStr = document.getElementById("dateStr");
    const timeStr = document.getElementById("timeStr");
    const ticksStr = document.getElementById("ticksStr");
    const countdownBox = document.getElementById("countdownBox");
    const countdownText = document.getElementById("countdownText");

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      return `${y}-${m}-${da}`;
    }

    function tickClock(){
      const now = new Date();
      dateStr.textContent = isoDate(now);
      timeStr.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
      ticksStr.textContent = `.${pad2(Math.floor(now.getMilliseconds()/10))}`;
      requestAnimationFrame(tickClock);
    }
    tickClock();

    /************************************************************
     * SCHEDULE DATA (Blue/Gold)
     ************************************************************/
    const blueWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"F" },
        { time:"10:20-11:15", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"D" },
        { time:"10:15-11:10", block:"E" },
        { time:"11:20-12:15", block:"F" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"G" },
        { time:"2:10-3:05", block:"A" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"B" },
        { time:"10:15-11:10", block:"C" },
        { time:"11:20-12:15", block:"D" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"E" },
        { time:"2:10-3:05", block:"F" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"G" },
        { time:"10:00-10:55", block:"A" },
        { time:"11:05-12:00", block:"B" },
        { time:"12:00-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"C" },
        { time:"2:10-3:05", block:"D" },
        { time:"3:10-3:50", block:"H/X1" }
      ]
    };

    const goldWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"E" },
        { time:"10:15-11:10", block:"F" },
        { time:"11:20-12:15", block:"G" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"A" },
        { time:"2:10-3:05", block:"B" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"C" },
        { time:"10:20-11:15", block:"D" },
        { time:"11:20-12:15", block:"E" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"F" },
        { time:"2:10-3:05", block:"G" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"F" },
        { time:"10:15-11:10", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"Lunch" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"D" },
        { time:"10:00-10:55", block:"E" },
        { time:"11:00-11:45", block:"H" },
        { time:"11:45-12:35", block:"Lunch" },
        { time:"12:40-1:35", block:"F" },
        { time:"1:40-2:35", block:"G" },
        { time:"2:40-3:20", block:"X3" }
      ]
    };

    const scheduleByWeek = { blue: blueWeek, gold: goldWeek };
    const dayKeys = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];

    function parseTimeToMinutes(t){
      const [hh, mm] = t.split(":").map(Number);
      let h = hh;
      // treat 1–6 as PM (school schedule convention)
      if (h >= 1 && h <= 6) h += 12;
      return h * 60 + (mm||0);
    }
    function parseRange(range){
      const parts = range.split("-");
      if (parts.length !== 2) return null;
      return { start: parseTimeToMinutes(parts[0].trim()), end: parseTimeToMinutes(parts[1].trim()) };
    }

    /************************************************************
     * LOCAL STORAGE STATE (schedule + checklist + per-block links)
     ************************************************************/
    const LS_KEY = "geffen_cockpit_v4";

    const defaultState = {
      blueAnchor: "",
      officeHoursMode: "none",
      blocks: { A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"" },
      links:  { A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"" },
      viewDate: "",
      checklist: [], // {id, text, done, createdAt, completedAt, dueAt, priority, tags, order}
      checklistUI: { hideDone:false, filter:"" }
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return structuredClone(defaultState);
        const obj = JSON.parse(raw);

        const merged = {
          ...structuredClone(defaultState),
          ...obj,
          blocks: { ...structuredClone(defaultState.blocks), ...(obj.blocks||{}) },
          links:  { ...structuredClone(defaultState.links),  ...(obj.links||{}) },
          checklist: Array.isArray(obj.checklist) ? obj.checklist : [],
          checklistUI: { ...structuredClone(defaultState.checklistUI), ...(obj.checklistUI||{}) }
        };

        // backward-compat normalize checklist items
        merged.checklist = (merged.checklist || []).map((it, idx) => normalizeChecklistItem(it, idx));
        return merged;
      }catch(e){
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /************************************************************
     * UI refs
     ************************************************************/
    const dayModePill = document.getElementById("dayModePill");
    const viewDateEl = document.getElementById("viewDate");

    const holoList = document.getElementById("holoList");
    const holoStatus = document.getElementById("holoStatus");
    const holoTag = document.getElementById("holoTag");

    const energyFill = document.getElementById("energyFill");
    const energyPct = document.getElementById("energyPct");
    const energyNote = document.getElementById("energyNote");

    // checklist
    const newItemText = document.getElementById("newItemText");
    const addItemBtn = document.getElementById("addItemBtn");
    const clearCheckedBtn = document.getElementById("clearCheckedBtn");
    const exportChecklistBtn = document.getElementById("exportChecklistBtn");
    const checkListEl = document.getElementById("checkList");
    const checkFilterEl = document.getElementById("checkFilter");
    const collapseDoneBtn = document.getElementById("collapseDoneBtn");
    const checkProgressEl = document.getElementById("checkProgress");

    // toast
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastUndo = document.getElementById("toastUndo");

    // schedule setup
    const blueAnchorEl = document.getElementById("blueAnchor");
    const officeHoursModeEl = document.getElementById("officeHoursMode");
    const blockEls = ["A","B","C","D","E","F","G","H"].reduce((acc,k)=>{
      acc[k] = document.getElementById(k);
      return acc;
    }, {});
    const linkEls = ["A","B","C","D","E","F","G","H"].reduce((acc,k)=>{
      acc[k] = document.getElementById("link"+k);
      return acc;
    }, {});
    const saveScheduleBtn = document.getElementById("saveScheduleBtn");
    const toggleSetupBtn = document.getElementById("toggleSetup");
    const setupBody = document.getElementById("setupBody");

    // export/import
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalHint = document.getElementById("modalHint");
    const jsonBox = document.getElementById("jsonBox");
    const closeModal = document.getElementById("closeModal");
    const copyJsonBtn = document.getElementById("copyJsonBtn");
    const applyJsonBtn = document.getElementById("applyJsonBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");

    function isValidISODate(s){
      return /^\d{4}-\d{2}-\d{2}$/.test(s);
    }

    function hydrateSetupUI(){
      blueAnchorEl.value = state.blueAnchor || "";
      officeHoursModeEl.value = state.officeHoursMode || "none";
      for (const k of Object.keys(blockEls)){
        blockEls[k].value = state.blocks[k] || "";
      }
      for (const k of Object.keys(linkEls)){
        linkEls[k].value = state.links[k] || "";
      }
    }
    hydrateSetupUI();

    const todayISO = isoDate(new Date());
    if (!isValidISODate(state.viewDate)) state.viewDate = todayISO;
    viewDateEl.value = state.viewDate;

    function setViewDate(val){
      if (!isValidISODate(val)) return;
      state.viewDate = val;
      saveState();
      viewDateEl.value = val;
      renderCenterScheduleAndTimers();
    }
    viewDateEl.addEventListener("change", (e)=> setViewDate(e.target.value));

    saveScheduleBtn.addEventListener("click", () => {
      state.blueAnchor = (blueAnchorEl.value || "").trim();
      state.officeHoursMode = officeHoursModeEl.value;
      for (const k of Object.keys(blockEls)){
        state.blocks[k] = (blockEls[k].value || "").trim();
      }
      for (const k of Object.keys(linkEls)){
        state.links[k] = (linkEls[k].value || "").trim();
      }
      saveState();
      renderCenterScheduleAndTimers();
      flashPill("Saved");
    });

    let setupCollapsed = true;
    toggleSetupBtn.addEventListener("click", () => {
      setupCollapsed = !setupCollapsed;
      setupBody.style.display = setupCollapsed ? "none" : "";
      toggleSetupBtn.textContent = setupCollapsed ? "Expand" : "Collapse";
    });

    function flashPill(msg){
      const old = dayModePill.textContent;
      dayModePill.textContent = msg;
      setTimeout(()=> dayModePill.textContent = old, 900);
    }

    /************************************************************
     * Checklist Phase 1 (priority, overdue, edit, delete+undo, drag reorder, tags, filter, collapse done)
     ************************************************************/
    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function normalizeChecklistItem(it, idx){
      const now = Date.now();
      const base = (it && typeof it === "object") ? it : { text:String(it||"") };
      return {
        id: base.id || uid(),
        text: String(base.text || ""),
        done: !!base.done,
        createdAt: typeof base.createdAt === "number" ? base.createdAt : now,
        completedAt: typeof base.completedAt === "number" ? base.completedAt : (base.done ? now : null),
        dueAt: typeof base.dueAt === "number" ? base.dueAt : null,
        priority: !!base.priority,
        tags: Array.isArray(base.tags) ? base.tags : [],
        order: typeof base.order === "number" ? base.order : (idx || 0)
      };
    }

    // Parse #tags and due tokens from text.
    // Due formats:
    //   @YYYY-MM-DD
    //   @YYYY-MM-DD HH:MM
    //   @HH:MM  (assumes today)
    function parseTagsAndDue(rawText){
      let text = String(rawText || "").trim();

      // tags
      const tags = [];
      text = text.replace(/(^|\s)#([a-zA-Z0-9_\-]+)/g, (m, sp, tag) => {
        tags.push(tag.toLowerCase());
        return sp;
      }).trim();

      // due tokens
      let dueAt = null;

      // @YYYY-MM-DD HH:MM
      let m = text.match(/(^|\s)@(\d{4}-\d{2}-\d{2})\s+(\d{1,2}:\d{2})(?=\s|$)/);
      if (m){
        const d = m[2];
        const t = m[3];
        const dt = new Date(d + "T" + pad2(parseInt(t.split(":")[0],10)) + ":" + t.split(":")[1] + ":00");
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
        text = text.replace(m[0], m[1]).replace(/\s+/g," ").trim();
        return { text, tags: uniq(tags), dueAt };
      }

      // @YYYY-MM-DD
      m = text.match(/(^|\s)@(\d{4}-\d{2}-\d{2})(?=\s|$)/);
      if (m){
        const d = m[2];
        const dt = new Date(d + "T23:59:00");
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
        text = text.replace(m[0], m[1]).replace(/\s+/g," ").trim();
        return { text, tags: uniq(tags), dueAt };
      }

      // @HH:MM => today at that time
      m = text.match(/(^|\s)@(\d{1,2}:\d{2})(?=\s|$)/);
      if (m){
        const t = m[2];
        const now = new Date();
        const hh = parseInt(t.split(":")[0],10);
        const mm = parseInt(t.split(":")[1],10);
        const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
        text = text.replace(m[0], m[1]).replace(/\s+/g," ").trim();
      }

      return { text, tags: uniq(tags), dueAt };
    }

    function uniq(arr){
      return Array.from(new Set((arr||[]).filter(Boolean)));
    }

    function prettyDue(ts){
      if (!ts) return "";
      const d = new Date(ts);
      const now = new Date();
      const sameDay = isoDate(d) === isoDate(now);
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      if (sameDay) return `Due ${hh}:${mi}`;
      return `Due ${mm}/${dd} ${hh}:${mi}`;
    }

    // Undo snapshot
    let undoTimer = null;
    let undoSnapshot = null;
    function showUndo(message, snapshot){
      undoSnapshot = snapshot;
      toastMsg.textContent = message;
      toast.classList.add("on");
      if (undoTimer) clearTimeout(undoTimer);
      undoTimer = setTimeout(() => {
        toast.classList.remove("on");
        undoSnapshot = null;
        undoTimer = null;
      }, 10000);
    }

    toastUndo.addEventListener("click", () => {
      if (!undoSnapshot) return;
      state = undoSnapshot;
      saveState();
      hydrateSetupUI();
      viewDateEl.value = state.viewDate;
      renderChecklist();
      renderCenterScheduleAndTimers();
      toast.classList.remove("on");
      undoSnapshot = null;
      if (undoTimer) clearTimeout(undoTimer);
      undoTimer = null;
      flashPill("Undone");
    });

    function snapshotState(){
      // deep clone enough for our object
      return JSON.parse(JSON.stringify(state));
    }

    function sortChecklistStable(items){
      const arr = [...items];
      // priority first, then by order asc, then createdAt desc as tie-break
      arr.sort((a,b) => {
        const pa = a.priority ? 1 : 0;
        const pb = b.priority ? 1 : 0;
        if (pa !== pb) return pb - pa;
        const oa = (typeof a.order === "number") ? a.order : 0;
        const ob = (typeof b.order === "number") ? b.order : 0;
        if (oa !== ob) return oa - ob;
        const ca = (typeof a.createdAt === "number") ? a.createdAt : 0;
        const cb = (typeof b.createdAt === "number") ? b.createdAt : 0;
        return cb - ca;
      });
      return arr;
    }

    function matchesFilter(item, filter){
      const f = (filter||"").trim().toLowerCase();
      if (!f) return true;
      if (f.startsWith("#")){
        const want = f.slice(1);
        return (item.tags || []).includes(want);
      }
      // allow multiple terms
      const terms = f.split(/\s+/).filter(Boolean);
      const hay = (item.text || "").toLowerCase() + " " + (item.tags||[]).join(" ");
      return terms.every(t => hay.includes(t));
    }

    // Inline editor
    function startEdit(itemId){
      // If already editing, bail
      const row = checkListEl.querySelector(`.checkItem[data-id="${CSS.escape(itemId)}"]`);
      if (!row) return;
      if (row.dataset.editing === "1") return;

      const item = state.checklist.find(x => x.id === itemId);
      if (!item) return;

      row.dataset.editing = "1";
      const txtEl = row.querySelector(".txt");
      const chips = row.querySelector(".chipRow");
      if (!txtEl) return;

      const originalText = item.text;
      const originalDue = item.dueAt;

      const input = document.createElement("input");
      input.className = "editInput";
      // show due token in editor for convenience
      const dueToken = item.dueAt ? (" @" + isoDate(new Date(item.dueAt)) + " " + pad2(new Date(item.dueAt).getHours()) + ":" + pad2(new Date(item.dueAt).getMinutes())) : "";
      input.value = (originalText + dueToken + " " + (item.tags||[]).map(t => "#"+t).join(" ")).trim();
      txtEl.innerHTML = "";
      txtEl.appendChild(input);
      if (chips) chips.style.display = "none";

      const finish = (commit) => {
        row.dataset.editing = "0";
        if (!commit){
          // revert
          item.text = originalText;
          item.dueAt = originalDue;
          saveState();
          renderChecklist();
          return;
        }
        const parsed = parseTagsAndDue(input.value);
        item.text = parsed.text || "";
        item.tags = parsed.tags || [];
        if (parsed.dueAt) item.dueAt = parsed.dueAt;
        else item.dueAt = null;
        saveState();
        renderChecklist();
      };

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          finish(true);
        } else if (e.key === "Escape"){
          e.preventDefault();
          finish(false);
        }
      });
      input.addEventListener("blur", () => finish(true));

      setTimeout(() => {
        input.focus();
        input.setSelectionRange(input.value.length, input.value.length);
      }, 0);
    }

    function togglePriority(itemId){
      const item = state.checklist.find(x => x.id === itemId);
      if (!item) return;
      item.priority = !item.priority;
      saveState();
      renderChecklist();
    }

    function setDue(itemId){
      const item = state.checklist.find(x => x.id === itemId);
      if (!item) return;

      // quick prompt (fastest in-class)
      const cur = item.dueAt ? isoDate(new Date(item.dueAt)) : "";
      const val = prompt(
        "Set due date/time.\n\nFormats:\n  2026-03-01\n  2026-03-01 14:30\n  14:30 (today)\n\nLeave blank to clear.",
        cur
      );
      if (val === null) return;

      const t = String(val).trim();
      if (!t){
        item.dueAt = null;
        saveState();
        renderChecklist();
        return;
      }

      // accept "YYYY-MM-DD HH:MM" or "YYYY-MM-DD" or "HH:MM"
      let dueAt = null;
      if (/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}$/.test(t)){
        const [dpart, hpart] = t.split(/\s+/);
        const [hh, mm] = hpart.split(":");
        const dt = new Date(dpart + "T" + pad2(parseInt(hh,10)) + ":" + pad2(parseInt(mm,10)) + ":00");
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
      } else if (/^\d{4}-\d{2}-\d{2}$/.test(t)){
        const dt = new Date(t + "T23:59:00");
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
      } else if (/^\d{1,2}:\d{2}$/.test(t)){
        const now = new Date();
        const [hh, mm] = t.split(":").map(n => parseInt(n,10));
        const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
        if (!isNaN(dt.getTime())) dueAt = dt.getTime();
      }

      if (!dueAt){
        alert("Couldn't parse that due value. Try: 2026-03-01 or 2026-03-01 14:30 or 14:30");
        return;
      }
      item.dueAt = dueAt;
      saveState();
      renderChecklist();
    }

    function deleteItem(itemId){
      const snap = snapshotState();
      const idx = state.checklist.findIndex(x => x.id === itemId);
      if (idx < 0) return;
      const label = state.checklist[idx].text || "item";
      state.checklist.splice(idx,1);
      saveState();
      renderChecklist();
      showUndo(`Deleted: ${label}`, snap);
    }

    // drag reorder
    let dragId = null;

    function renderChecklist(){
      // normalize once
      state.checklist = (state.checklist || []).map((it, idx) => normalizeChecklistItem(it, idx));

      // persist UI state
      if (!state.checklistUI) state.checklistUI = { hideDone:false, filter:"" };

      const hideDone = !!state.checklistUI.hideDone;
      const filter = (state.checklistUI.filter || "");

      // progress
      const total = state.checklist.length;
      const doneCount = state.checklist.filter(i => i.done).length;
      checkProgressEl.textContent = `${doneCount}/${total}`;

      // button text
      collapseDoneBtn.textContent = hideDone ? "Show Done" : "Hide Done";

      // filter box value
      if (checkFilterEl.value !== filter) checkFilterEl.value = filter;

      // render list
      checkListEl.innerHTML = "";

      const nowTs = Date.now();

      let visible = sortChecklistStable(state.checklist)
        .filter(it => (hideDone ? !it.done : true))
        .filter(it => matchesFilter(it, filter));

      if (!visible.length){
        const empty = document.createElement("div");
        empty.className = "tinyHint";
        empty.textContent = total ? "No matches. Clear the filter or show done items." : "No items yet. Add one above.";
        checkListEl.appendChild(empty);
        return;
      }

      visible.forEach((item) => {
        const row = document.createElement("div");
        row.className = "checkItem" + (item.done ? " done" : "") + (item.priority ? " priority" : "");
        row.dataset.id = item.id;

        const isOverdue = !!(item.dueAt && !item.done && nowTs > item.dueAt);
        if (isOverdue) row.classList.add("overdue");

        // left side elements
        const handle = document.createElement("div");
        handle.className = "dragHandle";
        handle.title = "Drag to reorder";
        handle.draggable = true;

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!item.done;
        cb.setAttribute("aria-label", "Toggle item");

        const txt = document.createElement("div");
        txt.className = "txt";
        txt.textContent = item.text || "";

        // actions
        const actions = document.createElement("div");
        actions.className = "checkActions";
        actions.innerHTML = `
          <button class="iconBtn ${item.priority ? "priOn" : ""}" type="button" title="Toggle priority">★</button>
          <button class="iconBtn" type="button" title="Set/clear due">DUE</button>
          <button class="iconBtn" type="button" title="Edit">✎</button>
          <button class="iconBtn danger" type="button" title="Delete">🗑</button>
        `;

        const priBtn = actions.children[0];
        const dueBtn = actions.children[1];
        const editBtn = actions.children[2];
        const delBtn = actions.children[3];

        // chips row
        const chips = document.createElement("div");
        chips.className = "chipRow";
        if (item.dueAt){
          const c = document.createElement("span");
          c.className = "chip due";
          c.textContent = prettyDue(item.dueAt);
          chips.appendChild(c);
        }
        (item.tags || []).slice(0, 6).forEach(t => {
          const c = document.createElement("span");
          c.className = "chip tag";
          c.textContent = "#" + t;
          chips.appendChild(c);
        });

        // compose row
        const mid = document.createElement("div");
        mid.style.flex = "1";
        mid.style.minWidth = "0";
        mid.appendChild(txt);
        if (chips.childNodes.length) mid.appendChild(chips);

        row.appendChild(handle);
        row.appendChild(cb);
        row.appendChild(mid);
        row.appendChild(actions);

        // checkbox behavior + completion timestamp
        cb.addEventListener("change", () => {
          const it = state.checklist.find(x => x.id === item.id);
          if (!it) return;
          it.done = cb.checked;
          it.completedAt = it.done ? Date.now() : null;
          saveState();
          renderChecklist();
        });

        // edit triggers
        txt.addEventListener("dblclick", () => startEdit(item.id));
        editBtn.addEventListener("click", () => startEdit(item.id));

        // priority + due + delete
        priBtn.addEventListener("click", () => togglePriority(item.id));
        dueBtn.addEventListener("click", () => setDue(item.id));
        delBtn.addEventListener("click", () => deleteItem(item.id));

        // drag events (handle-only)
        handle.addEventListener("dragstart", (e) => {
          dragId = item.id;
          try{
            e.dataTransfer.setData("text/plain", item.id);
          }catch(_){}
          e.dataTransfer.effectAllowed = "move";
        });

        row.addEventListener("dragover", (e) => {
          if (!dragId || dragId === item.id) return;
          e.preventDefault();
          row.classList.add("dragOver");
          e.dataTransfer.dropEffect = "move";
        });

        row.addEventListener("dragleave", () => row.classList.remove("dragOver"));

        row.addEventListener("drop", (e) => {
          e.preventDefault();
          row.classList.remove("dragOver");
          const fromId = dragId;
          const toId = item.id;
          dragId = null;
          if (!fromId || fromId === toId) return;

          const snap = snapshotState();

          const listSorted = sortChecklistStable(state.checklist);

          const fromIdx = listSorted.findIndex(x => x.id === fromId);
          const toIdx = listSorted.findIndex(x => x.id === toId);
          if (fromIdx < 0 || toIdx < 0) return;

          const moved = listSorted.splice(fromIdx, 1)[0];
          listSorted.splice(toIdx, 0, moved);

          // reassign order sequentially (stable)
          listSorted.forEach((x, i) => x.order = i);

          // write back by id
          const byId = new Map(listSorted.map(x => [x.id, x]));
          state.checklist = state.checklist.map(x => byId.get(x.id) || x);

          saveState();
          renderChecklist();
          showUndo("Reordered checklist", snap);
        });

        checkListEl.appendChild(row);
      });
    }

    function addChecklistItem(rawText){
      const t = (rawText || "").trim();
      if (!t) return;

      const parsed = parseTagsAndDue(t);
      const item = normalizeChecklistItem({
        id: uid(),
        text: parsed.text,
        done: false,
        createdAt: Date.now(),
        completedAt: null,
        dueAt: parsed.dueAt || null,
        priority: false,
        tags: parsed.tags || [],
        order: 0
      }, 0);

      // Put new item at top: bump others' order
      const sorted = sortChecklistStable(state.checklist);
      sorted.forEach(x => x.order = (typeof x.order === "number" ? x.order : 0) + 1);
      item.order = 0;

      state.checklist = [item, ...sorted];
      saveState();
      newItemText.value = "";
      renderChecklist();
    }

    addItemBtn.addEventListener("click", ()=> addChecklistItem(newItemText.value));
    newItemText.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        addChecklistItem(newItemText.value);
      }
    });

    clearCheckedBtn.addEventListener("click", ()=>{
      const snap = snapshotState();
      const before = state.checklist.length;
      state.checklist = state.checklist.filter(it => !it.done);
      // reindex order
      sortChecklistStable(state.checklist).forEach((x,i)=> x.order = i);
      saveState();
      renderChecklist();
      const removed = before - state.checklist.length;
      if (removed > 0) showUndo(`Cleared ${removed} completed item${removed===1?"":"s"}`, snap);
    });

    exportChecklistBtn.addEventListener("click", () => {
      // export only checklist (convenient)
      openModal("exportChecklist");
    });

    // filter + collapse done
    function setChecklistFilter(v){
      state.checklistUI.filter = String(v||"");
      saveState();
      renderChecklist();
    }
    checkFilterEl.addEventListener("input", (e)=> setChecklistFilter(e.target.value));

    collapseDoneBtn.addEventListener("click", () => {
      state.checklistUI.hideDone = !state.checklistUI.hideDone;
      saveState();
      renderChecklist();
    });

    // initial hydrate UI state
    checkFilterEl.value = state.checklistUI?.filter || "";
    collapseDoneBtn.textContent = state.checklistUI?.hideDone ? "Show Done" : "Hide Done";

    renderChecklist();

    /************************************************************
     * Blue/Gold auto mode (anchor-date based)
     ************************************************************/
    function getWeekModeForDate(date){
      if (!isValidISODate(state.blueAnchor)) return null;
      const anchor = new Date(state.blueAnchor + "T00:00:00");
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      const toMonday = (x) => {
        const dd = new Date(x.getFullYear(), x.getMonth(), x.getDate());
        const dow = dd.getDay();
        const diff = (dow + 6) % 7;
        dd.setDate(dd.getDate() - diff);
        return dd;
      };

      const aMon = toMonday(anchor);
      const dMon = toMonday(d);

      const weeksDiff = Math.round((dMon - aMon) / (7*24*60*60*1000));
      return (weeksDiff % 2 === 0) ? "blue" : "gold";
    }

    function dayKeyFromDate(d){
      return dayKeys[d.getDay()];
    }

function isClassBlock(block){
  return ["A","B","C","D","E","F","G","H"].includes(block);
}

// A "listed class" is something you actually teach / need counted:
// - A–G only if named
// - H only if Office Hours is active for this week
// - Reading Period only when immediately followed by a listed class
function isListedClassPeriod(p, weekForDate){
  if (p.block === "Reading Period") return !!p.teachReading; // set in buildPeriodsForDate
  if (!isClassBlock(p.block)) return false;

  if (p.block === "H"){
    const mode = state.officeHoursMode || "none";
    const hasOH =
      (mode === "both") ||
      (mode === "blue" && weekForDate === "blue") ||
      (mode === "gold" && weekForDate === "gold");

    return hasOH;
  }

  // A–G require a name (if no name, treat as "nothing")
  return !!(state.blocks[p.block] && state.blocks[p.block].trim());
}
    function blockLabel(block, weekForDate){
      const lunchish = [
        "MS/US Lunch +MS/US Clubs",
        "MS/US SuperLunch +Affinity Groups",
        "H/X1",
        "X3",
        "Educators’ Mtg.",
        "Reading Period",
        "Bulletin"
      ];
      if (lunchish.includes(block)) return { label:block, named:false, blockKey:null };

      if (block === "H"){
        const mode = state.officeHoursMode || "none";
        if ((mode === "both") ||
            (mode === "blue" && weekForDate === "blue") ||
            (mode === "gold" && weekForDate === "gold")){
          return { label:"Office Hours", named:true, blockKey:"H" };
        }
      }
      const hasName = !!(state.blocks[block] && state.blocks[block].trim());
      return { label: hasName ? `${state.blocks[block]} (${block})` : block, named: hasName, blockKey:block };
    }

    function buildPeriodsForDate(dateObj){
      const dk = dayKeyFromDate(dateObj);
      if (dk === "sunday" || dk === "saturday") return { periods: [], week:null, day:dk };

      const week = getWeekModeForDate(dateObj);
      if (!week) return { periods: [], week:null, day:dk };

      const src = scheduleByWeek[week]?.[dk] || [];
let periods = src.map(p => {
  const range = parseRange(p.time);
  const meta = blockLabel(p.block, week);
  return {
    ...p,
    label: meta.label,
    named: meta.named,
    blockKey: meta.blockKey,
    range,
    teachReading: false
  };
}).filter(p => p.range);

// If Reading Period is immediately followed by a listed class, treat it as a class
for (let i = 0; i < periods.length - 1; i++){
  const cur = periods[i];
  const next = periods[i+1];
  if (cur.block === "Reading Period"){
    // next period must be a "listed class"
    const nextIsListed = isListedClassPeriod(next, week);
    if (nextIsListed){
      cur.teachReading = true;
      cur.named = true;          // makes it highlight blue via .periodCard.named
      cur.label = "Reading Period";
      cur.blockKey = null;
    }
  }
}

return { periods, week, day:dk };
    }

    /************************************************************
     * Center holo schedule + energy + countdown + time marker
     ************************************************************/
function findNextListedClass(periods, minutesNow, weekForDate){
  let best = null;

  for (const p of periods){
    if (!p.range) continue;
    if (!isListedClassPeriod(p, weekForDate)) continue;

    if (p.range.start > minutesNow){
      if (!best || p.range.start < best.range.start) best = p;
    }
  }
  return best;
}
    function formatCountdown(totalSec){
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${m}:${pad2(s)}`;
    }

    function updateCountdown(textOrNull, warn){
      if (textOrNull === null){
        countdownText.textContent = "—";
        countdownBox.classList.remove("warn");
        return;
      }
      countdownText.textContent = textOrNull;
      if (warn) countdownBox.classList.add("warn");
      else countdownBox.classList.remove("warn");
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function renderCenterScheduleAndTimers(){
      const view = new Date(state.viewDate + "T00:00:00");
      const now = new Date();
      const isToday = isoDate(now) === state.viewDate;

      const { periods, week, day } = buildPeriodsForDate(view);
      const dayName = day.charAt(0).toUpperCase() + day.slice(1);
      const weekName = week ? week.toUpperCase() : "—";

      if (!week && (day === "saturday" || day === "sunday")){
        dayModePill.textContent = `Weekend • ${dayName}`;
      } else if (!week){
        dayModePill.textContent = `Auto needs anchor`;
      } else {
        dayModePill.textContent = `${weekName} • ${dayName}`;
      }

      const minutesNow = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;

      holoTag.textContent = `Daily Schedule • ${state.viewDate}`;
      holoStatus.textContent = week ? `${weekName} • ${dayName}` : (dayName);

      // Default: hide time marker unless today & schedule present

      if (!periods.length){
        holoList.innerHTML = `
          <div class="periodCard misc">
            <div class="t">—</div>
            <div class="lbl">${(day==="saturday"||day==="sunday") ? "Weekend." : "Set Blue anchor date + save block names (and links, if you want)."} </div>
          </div>
        `;
        energyFill.style.width = "0%";
        energyPct.textContent = "0%";
        energyNote.textContent = (day==="saturday"||day==="sunday") ? "Standby" : "Awaiting schedule…";
        updateCountdown(null, false);
        return;
      }

      // render block-cards
      holoList.innerHTML = "";
      const maxShow = Math.min(periods.length, 12);
      for (let i=0; i<maxShow; i++){
        const p = periods[i];
        const isNow = isToday && (minutesNow >= p.range.start && minutesNow < p.range.end);

        const card = document.createElement("div");
        const isMisc = !isClassBlock(p.block) && !(p.block === "Reading Period" && p.teachReading);
        const named = !!p.named;

card.className = "periodCard"
  + (isMisc ? " misc" : "")
  + (named ? " named" : "")
  + (isNow ? " now" : "");
        const link = (p.blockKey && (state.links[p.blockKey] || "").trim()) || "";
        const safeLabel = escapeHtml(p.label);
        const safeTime = escapeHtml(p.time);

        let labelHTML = safeLabel;

        if (!isMisc && named && link){
          // clickable named class period
          labelHTML = `
            <a class="periodLink" href="${escapeHtml(link)}" target="_blank" rel="noopener">
              <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${safeLabel}</span>
              <span class="linkBadge">OPEN</span>
            </a>
          `;
        }

        card.innerHTML = `
          <div class="t">${safeTime}</div>
          <div class="lbl">${labelHTML}</div>
        `;

        holoList.appendChild(card);
      }

      // Energy + countdown (only for today)
      if (!isToday){
        energyFill.style.width = "0%";
        energyPct.textContent = "—";
        energyNote.textContent = "Energy grid is live only for today";
        updateCountdown("—", false);
        return;
      }

      const lastEnd = Math.max(...periods.map(p => p.range.end));
      const firstStart = Math.min(...periods.map(p => p.range.start));
      const clamped = clamp(minutesNow, firstStart, lastEnd);
      const prog = (clamped - firstStart) / (lastEnd - firstStart);
      const pct = Math.round(prog * 100);

      energyFill.style.width = `${pct}%`;
// Pulse speed: constant 3 seconds, regardless of fill %
energyFill.style.setProperty("--pulseDur", `3s`);
      energyPct.textContent = `${pct}%`;

      if (minutesNow < firstStart) energyNote.textContent = "Pre-start";
      else if (minutesNow >= lastEnd) energyNote.textContent = "Complete";
      else energyNote.textContent = "In progress";

      const next = findNextListedClass(periods, minutesNow, week);
      if (!next){
        updateCountdown("No more classes", false);
      } else {
        const deltaSec = Math.max(0, Math.round((next.range.start - minutesNow) * 60));
        const warn = deltaSec > 0 && deltaSec <= 600; // <= 10 minutes
        updateCountdown(formatCountdown(deltaSec), warn);
      }
    }
    setInterval(renderCenterScheduleAndTimers, 700);
    renderCenterScheduleAndTimers();

    /************************************************************
     * Export / Import JSON (schedule + checklist + links)
     ************************************************************/
    function openModal(mode){
      overlay.style.display = "flex";

      if (mode === "export"){
        modalTitle.textContent = "Export";
        modalHint.textContent = "Copy this JSON to move your schedule + links + checklist to another computer.";
        jsonBox.value = JSON.stringify(state, null, 2);
        applyJsonBtn.style.display = "none";
        jsonBox.readOnly = true;
        return;
      }

      if (mode === "exportChecklist"){
        modalTitle.textContent = "Export Checklist";
        modalHint.textContent = "Copy this JSON if you only want to move the checklist.";
        jsonBox.value = JSON.stringify({ checklist: state.checklist }, null, 2);
        applyJsonBtn.style.display = "none";
        jsonBox.readOnly = true;
        return;
      }

      modalTitle.textContent = "Import";
      modalHint.textContent = "Paste JSON exported from this dashboard and click Apply.";
      jsonBox.value = "";
      applyJsonBtn.style.display = "";
      jsonBox.readOnly = false;
    }
    function closeModalFn(){ overlay.style.display = "none"; }

    exportBtn.addEventListener("click", () => openModal("export"));
    importBtn.addEventListener("click", () => openModal("import"));
    closeModal.addEventListener("click", closeModalFn);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModalFn(); });

    copyJsonBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(jsonBox.value);
        flashPill("Copied");
      }catch(e){
        jsonBox.select();
        document.execCommand("copy");
        flashPill("Copied");
      }
    });

    applyJsonBtn.addEventListener("click", () => {
      try{
        const obj = JSON.parse(jsonBox.value);
        if (typeof obj !== "object" || !obj) throw new Error("Invalid JSON");

        // Allow importing a checklist-only file as a convenience
        if (obj.checklist && !obj.blocks && !obj.blueAnchor && !obj.links){
          state.checklist = Array.isArray(obj.checklist) ? obj.checklist.map((it, idx)=> normalizeChecklistItem(it, idx)) : [];
          saveState();
          renderChecklist();
          renderCenterScheduleAndTimers();
          closeModalFn();
          flashPill("Imported");
          return;
        }

        state = {
          ...structuredClone(defaultState),
          ...obj,
          blocks: { ...structuredClone(defaultState.blocks), ...(obj.blocks||{}) },
          links:  { ...structuredClone(defaultState.links),  ...(obj.links||{}) },
          checklist: Array.isArray(obj.checklist) ? obj.checklist.map((it, idx)=> normalizeChecklistItem(it, idx)) : [],
          checklistUI: { ...structuredClone(defaultState.checklistUI), ...(obj.checklistUI||{}) }
        };

        if (!isValidISODate(state.viewDate)) state.viewDate = isoDate(new Date());
        saveState();
        hydrateSetupUI();
        viewDateEl.value = state.viewDate;
        renderChecklist();
        renderCenterScheduleAndTimers();
        closeModalFn();
        flashPill("Imported");
      }catch(e){
        alert("Import failed. Make sure you pasted valid JSON exported from this dashboard.");
      }
    });

    /************************************************************
     * Google search focus with /
     ************************************************************/
    window.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement !== document.getElementById("googleQ")){
        e.preventDefault();
        document.getElementById("googleQ").focus();
      }
    });

    /************************************************************
     * Resize relayout for ring + canvases
     ************************************************************/
    window.addEventListener("resize", () => {
      layoutNodes();
      resizeMatrix();
      resizeLightning();
    });

    /************************************************************
     * MATRIX / ELECTRIC CASCADE BACKGROUND (canvas)
     ************************************************************/
    const matrixCanvas = document.getElementById("matrixBg");
    const mtx = matrixCanvas.getContext("2d", { alpha:true });

    let matrixCols = [];
    let matrixW = 0, matrixH = 0, matrixDPR = 1;
    let matrixFontPx = 14;
    let matrixStep = 16;

    // “Electric drops”: mix sparse glyphs + droplet chars
    const glyphs = "01░▒▓╌╎╍╏┆┇┊┋⋮⋯⟡⟢⟣⟠⟟⟞·";
    function randGlyph(){
      return glyphs[Math.floor(Math.random() * glyphs.length)];
    }

    function resizeMatrix(){
      matrixDPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      matrixW = Math.floor(window.innerWidth);
      matrixH = Math.floor(window.innerHeight);
      matrixCanvas.width = Math.floor(matrixW * matrixDPR);
      matrixCanvas.height = Math.floor(matrixH * matrixDPR);
      matrixCanvas.style.width = matrixW + "px";
      matrixCanvas.style.height = matrixH + "px";

      mtx.setTransform(matrixDPR,0,0,matrixDPR,0,0);

      // responsive sizing
      matrixFontPx = Math.max(12, Math.min(16, Math.floor(matrixW / 90)));
      matrixStep = Math.floor(matrixFontPx * 1.25);

      const cols = Math.floor(matrixW / matrixStep);
      matrixCols = new Array(cols).fill(0).map(() => ({
        y: Math.random() * matrixH,
        speed: 0.7 + Math.random() * 1.8,
        density: 0.08 + Math.random() * 0.22,
        glow: 0.08 + Math.random() * 0.20
      }));
      mtx.font = `${matrixFontPx}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace`;
    }

    function stepMatrix(){
      // fade with slight tint
      mtx.fillStyle = "rgba(7, 11, 26, 0.08)";
      mtx.fillRect(0,0,matrixW,matrixH);

      for (let i=0; i<matrixCols.length; i++){
        const col = matrixCols[i];
        const x = i * matrixStep;

        // occasionally skip drawing to keep it subtle
        if (Math.random() > col.density) continue;

        const ch = randGlyph();
        const y = col.y;

        // glow layer
        mtx.shadowBlur = 14;
        mtx.shadowColor = `rgba(45,125,255,${0.22 + col.glow})`;
        mtx.fillStyle = `rgba(123,231,255,${0.18 + col.glow})`;
        mtx.fillText(ch, x, y);

        // bright core
        mtx.shadowBlur = 0;
        mtx.fillStyle = `rgba(75,255,211,${0.07 + col.glow * 0.7})`;
        mtx.fillText(ch, x, y);

        col.y += col.speed * matrixStep * 0.22;

        if (col.y > matrixH + 50){
          col.y = -Math.random() * 200;
          col.speed = 0.7 + Math.random() * 1.8;
          col.density = 0.08 + Math.random() * 0.22;
          col.glow = 0.08 + Math.random() * 0.20;
        }
      }
      requestAnimationFrame(stepMatrix);
    }

    resizeMatrix();
    stepMatrix();

    /************************************************************
     * ELECTRIC LIGHTNING (canvas overlay)
     * - periodic, semi-random “real” bolts along console borders
     * - sometimes around ring/search for atmosphere
     ************************************************************/
    const fxCanvas = document.getElementById("fxLightning");
    const fx = fxCanvas.getContext("2d", { alpha:true });

    let fxW=0, fxH=0, fxDPR=1;
    function resizeLightning(){
      fxDPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      fxW = window.innerWidth;
      fxH = window.innerHeight;
      fxCanvas.width = Math.floor(fxW * fxDPR);
      fxCanvas.height = Math.floor(fxH * fxDPR);
      fxCanvas.style.width = fxW + "px";
      fxCanvas.style.height = fxH + "px";
      fx.setTransform(fxDPR,0,0,fxDPR,0,0);
    }
    resizeLightning();

    function rectOf(el){
      const r = el.getBoundingClientRect();
      return { x:r.left, y:r.top, w:r.width, h:r.height };
    }

    function jitter(n, amt){ return n + (Math.random()*2-1)*amt; }

    function makeBolt(x0,y0,x1,y1,segments=16,spread=18){
      const pts = [];
      for (let i=0;i<=segments;i++){
        const t = i/segments;
        const x = x0 + (x1-x0)*t;
        const y = y0 + (y1-y0)*t;
        // perpendicular jitter
        const dx = x1-x0, dy = y1-y0;
        const len = Math.hypot(dx,dy) || 1;
        const px = -dy/len, py = dx/len;
        const amp = (1 - Math.abs(0.5 - t)*2) * spread; // bigger in middle
        pts.push({
          x: jitter(x + px * (Math.random()*2-1) * amp, 1.8),
          y: jitter(y + py * (Math.random()*2-1) * amp, 1.8)
        });
      }
      return pts;
    }

    function branchFrom(pts, branchChance=0.25){
      // pick a mid point, branch outward
      if (Math.random() > branchChance) return null;
      const idx = Math.floor(pts.length * (0.35 + Math.random()*0.4));
      const p = pts[idx];
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*90;
      const x1 = p.x + Math.cos(angle)*dist;
      const y1 = p.y + Math.sin(angle)*dist;
      return makeBolt(p.x,p.y,x1,y1, 8+Math.floor(Math.random()*6), 10+Math.random()*10);
    }

    const bolts = []; // {pts, born, life, w, alpha, branches:[pts...]}

    function spawnBorderBolt(targetEl, edge="random"){
      const r = rectOf(targetEl);
      const inset = 2;
      const pick = edge === "random" ? ["top","right","bottom","left"][Math.floor(Math.random()*4)] : edge;

      let x0,y0,x1,y1;
      if (pick === "top"){
        x0 = r.x + inset + Math.random()*(r.w - inset*2);
        y0 = r.y + inset;
        x1 = r.x + inset + Math.random()*(r.w - inset*2);
        y1 = r.y + inset;
      } else if (pick === "bottom"){
        x0 = r.x + inset + Math.random()*(r.w - inset*2);
        y0 = r.y + r.h - inset;
        x1 = r.x + inset + Math.random()*(r.w - inset*2);
        y1 = r.y + r.h - inset;
      } else if (pick === "left"){
        x0 = r.x + inset;
        y0 = r.y + inset + Math.random()*(r.h - inset*2);
        x1 = r.x + inset;
        y1 = r.y + inset + Math.random()*(r.h - inset*2);
      } else {
        x0 = r.x + r.w - inset;
        y0 = r.y + inset + Math.random()*(r.h - inset*2);
        x1 = r.x + r.w - inset;
        y1 = r.y + inset + Math.random()*(r.h - inset*2);
      }

      // travel along edge
      if (pick === "top" || pick === "bottom"){
        x1 = x0 + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random()*180);
        x1 = clamp(x1, r.x + inset, r.x + r.w - inset);
      } else {
        y1 = y0 + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random()*180);
        y1 = clamp(y1, r.y + inset, r.y + r.h - inset);
      }

      const pts = makeBolt(x0,y0,x1,y1, 14, 14);
      const branches = [];
      const b1 = branchFrom(pts, 0.55);
      const b2 = branchFrom(pts, 0.35);
      if (b1) branches.push(b1);
      if (b2) branches.push(b2);

      bolts.push({
        pts,
        branches,
        born: performance.now(),
        life: 280 + Math.random()*520,
        w: 1.2 + Math.random()*1.4
      });
    }

    function spawnRingArc(){
      // occasional arc near ring circumference
      const ringRect = rectOf(document.getElementById("ring"));
      const cx = ringRect.x + ringRect.w/2;
      const cy = ringRect.y + ringRect.h/2;
      const rad = ringRect.w/2 - 18;
      const a0 = Math.random() * Math.PI * 2;
      const a1 = a0 + (Math.random() > 0.5 ? 1 : -1) * (0.7 + Math.random()*1.0);
      const x0 = cx + Math.cos(a0)*rad;
      const y0 = cy + Math.sin(a0)*rad;
      const x1 = cx + Math.cos(a1)*rad;
      const y1 = cy + Math.sin(a1)*rad;

      const pts = makeBolt(x0,y0,x1,y1, 18, 18);
      bolts.push({
        pts,
        branches: [],
        born: performance.now(),
        life: 240 + Math.random()*380,
        w: 1.2 + Math.random()*1.2
      });
    }

    function drawBoltPath(pts, alpha, width){
      fx.beginPath();
      fx.moveTo(pts[0].x, pts[0].y);
      for (let i=1;i<pts.length;i++){
        fx.lineTo(pts[i].x, pts[i].y);
      }

      // glow underlay
      fx.globalAlpha = alpha * 0.65;
      fx.lineWidth = width * 5.0;
      fx.strokeStyle = "rgba(45,125,255,1)";
      fx.shadowBlur = 20;
      fx.shadowColor = "rgba(45,125,255,0.8)";
      fx.stroke();

      // bright core
      fx.globalAlpha = alpha;
      fx.lineWidth = width;
      fx.strokeStyle = "rgba(123,231,255,1)";
      fx.shadowBlur = 0;
      fx.stroke();
    }

    function stepLightning(){
      fx.clearRect(0,0,fxW,fxH);
      const now = performance.now();

      for (let i=bolts.length-1;i>=0;i--){
        const b = bolts[i];
        const age = now - b.born;
        const t = age / b.life;
        if (t >= 1){
          bolts.splice(i,1);
          continue;
        }
        // quick flash curve
        const alpha = (t < 0.15) ? (t/0.15) : (t < 0.55 ? 1 : (1 - (t-0.55)/0.45));
        drawBoltPath(b.pts, alpha, b.w);

        for (const br of b.branches){
          drawBoltPath(br, alpha * 0.8, Math.max(0.9, b.w*0.85));
        }
      }

      requestAnimationFrame(stepLightning);
    }
    stepLightning();

    // periodic scheduling (random-ish, unobtrusive)
    const bayEl = document.getElementById("bay");
    const cockpitEl = document.getElementById("cockpit");
    const topbarEl = document.querySelector(".topbar");

    function scheduleSparks(){
      // fire a small cluster sometimes
      const burst = Math.random() < 0.65;
      const targets = [bayEl, cockpitEl, topbarEl];

      // 1–3 bolts
      const count = burst ? (1 + Math.floor(Math.random()*3)) : 1;
      for (let i=0;i<count;i++){
        const t = targets[Math.floor(Math.random()*targets.length)];
        spawnBorderBolt(t, "random");
      }

      // occasional ring arc
      if (Math.random() < 0.35){
        spawnRingArc();
      }

      // next interval: 1.2s–5.0s
      const next = 1200 + Math.random()*3800;
      setTimeout(scheduleSparks, next);
    }
    // start after a short warmup
    setTimeout(scheduleSparks, 900);

    /************************************************************
     * Keyboard: ESC closes modal
     ************************************************************/
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.style.display === "flex"){
        overlay.style.display = "none";
      }
    });
  </script>
</body>
</html>
