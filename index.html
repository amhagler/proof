<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geffen Cockpit Dashboard</title>
  <style>
    :root{
      /* Futuristic blue + metallic (FF7-ish mako + steel) */
      --bg0:#070B1A;
      --bg1:#0B1230;
      --panel:#0C1638;
      --panel2:#0A1230;

      --ink:#EAF0FF;
      --muted:#B7C2E6;

      --electric:#2D7DFF;
      --electric2:#1E5BFF;
      --cyan:#7BE7FF;

      --mako:#4BFFD3;
      --brass:#D7B56D;
      --brass2:#8A6B2F;
      --steel:#9AA7C1;
      --steel2:#6D7A96;

      --gold:#FFE066;
      --red:#FF5A5A;
      --orange:#FFB35A;

      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.18);

      --radius: 18px;
      --radius2: 26px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --serif: ui-serif, Georgia, "Times New Roman", serif;

      /* Ring sizing (circular nodes) */
      --ringSize: 720px;
      --nodeW: 132px;
      --nodeH: 132px;
      --ringPad: 40px;

      /* SMALLER center holo */
      --holoInset: 210px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(45,125,255,.16), transparent 55%),
        radial-gradient(1100px 620px at 80% 18%, rgba(123,231,255,.10), transparent 60%),
        radial-gradient(900px 520px at 60% 95%, rgba(215,181,109,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ===== Matrix/electric cascade background ===== */
    #matrixBg{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(.15px);
    }
    .scanlines, .fog{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
    }
    .scanlines{
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03),
        rgba(255,255,255,.03) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity:.14;
      mix-blend-mode: overlay;
    }
    .fog{
      background:
        radial-gradient(1000px 600px at 25% 60%, rgba(123,231,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 45%, rgba(45,125,255,.08), transparent 60%),
        radial-gradient(720px 420px at 52% 86%, rgba(75,255,211,.06), transparent 65%),
        radial-gradient(700px 420px at 40% 92%, rgba(215,181,109,.06), transparent 70%);
      filter: blur(12px);
      opacity:.55;
      animation: fogMove 16s ease-in-out infinite alternate;
    }
    @keyframes fogMove{
      from{ transform: translate3d(-10px, 0, 0) scale(1.02); }
      to{ transform: translate3d(14px, -9px, 0) scale(1.03); }
    }

    /* ===== Lightning overlay canvas ===== */
    #fxLightning{
      position:fixed;
      inset:0;
      z-index:10;
      pointer-events:none;
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:6;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(7,11,26,.80), rgba(7,11,26,.42));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .topbarInner{
      max-width: 1320px;
      margin:0 auto;
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      position:relative;
      z-index:2;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 240px;
    }
    .brand .title{
      font-family: var(--serif);
      letter-spacing:.7px;
      font-weight: 900;
      font-size: 18px;
      line-height:1.1;
      color: var(--ink);
      text-shadow: 0 0 18px rgba(45,125,255,.25);
    }
    .brand .subtitle{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
    }

    .clockBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-family: var(--mono);
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.75));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      min-width: 300px;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .clockBox::before{
      content:"";
      position:absolute;
      inset: -2px;
      background:
        radial-gradient(220px 70px at 20% 25%, rgba(215,181,109,.10), transparent 70%),
        radial-gradient(240px 90px at 75% 65%, rgba(75,255,211,.07), transparent 70%);
      pointer-events:none;
      opacity:.9;
    }
    .clockTop{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:center;
      position:relative;
      z-index:2;
    }
    .clockBox .date{ color: rgba(234,240,255,.75); font-size: 12px; }
    .clockBox .time{ color: var(--ink); font-size: 15px; font-weight: 900; }
    .clockBox .ticks{ color: rgba(123,231,255,.85); font-size: 12px; }

    @keyframes warnPulse{
      0%, 100% { box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 10px 22px rgba(0,0,0,.35); }
      50% { box-shadow: 0 0 0 1px rgba(123,231,255,.22) inset, 0 0 18px rgba(45,125,255,.32), 0 10px 22px rgba(0,0,0,.35); }
    }
    .countdown{
      display:flex;
      justify-content:center;
      gap:8px;
      font-size: 11px;
      color: rgba(234,240,255,.74);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .countdown b{ color: rgba(234,240,255,.92); }
    .countdown.warn{
      border-color: rgba(123,231,255,.22);
      animation: warnPulse 1.6s ease-in-out infinite;
    }

    .searchWrap{
      flex: 1;
      min-width: 280px;
      max-width: 580px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(12,22,56,.85), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .searchWrap::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(300px 80px at 25% 10%, rgba(215,181,109,.09), transparent 70%),
        radial-gradient(260px 90px at 70% 90%, rgba(75,255,211,.06), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }
    .searchWrap .lens{
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(123,231,255,.75);
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
      z-index:2;
    }
    .searchWrap .lens:after{
      content:"";
      position:absolute;
      width: 10px; height: 2px;
      background: rgba(123,231,255,.75);
      right:-8px; bottom:-3px;
      transform: rotate(45deg);
      border-radius: 3px;
    }
    .searchWrap input{
      flex:1;
      background: transparent;
      border: none;
      outline:none;
      color: var(--ink);
      font-family: var(--mono);
      font-size: 13px;
      position:relative;
      z-index:2;
    }
    .searchWrap button{
      border:none;
      cursor:pointer;
      color: #07101f;
      font-weight: 900;
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.12) inset, 0 10px 22px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .18s ease;
      flex: 0 0 auto;
      position:relative;
      z-index:2;
    }
    .searchWrap button:hover{ filter: brightness(1.05); }
    .searchWrap button:active{ transform: translateY(1px); }

    /* Main layout */
    .shell{
      position:relative;
      z-index:3;
      max-width: 1320px;
      margin: 18px auto 40px auto;
      padding: 0 16px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1040px){
      .shell{ grid-template-columns: 1fr; }
      :root{ --ringSize: 640px; --holoInset: 190px; --nodeW:124px; --nodeH:124px; }
    }
    @media (max-width: 680px){
      :root{ --ringSize: 580px; --holoInset: 175px; --nodeW:116px; --nodeH:116px; }
    }

    /* Left: ring bay */
    .bay{
      position:relative;
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.76), rgba(10,18,48,.62));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow: visible;
      min-height: calc(var(--ringSize) + 120px);
    }
    .bay::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: var(--radius2);
      background:
        radial-gradient(920px 420px at 25% 30%, rgba(45,125,255,.20), transparent 60%),
        radial-gradient(720px 360px at 70% 60%, rgba(123,231,255,.14), transparent 55%),
        radial-gradient(520px 320px at 50% 90%, rgba(215,181,109,.10), transparent 60%);
      filter: blur(10px);
      opacity:.95;
      pointer-events:none;
      z-index:0;
    }
    .bay .trim{
      position:absolute;
      inset:10px;
      border-radius: calc(var(--radius2) - 6px);
      border: 1px solid rgba(215,181,109,.20);
      box-shadow: 0 0 0 1px rgba(0,0,0,.22) inset;
      pointer-events:none;
      z-index:1;
      opacity:.85;
    }

    .bayHeader{
      position:relative;
      z-index:4;
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      border-radius: var(--radius2);
    }
    .bayHeader .h1{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .bayHeader .h1 b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .bayHeader .h1 span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .bayHeader .datePick{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.70);
    }
    .bayHeader .datePickRow{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .bayHeader input[type="date"]{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.25);
      color: var(--ink);
      padding: 8px 10px;
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
    }
    .bayHeader input[type="date"]:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }

    .ringStage{
      position:relative;
      z-index:2;
      height: calc(var(--ringSize) + 16px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(var(--ringPad) + 10px) var(--ringPad) 18px var(--ringPad);
      user-select:none;
    }

    .ring{
      width: var(--ringSize);
      height: var(--ringSize);
      border-radius: 50%;
      position:relative;
      transform: translateZ(0);
      outline:none;
    }

    /* Track / ring face */
    .ring:before{
      content:"";
      position:absolute;
      inset: 22px;
      border-radius:50%;
      border: 1px solid rgba(123,231,255,.22);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.16) inset,
        0 0 26px rgba(45,125,255,.14),
        0 0 80px rgba(45,125,255,.08);
      background:
        radial-gradient(circle at 50% 50%, rgba(12,22,56,.40), rgba(7,11,26,.55));
      z-index:0;
    }
    .ring:after{
      content:"";
      position:absolute;
      inset: 64px;
      border-radius:50%;
      border: 1px dashed rgba(215,181,109,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }

    /* Smaller center holo, and visually “quieter” */
    .holo{
      position:absolute;
      inset: var(--holoInset);
      border-radius: 22px;
      background:
        linear-gradient(180deg, rgba(12,22,56,.30), rgba(10,18,48,.14));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 0 0 1px rgba(45,125,255,.08) inset;
      backdrop-filter: blur(8px);
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 10px 10px 10px 10px;
      pointer-events:auto; /* allow clicks on schedule links */
      z-index:2;
      opacity:.92;
    }
    .holo .holoTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .holo .tag{
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.82);
    }
    .holo .sub{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(234,240,255,.60);
      white-space:nowrap;
    }

    /* schedule block list wrapper so we can place the time marker */
    .holoListWrap{
      position:relative;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .holoList{
      display:grid;
      gap: 8px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.82);
      max-height: 250px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(123,231,255,.35) rgba(0,0,0,.0);
    }
    .holoList::-webkit-scrollbar{ width: 10px; }
    .holoList::-webkit-scrollbar-thumb{
      background: rgba(123,231,255,.24);
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,.0);
      background-clip: padding-box;
    }
    .holoList::-webkit-scrollbar-track{ background: transparent; }

    .periodCard{
      position:relative;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding: 9px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      box-shadow: 0 0 0 1px rgba(45,125,255,.06) inset;
    }
    .periodCard .t{
      flex: 0 0 auto;
      min-width: 78px;
      color: rgba(234,240,255,.72);
      font-size: 10px;
      letter-spacing:.03em;
      margin-top: 1px;
    }
    .periodCard .lbl{
      flex:1;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .periodCard.misc{
      opacity:.78;
      border-color: rgba(255,255,255,.08);
    }
    .periodCard.named{
      border-color: rgba(123,231,255,.22);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.10) inset,
        0 0 18px rgba(45,125,255,.10);
      background:
        radial-gradient(220px 70px at 25% 0%, rgba(45,125,255,.12), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .periodCard.now{
      border-color: rgba(215,181,109,.25);
      box-shadow:
        0 0 0 1px rgba(215,181,109,.14) inset,
        0 0 22px rgba(215,181,109,.10);
    }
    .periodCard a.periodLink{
      color: rgba(234,240,255,.92);
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .periodCard a.periodLink:hover{
      text-decoration: underline;
      text-decoration-color: rgba(123,231,255,.55);
      text-underline-offset: 3px;
    }
    .linkBadge{
      flex: 0 0 auto;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.22);
      color: rgba(123,231,255,.92);
      background: rgba(45,125,255,.10);
      white-space:nowrap;
    }

    /* time marker (blue “cursor” that slides down schedule for today) */
    .timeMarker{
      position:absolute;
      left: 8px;
      right: 8px;
      height: 0;
      top: 0;
      pointer-events:none;
      z-index:5;
      opacity:0;
      transition: opacity .25s ease;
    }
    .timeMarker.on{ opacity: 1; }
    .timeMarker .bar{
      position:absolute;
      left: 0;
      right: 0;
      top: -1px;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(123,231,255,.0), rgba(123,231,255,.75), rgba(45,125,255,.75), rgba(75,255,211,.45), rgba(123,231,255,.0));
      box-shadow: 0 0 16px rgba(45,125,255,.25);
      filter: blur(.05px);
    }
    .timeMarker .dot{
      position:absolute;
      top: -6px;
      left: 10px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(123,231,255,.92);
      box-shadow: 0 0 18px rgba(45,125,255,.38);
      border: 1px solid rgba(255,255,255,.18);
    }
    .timeMarker .tag{
      position:absolute;
      top: -14px;
      right: 10px;
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(234,240,255,.78);
      background: rgba(7,11,26,.45);
      border: 1px solid rgba(255,255,255,.10);
      padding: 3px 8px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    /* orbit nodes */
    .node{
      position:absolute;
      width: var(--nodeW);
      height: var(--nodeH);
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      will-change: transform;
      cursor:pointer;
      z-index:5;
    }

    /* Circular rotating cards */
    .cardLink{
      width: 100%;
      height: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 12px 10px;
      border-radius: 50%;
      text-decoration:none;
      color: var(--ink);
      background:
        radial-gradient(90px 70px at 35% 25%, rgba(123,231,255,.18), transparent 70%),
        radial-gradient(90px 70px at 70% 75%, rgba(215,181,109,.10), transparent 75%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)),
        linear-gradient(180deg, rgba(12,22,56,.82), rgba(10,18,48,.72));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:
        0 0 0 1px rgba(45,125,255,.10) inset,
        0 16px 28px rgba(0,0,0,.42);
      transition: transform .12s ease, border-color .18s ease, filter .18s ease;
      position:relative;
      overflow:hidden;
      pointer-events:auto;
    }
    .cardLink::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: 50%;
      background:
        radial-gradient(22px 12px at 22% 30%, rgba(123,231,255,0), rgba(123,231,255,0) 60%, rgba(123,231,255,.18) 66%, rgba(123,231,255,0) 80%),
        radial-gradient(22px 12px at 78% 62%, rgba(45,125,255,0), rgba(45,125,255,0) 60%, rgba(45,125,255,.14) 66%, rgba(45,125,255,0) 80%);
      opacity:.0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .cardLink:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(123,231,255,.30);
      filter: brightness(1.06);
    }
    .cardLink:hover::after{ opacity:.9; }
    .cardLink:active{
      transform: translateY(-1px) scale(1.005);
    }
    .cardTitle{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      text-align:center;
      line-height:1.15;
      padding: 0 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .cardSub{
      font-family: var(--mono);
      font-size: 9px;
      color: rgba(234,240,255,.70);
      text-align:center;
      padding: 0 8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .glyph{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        linear-gradient(180deg, rgba(215,181,109,.92), rgba(138,107,47,.74));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 10px 18px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#120f07;
      font-weight: 900;
      font-family: var(--mono);
      flex: 0 0 auto;
    }

    /* energy bar */
    .energyWrap{
      position:relative;
      z-index:4;
      padding: 0 14px 14px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .energyBar{
      width: min(760px, 92%);
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.18) inset;
      position:relative;
      overflow:hidden;
    }
    .energyFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(123,231,255,.95), rgba(45,125,255,.92), rgba(75,255,211,.62));
      box-shadow: 0 0 22px rgba(45,125,255,.24);
      transition: width 1.2s ease;
      position:relative;
    }
    .energyMeta{
      margin-top: 8px;
      width: min(760px, 92%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.70);
    }
    .energyMeta b{ color: rgba(234,240,255,.88); }

    /* Right cockpit panel */
    .cockpit{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(12,22,56,.82), rgba(10,18,48,.70));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cockpit::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(620px 360px at 30% 10%, rgba(123,231,255,.14), transparent 60%),
        radial-gradient(520px 260px at 70% 80%, rgba(215,181,109,.08), transparent 65%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }

    .cockHeader{
      position:relative;
      z-index:2;
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
    }
    .cockHeader .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .cockHeader .left b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(234,240,255,.85);
    }
    .cockHeader .left span{
      font-size: 12px;
      color: rgba(234,240,255,.70);
    }

    .pill{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.72);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 10px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .pill .spark{
      width: 8px; height: 8px; border-radius:50%;
      background: rgba(123,231,255,.95);
      box-shadow: 0 0 12px rgba(123,231,255,.35);
    }

    .cockBody{
      position:relative;
      z-index:2;
      padding: 14px;
      display:grid;
      gap: 12px;
    }

    .module{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(45,125,255,.08) inset, 0 12px 26px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
    }
    .module::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(280px 80px at 20% 10%, rgba(215,181,109,.08), transparent 70%),
        radial-gradient(240px 70px at 85% 85%, rgba(75,255,211,.05), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }

    .moduleHd{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
      position:relative;
      z-index:2;
    }
    .moduleHd b{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(123,231,255,.88);
    }
    .moduleHd .mini{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 900;
      padding: 9px 10px;
      border-radius: 14px;
      transition: transform .08s ease, filter .18s ease, background .18s ease;
      user-select:none;
      white-space:nowrap;
      position:relative;
      z-index:2;
    }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      color:#07101f;
      background: linear-gradient(180deg, rgba(123,231,255,.95), rgba(45,125,255,.92));
      box-shadow: 0 0 0 1px rgba(255,255,255,.14) inset, 0 12px 22px rgba(0,0,0,.34);
    }
    .btnGhost{
      color: rgba(234,240,255,.88);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 1px rgba(0,0,0,.16) inset;
    }
    .btnDanger{
      color: rgba(255,90,90,.95);
      background: rgba(255,90,90,.08);
      border: 1px solid rgba(255,90,90,.22);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
    }
    .btnGhost:hover,.btnPrimary:hover{ filter: brightness(1.05); }

    .moduleBd{
      padding: 12px;
      display:grid;
      gap: 10px;
      position:relative;
      z-index:2;
    }

    label{
      display:block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: rgba(234,240,255,.70);
      margin: 0 0 6px 0;
    }
    input[type="text"], input[type="datetime-local"], select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(7,11,26,.35);
      color: var(--ink);
      padding: 10px 10px;
      outline:none;
      font-family: var(--mono);
      font-size: 13px;
      transition: box-shadow .15s ease, border-color .15s ease;
      position:relative;
      z-index:2;
    }
    input[type="text"]:focus, input[type="datetime-local"]:focus, select:focus, textarea:focus{
      border-color: rgba(123,231,255,.30);
      box-shadow: 0 0 0 4px rgba(45,125,255,.18);
    }
    textarea{ min-height: 120px; resize: vertical; }

    /* Checklist */
    .checkTop{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .checkTop input{ flex:1; min-width: 180px; }
    .checkTop .btn{ flex: 0 0 auto; }
    .checkMetaRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 2px;
    }
    .checkMetaRow .pillMini{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.74);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 7px 10px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .checkMetaRow .pillMini b{ color: rgba(234,240,255,.92); }
    .checkMetaRow .miniInput{
      flex: 1 1 auto;
      min-width: 190px;
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    .checkMetaRow select{
      width:auto;
      min-width: 160px;
      border-radius: 999px;
      padding: 9px 10px;
      font-size: 12px;
    }

    .checkList{
      display:grid;
      gap: 8px;
      margin-top: 2px;
    }

    .checkItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(234,240,255,.86);
      position:relative;
      overflow:hidden;
    }
    .checkItem::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(220px 70px at 25% 15%, rgba(45,125,255,.08), transparent 70%),
        radial-gradient(240px 90px at 75% 85%, rgba(75,255,211,.05), transparent 70%);
      opacity:.65;
      pointer-events:none;
    }
    .checkItem > *{ position:relative; z-index:2; }

    .checkItem input[type="checkbox"]{
      width: 18px; height: 18px;
      margin-top: 2px;
      accent-color: var(--cyan);
      flex: 0 0 auto;
    }

    .dragHandle{
      width: 18px;
      height: 18px;
      margin-top: 2px;
      flex: 0 0 auto;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: grab;
      opacity:.9;
      user-select:none;
    }
    .dragHandle:active{ cursor: grabbing; }
    .dots{
      width: 10px; height: 12px;
      background:
        radial-gradient(circle at 2px 2px, rgba(234,240,255,.72) 1px, transparent 2px),
        radial-gradient(circle at 8px 2px, rgba(234,240,255,.72) 1px, transparent 2px),
        radial-gradient(circle at 2px 6px, rgba(234,240,255,.72) 1px, transparent 2px),
        radial-gradient(circle at 8px 6px, rgba(234,240,255,.72) 1px, transparent 2px),
        radial-gradient(circle at 2px 10px, rgba(234,240,255,.72) 1px, transparent 2px),
        radial-gradient(circle at 8px 10px, rgba(234,240,255,.72) 1px, transparent 2px);
      opacity:.75;
    }

    .checkMain{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .checkLine{
      display:flex;
      gap: 8px;
      align-items:flex-start;
      min-width:0;
    }
    .checkItem .txt{
      flex:1;
      line-height:1.25;
      word-break: break-word;
      min-width:0;
    }

    .badgeRow{
      display:flex;
      gap: 6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.80);
      white-space:nowrap;
    }
    .badge.pri{
      border-color: rgba(255,90,90,.26);
      color: rgba(255,140,140,.95);
      background: rgba(255,90,90,.08);
    }
    .badge.due{
      border-color: rgba(215,181,109,.22);
      color: rgba(215,181,109,.95);
      background: rgba(215,181,109,.08);
    }
    .badge.overdue{
      border-color: rgba(255,179,90,.32);
      color: rgba(255,195,140,.98);
      background: rgba(255,179,90,.10);
    }
    .badge.note{
      border-color: rgba(123,231,255,.22);
      color: rgba(123,231,255,.95);
      background: rgba(45,125,255,.10);
    }

    .checkActions{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 2px;
    }
    .iconBtn{
      border:none;
      cursor:pointer;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 900;
      padding: 7px 8px;
      border-radius: 12px;
      color: rgba(234,240,255,.86);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(0,0,0,.14) inset;
      transition: transform .08s ease, filter .18s ease, background .18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:hover{ filter: brightness(1.05); }
    .iconBtn.red{
      color: rgba(255,120,120,.98);
      border-color: rgba(255,90,90,.22);
      background: rgba(255,90,90,.07);
    }
    .iconBtn.gold{
      color: rgba(215,181,109,.98);
      border-color: rgba(215,181,109,.22);
      background: rgba(215,181,109,.07);
    }
    .iconBtn.blue{
      color: rgba(123,231,255,.98);
      border-color: rgba(123,231,255,.22);
      background: rgba(45,125,255,.08);
    }

    .checkItem.done{
      opacity:.68;
      border-color: rgba(255,255,255,.10);
    }
    .checkItem.done .txt{
      text-decoration: line-through;
      color: rgba(183,194,230,.76);
    }

    /* Priority glow (faint red) */
    .checkItem.priority:not(.done){
      border-color: rgba(255,90,90,.22);
      box-shadow:
        0 0 0 1px rgba(255,90,90,.10) inset,
        0 0 18px rgba(255,90,90,.10);
      background:
        radial-gradient(220px 70px at 18% 20%, rgba(255,90,90,.08), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    }

    /* Overdue glow (faint orange) */
    .checkItem.overdue:not(.done){
      border-color: rgba(255,179,90,.26);
      box-shadow:
        0 0 0 1px rgba(255,179,90,.12) inset,
        0 0 22px rgba(255,179,90,.10);
      background:
        radial-gradient(240px 80px at 22% 18%, rgba(255,179,90,.08), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    }
    /* Due soon (subtle brass hint) */
    .checkItem.duesoon:not(.done):not(.overdue){
      border-color: rgba(215,181,109,.20);
      box-shadow:
        0 0 0 1px rgba(215,181,109,.10) inset,
        0 0 16px rgba(215,181,109,.08);
    }

    .checkItem.dragging{
      opacity:.85;
      outline: 2px solid rgba(123,231,255,.28);
      box-shadow: 0 0 0 6px rgba(45,125,255,.16);
    }
    .dropHint{
      outline: 2px dashed rgba(123,231,255,.38);
      outline-offset: 2px;
    }

    .inlineEditRow{
      display:none;
      gap:8px;
      align-items:center;
      margin-top: 6px;
    }
    .inlineEditRow.on{ display:flex; }
    .inlineEditRow input[type="text"]{
      flex: 1;
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .inlineEditRow textarea{
      flex: 1;
      min-height: 72px;
      font-size: 12px;
    }

    .deadlineRow{
      display:none;
      gap:8px;
      align-items:center;
      margin-top: 6px;
      flex-wrap:wrap;
    }
    .deadlineRow.on{ display:flex; }
    .deadlineRow input[type="datetime-local"]{
      flex: 1 1 220px;
      min-width: 220px;
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 12px;
    }

    .tinyHint{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.62);
      line-height:1.25;
      position:relative;
      z-index:2;
    }

    /* Export / import drawer */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 18px;
    }
    .modal{
      width: min(860px, 96vw);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.88));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 24px 80px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHd{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHd b{
      font-family: var(--mono);
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(123,231,255,.90);
    }
    .modalBd{
      padding: 14px;
      display:grid;
      gap: 10px;
    }

    /* Toast */
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      min-width: 280px;
      max-width: 420px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.88));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 12px 12px;
      display:none;
      gap: 10px;
      align-items:flex-start;
      backdrop-filter: blur(10px);
    }
    .toast.on{ display:flex; }
    .toast .t{
      flex: 1;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(234,240,255,.80);
      line-height:1.3;
    }
    .toast .t b{ color: rgba(234,240,255,.95); }
    .toast .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 0 0 auto;
    }

    .footer{
      max-width: 1320px;
      margin: 0 auto;
      padding: 0 16px 26px 16px;
      color: rgba(183,194,230,.72);
      font-family: var(--mono);
      font-size: 11px;
      text-align:center;
      z-index:3;
      position:relative;
    }
  </style>
</head>

<body>
  <!-- Matrix/electric cascade background -->
  <canvas id="matrixBg" aria-hidden="true"></canvas>

  <!-- Atmospheric overlays -->
  <div class="fog" aria-hidden="true"></div>
  <div class="scanlines" aria-hidden="true"></div>

  <!-- Lightning canvas -->
  <canvas id="fxLightning" aria-hidden="true"></canvas>

  <div class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="title">GEFFEN COCKPIT</div>
        <div class="subtitle">Retro-future dashboard • wheel to rotate the ring • “/” focuses search</div>
      </div>

      <form class="searchWrap" action="https://www.google.com/search" method="GET" target="_blank" rel="noopener">
        <div class="lens" aria-hidden="true"></div>
        <input id="googleQ" name="q" type="text" placeholder="Search Google…" autocomplete="off" />
        <button type="submit">SEARCH</button>
      </form>

      <div class="clockBox" aria-label="Clock">
        <div class="clockTop">
          <div class="date" id="dateStr">—</div>
          <div class="time" id="timeStr">—</div>
          <div class="ticks" id="ticksStr">.00</div>
        </div>
        <div class="countdown" id="countdownBox">
          <span>Time until next class:</span> <b id="countdownText">—</b>
        </div>
      </div>
    </div>
  </div>

  <main class="shell">
    <!-- LEFT: Ring bay -->
    <section class="bay" id="bay">
      <div class="trim" aria-hidden="true"></div>

      <div class="bayHeader">
        <div class="h1">
          <b>Navigation Ring</b>
          <span>Scroll your wheel over the ring to rotate. Click a node to launch.</span>
        </div>
        <div class="datePick" aria-label="Select date to view schedule">
          <div style="opacity:.85;">View date</div>
          <div class="datePickRow">
            <input type="date" id="viewDate" />
          </div>
        </div>
      </div>

      <div class="ringStage">
        <div class="ring" id="ring" aria-label="Link ring" tabindex="0">
          <!-- smaller center holo -->
          <div class="holo" id="holo">
            <div class="holoTop">
              <div class="tag" id="holoTag">Daily Schedule</div>
              <div class="sub" id="holoStatus">—</div>
            </div>

            <div class="holoListWrap">
              <div class="timeMarker" id="timeMarker" aria-hidden="true">
                <div class="bar"></div>
                <div class="dot"></div>
                <div class="tag" id="timeMarkerTag">NOW</div>
              </div>
              <div class="holoList" id="holoList" aria-label="Daily schedule">
                <div class="periodCard misc">
                  <div class="t">—</div>
                  <div class="lbl">Enter your schedule on the right.</div>
                </div>
              </div>
            </div>
          </div>
          <!-- nodes inserted by JS -->
        </div>
      </div>

      <div class="energyWrap">
        <div style="width:100%;display:flex;flex-direction:column;align-items:center;">
          <div class="energyBar" aria-label="Energy bar">
            <div class="energyFill" id="energyFill"></div>
          </div>
          <div class="energyMeta">
            <div><b>ENERGY GRID</b> <span id="energyPct">0%</span></div>
            <div id="energyNote">Awaiting schedule…</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Cockpit (Checklist + schedule setup only) -->
    <aside class="cockpit" id="cockpit">
      <div class="cockHeader">
        <div class="left">
          <b>Control Console</b>
          <span>Checklist + schedule entry. Everything saves locally.</span>
        </div>
        <div class="pill"><span class="spark"></span><span id="dayModePill">—</span></div>
      </div>

      <div class="cockBody">
        <!-- CHECKLIST MODULE -->
        <div class="module">
          <div class="moduleHd">
            <b>Checklist</b>
            <div class="mini">
              <button class="btn btnGhost" id="undoBtn" type="button" title="Undo last delete/clear (Ctrl/Cmd+Z)">Undo</button>
              <button class="btn btnGhost" id="clearCheckedBtn" type="button">Clear Done</button>
              <button class="btn btnGhost" id="exportChecklistBtn" type="button">Export</button>
            </div>
          </div>
          <div class="moduleBd">
            <div class="checkTop">
              <input id="newItemText" type="text" placeholder="Add an agenda item… (Tip: Ctrl/Cmd+P toggles priority on selected item)" />
              <button class="btn btnPrimary" id="addItemBtn" type="button">Add Item</button>
            </div>

            <div class="checkMetaRow">
              <input id="checkSearch" class="miniInput" type="text" placeholder="Search checklist…" />
              <select id="checkFilter">
                <option value="all">Filter: All</option>
                <option value="open">Filter: Open</option>
                <option value="priority">Filter: Priority</option>
                <option value="overdue">Filter: Overdue</option>
                <option value="dueSoon">Filter: Due soon (24h)</option>
                <option value="done">Filter: Done</option>
              </select>
              <select id="checkSort">
                <option value="manual">Sort: Manual</option>
                <option value="priorityThenDue">Sort: Priority → Due</option>
                <option value="dueAsc">Sort: Due (earliest)</option>
                <option value="createdDesc">Sort: Newest</option>
                <option value="createdAsc">Sort: Oldest</option>
              </select>
              <button class="btn btnGhost" id="toggleHideDoneBtn" type="button">Hide Done</button>
              <span class="pillMini" title="Open / Priority / Overdue">
                <b id="checkStats">0 / 0 / 0</b>
              </span>
            </div>

            <div class="checkList" id="checkList"></div>

            <div class="tinyHint" id="checkHint">
              Drag the grip to reorder (manual sort only). Priority items glow faint red. Overdue items glow faint orange.
              Keyboard: Enter adds • Ctrl/Cmd+F focuses search • Ctrl/Cmd+Z undo • ESC exits edit.
            </div>
          </div>
        </div>

        <!-- Portability (schedule + checklist) -->
        <div class="module">
          <div class="moduleHd">
            <b>Portability</b>
            <div class="mini">
              <button class="btn btnGhost" id="exportBtn" type="button">Export</button>
              <button class="btn btnGhost" id="importBtn" type="button">Import</button>
            </div>
          </div>
          <div class="moduleBd">
            <div class="tinyHint">Export gives you JSON for schedule settings + checklist. Import restores it.</div>
          </div>
        </div>

        <!-- Schedule setup (collapsed by default) -->
        <div class="module" id="setupModule">
          <div class="moduleHd">
            <b>Schedule Setup</b>
            <div class="mini">
              <button class="btn btnGhost" id="toggleSetup" type="button">Expand</button>
              <button class="btn btnPrimary" id="saveScheduleBtn" type="button">Save</button>
            </div>
          </div>
          <div class="moduleBd" id="setupBody" style="display:none;">
            <div style="display:grid;gap:10px;">
              <div>
                <label>Blue anchor date</label>
                <input id="blueAnchor" type="text" placeholder="YYYY-MM-DD (a Monday you know is Blue)" />
                <div class="tinyHint">Used for Auto week mode when rendering the schedule in the center of the ring.</div>
              </div>
              <div>
                <label>Office hours on H block</label>
                <select id="officeHoursMode">
                  <option value="none">None</option>
                  <option value="blue">Blue week only</option>
                  <option value="gold">Gold week only</option>
                  <option value="both">Both weeks</option>
                </select>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>A block name</label><input id="A" type="text" placeholder="e.g., Global History 10" /></div>
                <div><label>B block name</label><input id="B" type="text" placeholder="e.g., Advanced ME History" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>C block name</label><input id="C" type="text" /></div>
                <div><label>D block name</label><input id="D" type="text" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>E block name</label><input id="E" type="text" /></div>
                <div><label>F block name</label><input id="F" type="text" /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>G block name</label><input id="G" type="text" /></div>
                <div><label>H block name</label><input id="H" type="text" /></div>
              </div>

              <div class="tinyHint" style="margin-top:4px;">Optional: set per-block links (e.g., Google Drive folders). Named class periods become clickable.</div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>A block link</label><input id="linkA" type="text" placeholder="https://..." /></div>
                <div><label>B block link</label><input id="linkB" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>C block link</label><input id="linkC" type="text" placeholder="https://..." /></div>
                <div><label>D block link</label><input id="linkD" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>E block link</label><input id="linkE" type="text" placeholder="https://..." /></div>
                <div><label>F block link</label><input id="linkF" type="text" placeholder="https://..." /></div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div><label>G block link</label><input id="linkG" type="text" placeholder="https://..." /></div>
                <div><label>H block link</label><input id="linkH" type="text" placeholder="https://..." /></div>
              </div>

              <div class="tinyHint">Once saved, the center holo shows the schedule for the selected date. The “NOW” marker slides through today’s schedule.</div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Export/Import Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Export/Import">
      <div class="modalHd">
        <b id="modalTitle">Export</b>
        <button class="btn btnGhost" id="closeModal" type="button">Close</button>
      </div>
      <div class="modalBd">
        <div class="tinyHint" id="modalHint">Copy this JSON to move your setup to another computer.</div>
        <textarea id="jsonBox" spellcheck="false"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnGhost" id="copyJsonBtn" type="button">Copy</button>
          <button class="btn btnPrimary" id="applyJsonBtn" type="button" style="display:none;">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="t" id="toastText">—</div>
    <div class="actions" id="toastActions">
      <button class="iconBtn blue" id="toastUndo" type="button">UNDO</button>
      <button class="iconBtn" id="toastClose" type="button">OK</button>
    </div>
  </div>

  <div class="footer">
    Wheel rotates the ring • Schedule + checklist saved in your browser (localStorage) • Export JSON for portability
  </div>

  <script>
    /************************************************************
     * LINKS (ring nodes)
     ************************************************************/
    const links = [
      { label:"Discussion Tracker", sub:"class-discussion", href:"https://amhagler.github.io/class-discussion/", glyph:"DT" },
      { label:"Seating Chart", sub:"SC", href:"https://amhagler.github.io/SC/", glyph:"SC" },
      { label:"Rubric", sub:"rubric", href:"https://amhagler.github.io/rubric/", glyph:"RB" },
      { label:"Unit Calendar", sub:"uc", href:"https://amhagler.github.io/uc/", glyph:"UC" },
      { label:"Mafia", sub:"mafia", href:"https://amhagler.github.io/mafia/", glyph:"MF" },
      { label:"Trivia", sub:"tr", href:"https://amhagler.github.io/tr/", glyph:"TR" },
      { label:"Portal", sub:"myschoolapp login", href:"https://geffenacademy.myschoolapp.com/app#login", glyph:"PT" },
      { label:"Gradebook", sub:"SIS gradebook", href:"https://geffenacademy.myschoolapp.com/sis-gradebook/gradebook/27966135?svcid=edu&addin=1", glyph:"GB" },
    ];

    const ring = document.getElementById("ring");
    let rotation = 0; // radians
    let targetRotation = 0;

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildNodes(){
      ring.querySelectorAll(".node").forEach(n => n.remove());
      links.forEach((l, idx) => {
        const node = document.createElement("div");
        node.className = "node";
        node.dataset.idx = String(idx);
        node.innerHTML = `
          <a class="cardLink" href="${l.href}" target="_blank" rel="noopener" aria-label="${escapeHtml(l.label)}">
            <div class="glyph">${escapeHtml(l.glyph)}</div>
            <div class="cardTitle">${escapeHtml(l.label)}</div>
            <div class="cardSub">${escapeHtml(l.sub)}</div>
          </a>
        `;
        ring.appendChild(node);
      });
    }
    buildNodes();

    function computeOrbitRadius(){
      const cs = getComputedStyle(document.documentElement);
      const nodeW = parseFloat(cs.getPropertyValue("--nodeW")) || 132;
      const ringPad = parseFloat(cs.getPropertyValue("--ringPad")) || 40;
      const w = ring.clientWidth || 600;
      const half = w / 2;
      return Math.max(160, half - (nodeW / 2) - ringPad);
    }

    function layoutNodes(){
      const nodes = Array.from(ring.querySelectorAll(".node"));
      const r = computeOrbitRadius();
      const n = nodes.length;
      for (let i = 0; i < n; i++){
        const theta = (Math.PI * 2) * (i / n) + rotation;
        const x = Math.cos(theta) * r;
        const y = Math.sin(theta) * r;
        nodes[i].style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      }
    }

    ring.addEventListener("wheel", (e) => {
      e.preventDefault();
      targetRotation += (e.deltaY || 0) * 0.0022;
    }, { passive:false });

    function animateRing(){
      rotation += (targetRotation - rotation) * 0.10;
      layoutNodes();
      requestAnimationFrame(animateRing);
    }
    animateRing();

    /************************************************************
     * CLOCK (hundredths) + countdown to next class
     ************************************************************/
    const dateStr = document.getElementById("dateStr");
    const timeStr = document.getElementById("timeStr");
    const ticksStr = document.getElementById("ticksStr");
    const countdownBox = document.getElementById("countdownBox");
    const countdownText = document.getElementById("countdownText");

    function pad2(n){ return String(n).padStart(2,"0"); }
    function isoDate(d){
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      return `${y}-${m}-${da}`;
    }

    function tickClock(){
      const now = new Date();
      dateStr.textContent = isoDate(now);
      timeStr.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
      ticksStr.textContent = `.${pad2(Math.floor(now.getMilliseconds()/10))}`;
      requestAnimationFrame(tickClock);
    }
    tickClock();

    /************************************************************
     * SCHEDULE DATA (Blue/Gold)
     ************************************************************/
    const blueWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"F" },
        { time:"10:20-11:15", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"D" },
        { time:"10:15-11:10", block:"E" },
        { time:"11:20-12:15", block:"F" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"G" },
        { time:"2:10-3:05", block:"A" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"B" },
        { time:"10:15-11:10", block:"C" },
        { time:"11:20-12:15", block:"D" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"E" },
        { time:"2:10-3:05", block:"F" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"G" },
        { time:"10:00-10:55", block:"A" },
        { time:"11:05-12:00", block:"B" },
        { time:"12:00-1:05", block:"MS/US SuperLunch +Affinity Groups" },
        { time:"1:10-2:05", block:"C" },
        { time:"2:10-3:05", block:"D" },
        { time:"3:10-3:50", block:"H/X1" }
      ]
    };

    const goldWeek = {
      monday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"E" },
        { time:"10:15-11:10", block:"F" },
        { time:"11:20-12:15", block:"G" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"A" },
        { time:"2:10-3:05", block:"B" },
        { time:"3:10-3:50", block:"H" }
      ],
      tuesday: [
        { time:"9:00-9:20", block:"Bulletin" },
        { time:"9:20-10:15", block:"C" },
        { time:"10:20-11:15", block:"D" },
        { time:"11:20-12:15", block:"E" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"F" },
        { time:"2:10-3:05", block:"G" },
        { time:"3:10-3:50", block:"H" }
      ],
      wednesday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"A" },
        { time:"10:15-11:10", block:"B" },
        { time:"11:20-12:15", block:"C" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"D" },
        { time:"2:10-3:05", block:"E" },
        { time:"3:10-3:50", block:"H" }
      ],
      thursday: [
        { time:"9:00-9:15", block:"Reading Period" },
        { time:"9:15-10:10", block:"F" },
        { time:"10:15-11:10", block:"G" },
        { time:"11:20-12:15", block:"A" },
        { time:"12:15-1:05", block:"MS/US Lunch +MS/US Clubs" },
        { time:"1:10-2:05", block:"B" },
        { time:"2:10-3:05", block:"C" },
        { time:"3:10-3:50", block:"H" }
      ],
      friday: [
        { time:"8:00-8:50", block:"Educators’ Mtg." },
        { time:"9:00-9:55", block:"D" },
        { time:"10:00-10:55", block:"E" },
        { time:"11:00-11:45", block:"H" },
        { time:"11:45-12:35", block:"MS/US Lunch +MS/US Clubs" },
        { time:"12:40-1:35", block:"F" },
        { time:"1:40-2:35", block:"G" },
        { time:"2:40-3:20", block:"X3" }
      ]
    };

    const scheduleByWeek = { blue: blueWeek, gold: goldWeek };
    const dayKeys = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];

    function parseTimeToMinutes(t){
      const [hh, mm] = t.split(":").map(Number);
      let h = hh;
      // treat 1–6 as PM (school schedule convention)
      if (h >= 1 && h <= 6) h += 12;
      return h * 60 + (mm||0);
    }
    function parseRange(range){
      const parts = range.split("-");
      if (parts.length !== 2) return null;
      return { start: parseTimeToMinutes(parts[0].trim()), end: parseTimeToMinutes(parts[1].trim()) };
    }

    /************************************************************
     * LOCAL STORAGE STATE (schedule + checklist + per-block links)
     ************************************************************/
    const LS_KEY = "geffen_cockpit_v5";

    const defaultState = {
      blueAnchor: "",
      officeHoursMode: "none",
      blocks: { A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"" },
      links:  { A:"",B:"",C:"",D:"",E:"",F:"",G:"",H:"" },
      viewDate: "",
      checklistPrefs: {
        filter: "all",
        sort: "manual",
        hideDone: false,
        search: ""
      },
      checklist: []
      // items: { id, text, done, priority, deadline, notes, createdAt, updatedAt }
    };

    function structured(obj){ return (typeof structuredClone === "function") ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)); }

    function loadAnyState(){
      // Try v5, then v4 (your prior key), then fallback.
      const tryKeys = [LS_KEY, "geffen_cockpit_v4"];
      for (const k of tryKeys){
        try{
          const raw = localStorage.getItem(k);
          if (!raw) continue;
          const obj = JSON.parse(raw);
          return { key:k, obj };
        }catch(e){}
      }
      return { key:null, obj:null };
    }

    function migrateChecklistItems(list){
      const now = Date.now();
      if (!Array.isArray(list)) return [];
      return list.map(it => {
        // v4: {id,text,done}
        return {
          id: String(it.id || uid()),
          text: String(it.text || "").trim(),
          done: !!it.done,
          priority: !!it.priority,
          deadline: it.deadline ? String(it.deadline) : "",
          notes: it.notes ? String(it.notes) : "",
          createdAt: Number(it.createdAt || now),
          updatedAt: Number(it.updatedAt || now)
        };
      }).filter(it => it.text.length > 0);
    }

    function loadState(){
      const found = loadAnyState();
      if (!found.obj) return structured(defaultState);

      const obj = found.obj;
      const merged = {
        ...structured(defaultState),
        ...obj,
        blocks: { ...structured(defaultState.blocks), ...(obj.blocks||{}) },
        links:  { ...structured(defaultState.links),  ...(obj.links||{}) },
        checklistPrefs: { ...structured(defaultState.checklistPrefs), ...(obj.checklistPrefs||{}) },
        checklist: migrateChecklistItems(obj.checklist)
      };

      // If we loaded v4, persist into v5 so future loads are clean.
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(merged));
      }catch(e){}
      return merged;
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /************************************************************
     * UI refs
     ************************************************************/
    const dayModePill = document.getElementById("dayModePill");
    const viewDateEl = document.getElementById("viewDate");

    const holoList = document.getElementById("holoList");
    const holoStatus = document.getElementById("holoStatus");
    const holoTag = document.getElementById("holoTag");

    const timeMarker = document.getElementById("timeMarker");
    const timeMarkerTag = document.getElementById("timeMarkerTag");

    const energyFill = document.getElementById("energyFill");
    const energyPct = document.getElementById("energyPct");
    const energyNote = document.getElementById("energyNote");

    // checklist
    const newItemText = document.getElementById("newItemText");
    const addItemBtn = document.getElementById("addItemBtn");
    const clearCheckedBtn = document.getElementById("clearCheckedBtn");
    const exportChecklistBtn = document.getElementById("exportChecklistBtn");
    const checkListEl = document.getElementById("checkList");
    const checkSearchEl = document.getElementById("checkSearch");
    const checkFilterEl = document.getElementById("checkFilter");
    const checkSortEl = document.getElementById("checkSort");
    const toggleHideDoneBtn = document.getElementById("toggleHideDoneBtn");
    const checkStatsEl = document.getElementById("checkStats");
    const checkHintEl = document.getElementById("checkHint");
    const undoBtn = document.getElementById("undoBtn");

    // schedule setup
    const blueAnchorEl = document.getElementById("blueAnchor");
    const officeHoursModeEl = document.getElementById("officeHoursMode");
    const blockEls = ["A","B","C","D","E","F","G","H"].reduce((acc,k)=>{
      acc[k] = document.getElementById(k);
      return acc;
    }, {});
    const linkEls = ["A","B","C","D","E","F","G","H"].reduce((acc,k)=>{
      acc[k] = document.getElementById("link"+k);
      return acc;
    }, {});
    const saveScheduleBtn = document.getElementById("saveScheduleBtn");
    const toggleSetupBtn = document.getElementById("toggleSetup");
    const setupBody = document.getElementById("setupBody");

    // export/import
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalHint = document.getElementById("modalHint");
    const jsonBox = document.getElementById("jsonBox");
    const closeModal = document.getElementById("closeModal");
    const copyJsonBtn = document.getElementById("copyJsonBtn");
    const applyJsonBtn = document.getElementById("applyJsonBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");

    // toast
    const toast = document.getElementById("toast");
    const toastText = document.getElementById("toastText");
    const toastUndo = document.getElementById("toastUndo");
    const toastClose = document.getElementById("toastClose");

    function isValidISODate(s){
      return /^\d{4}-\d{2}-\d{2}$/.test(s);
    }

    function hydrateSetupUI(){
      blueAnchorEl.value = state.blueAnchor || "";
      officeHoursModeEl.value = state.officeHoursMode || "none";
      for (const k of Object.keys(blockEls)){
        blockEls[k].value = state.blocks[k] || "";
      }
      for (const k of Object.keys(linkEls)){
        linkEls[k].value = state.links[k] || "";
      }
    }
    hydrateSetupUI();

    const todayISO = isoDate(new Date());
    if (!isValidISODate(state.viewDate)) state.viewDate = todayISO;
    viewDateEl.value = state.viewDate;

    function setViewDate(val){
      if (!isValidISODate(val)) return;
      state.viewDate = val;
      saveState();
      viewDateEl.value = val;
      renderCenterScheduleAndTimers();
    }
    viewDateEl.addEventListener("change", (e)=> setViewDate(e.target.value));

    saveScheduleBtn.addEventListener("click", () => {
      state.blueAnchor = (blueAnchorEl.value || "").trim();
      state.officeHoursMode = officeHoursModeEl.value;
      for (const k of Object.keys(blockEls)){
        state.blocks[k] = (blockEls[k].value || "").trim();
      }
      for (const k of Object.keys(linkEls)){
        state.links[k] = (linkEls[k].value || "").trim();
      }
      saveState();
      renderCenterScheduleAndTimers();
      flashPill("Saved");
    });

    let setupCollapsed = true;
    toggleSetupBtn.addEventListener("click", () => {
      setupCollapsed = !setupCollapsed;
      setupBody.style.display = setupCollapsed ? "none" : "";
      toggleSetupBtn.textContent = setupCollapsed ? "Expand" : "Collapse";
    });

    function flashPill(msg){
      const old = dayModePill.textContent;
      dayModePill.textContent = msg;
      setTimeout(()=> dayModePill.textContent = old, 900);
    }

    /************************************************************
     * Checklist upgrades
     * - reorder (drag + up/down)
     * - priority flag (faint red glow)
     * - deadlines (date+time) + overdue glow (faint orange)
     *
     * Plus additional upgrades implemented:
     * - inline edit text
     * - notes
     * - delete w/ undo + clear done w/ undo
     * - filter + search + sort modes
     * - hide done toggle
     * - stats pill
     ************************************************************/
    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function toLocalInputValueFromISO(iso){
      // ISO could be "2026-02-23T15:30" or full Date string; normalize.
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    function toISOFromLocalInputValue(v){
      // v is like "2026-02-23T15:30"
      if (!v) return "";
      const d = new Date(v);
      if (isNaN(d.getTime())) return "";
      return d.toISOString();
    }
    function formatDueShort(iso){
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const now = new Date();
      const sameYear = d.getFullYear() === now.getFullYear();
      const md = `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}${sameYear ? "" : ("/"+String(d.getFullYear()).slice(2))}`;
      let h = d.getHours();
      const am = h < 12;
      h = h % 12; if (h === 0) h = 12;
      const t = `${h}:${pad2(d.getMinutes())}${am ? "a" : "p"}`;
      return `${md} ${t}`;
    }
    function isOverdue(item){
      if (!item.deadline) return false;
      if (item.done) return false;
      const d = new Date(item.deadline);
      if (isNaN(d.getTime())) return false;
      return Date.now() > d.getTime();
    }
    function isDueSoon(item, withinHours=24){
      if (!item.deadline) return false;
      if (item.done) return false;
      const d = new Date(item.deadline);
      if (isNaN(d.getTime())) return false;
      const dt = d.getTime() - Date.now();
      return dt > 0 && dt <= withinHours*60*60*1000;
    }

    let lastUndo = null; // { type:"deleteOne"|"clearDone", payload, when }
    function setUndo(obj){
      lastUndo = obj;
      undoBtn.disabled = !lastUndo;
      if (undoBtn.disabled) undoBtn.style.opacity = .55;
      else undoBtn.style.opacity = 1;
    }
    setUndo(null);

    let toastTimer = null;
    function showToast(message, allowUndo=true){
      toastText.innerHTML = message;
      toast.classList.add("on");
      toastUndo.style.display = allowUndo ? "" : "none";

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toast.classList.remove("on");
      }, 4200);
    }
    function hideToast(){
      toast.classList.remove("on");
      clearTimeout(toastTimer);
    }
    toastClose.addEventListener("click", hideToast);

    function applyUndo(){
      if (!lastUndo) return;
      if (lastUndo.type === "deleteOne"){
        // reinsert at original index (best effort)
        const { item, index } = lastUndo.payload;
        const idx = Math.max(0, Math.min(state.checklist.length, index));
        state.checklist.splice(idx, 0, item);
      } else if (lastUndo.type === "clearDone"){
        // merge back: put cleared items back at their original indices in reverse order
        const { removed } = lastUndo.payload; // array of {item,index}
        removed
          .slice()
          .sort((a,b)=>a.index-b.index)
          .forEach(({item,index})=>{
            const idx = Math.max(0, Math.min(state.checklist.length, index));
            state.checklist.splice(idx, 0, item);
          });
      }
      saveState();
      setUndo(null);
      renderChecklist();
      showToast(`<b>Undo</b> restored.`, false);
    }

    toastUndo.addEventListener("click", () => { applyUndo(); hideToast(); });
    undoBtn.addEventListener("click", () => applyUndo());

    // preferences hydrate
    function hydrateChecklistPrefsUI(){
      checkSearchEl.value = state.checklistPrefs.search || "";
      checkFilterEl.value = state.checklistPrefs.filter || "all";
      checkSortEl.value = state.checklistPrefs.sort || "manual";
      toggleHideDoneBtn.textContent = (state.checklistPrefs.hideDone ? "Show Done" : "Hide Done");
    }
    hydrateChecklistPrefsUI();

    checkSearchEl.addEventListener("input", () => {
      state.checklistPrefs.search = checkSearchEl.value || "";
      saveState();
      renderChecklist();
    });
    checkFilterEl.addEventListener("change", () => {
      state.checklistPrefs.filter = checkFilterEl.value;
      saveState();
      renderChecklist();
    });
    checkSortEl.addEventListener("change", () => {
      state.checklistPrefs.sort = checkSortEl.value;
      saveState();
      renderChecklist();
    });
    toggleHideDoneBtn.addEventListener("click", () => {
      state.checklistPrefs.hideDone = !state.checklistPrefs.hideDone;
      toggleHideDoneBtn.textContent = (state.checklistPrefs.hideDone ? "Show Done" : "Hide Done");
      saveState();
      renderChecklist();
    });

    function computeStats(){
      const open = state.checklist.filter(it => !it.done).length;
      const pri = state.checklist.filter(it => !it.done && it.priority).length;
      const over = state.checklist.filter(it => isOverdue(it)).length;
      checkStatsEl.textContent = `${open} / ${pri} / ${over}`;
    }

    function normalizeChecklistItem(it){
      const now = Date.now();
      return {
        id: String(it.id || uid()),
        text: String(it.text || "").trim(),
        done: !!it.done,
        priority: !!it.priority,
        deadline: it.deadline ? String(it.deadline) : "",
        notes: it.notes ? String(it.notes) : "",
        createdAt: Number(it.createdAt || now),
        updatedAt: Number(it.updatedAt || now)
      };
    }

    function addChecklistItem(text){
      const t = (text || "").trim();
      if (!t) return;
      const now = Date.now();
      state.checklist.unshift({
        id: uid(),
        text: t,
        done: false,
        priority: false,
        deadline: "",
        notes: "",
        createdAt: now,
        updatedAt: now
      });
      saveState();
      newItemText.value = "";
      renderChecklist();
    }

    addItemBtn.addEventListener("click", ()=> addChecklistItem(newItemText.value));
    newItemText.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        addChecklistItem(newItemText.value);
      }
    });

    clearCheckedBtn.addEventListener("click", ()=>{
      const removed = [];
      const kept = [];
      state.checklist.forEach((it, idx)=>{
        if (it.done) removed.push({ item: it, index: idx });
        else kept.push(it);
      });
      state.checklist = kept;
      saveState();
      setUndo(removed.length ? { type:"clearDone", payload:{ removed }, when: Date.now() } : null);
      renderChecklist();
      if (removed.length){
        showToast(`<b>Cleared</b> ${removed.length} done item${removed.length===1?"":"s"}.`);
      } else {
        showToast(`Nothing to clear.`, false);
      }
    });

    exportChecklistBtn.addEventListener("click", () => {
      // export only checklist (convenient)
      openModal("exportChecklist");
    });

    // Drag & drop reorder (manual sort only)
    let dragId = null;
    function canManualReorder(){
      return (state.checklistPrefs.sort || "manual") === "manual"
        && (state.checklistPrefs.filter || "all") === "all"
        && !(state.checklistPrefs.search || "").trim()
        && !state.checklistPrefs.hideDone;
    }

    function moveItemById(id, toIndex){
      const fromIndex = state.checklist.findIndex(it => it.id === id);
      if (fromIndex < 0) return;
      const item = state.checklist.splice(fromIndex, 1)[0];
      const idx = Math.max(0, Math.min(state.checklist.length, toIndex));
      state.checklist.splice(idx, 0, item);
      saveState();
    }

    function compareByDue(a,b){
      const ad = a.deadline ? new Date(a.deadline).getTime() : Infinity;
      const bd = b.deadline ? new Date(b.deadline).getTime() : Infinity;
      if (ad !== bd) return ad - bd;
      return (b.createdAt||0) - (a.createdAt||0);
    }

    function filteredSortedList(){
      const prefs = state.checklistPrefs || {};
      const q = (prefs.search || "").trim().toLowerCase();
      const filter = prefs.filter || "all";
      const sort = prefs.sort || "manual";
      const hideDone = !!prefs.hideDone;

      let list = state.checklist.slice().map(normalizeChecklistItem);

      if (hideDone) list = list.filter(it => !it.done);

      if (q){
        list = list.filter(it => {
          const hay = `${it.text} ${it.notes||""}`.toLowerCase();
          return hay.includes(q);
        });
      }

      if (filter === "open") list = list.filter(it => !it.done);
      else if (filter === "done") list = list.filter(it => it.done);
      else if (filter === "priority") list = list.filter(it => !it.done && it.priority);
      else if (filter === "overdue") list = list.filter(it => isOverdue(it));
      else if (filter === "dueSoon") list = list.filter(it => isDueSoon(it, 24));

      if (sort === "dueAsc"){
        list.sort((a,b)=> compareByDue(a,b));
      } else if (sort === "priorityThenDue"){
        list.sort((a,b)=>{
          const ap = (!a.done && a.priority) ? 1 : 0;
          const bp = (!b.done && b.priority) ? 1 : 0;
          if (ap !== bp) return bp - ap;
          return compareByDue(a,b);
        });
      } else if (sort === "createdDesc"){
        list.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      } else if (sort === "createdAsc"){
        list.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
      } // manual: keep as-is

      return list;
    }

    function updateChecklistHint(){
      const ok = canManualReorder();
      checkHintEl.innerHTML = ok
        ? `Drag the grip to reorder. Priority items glow faint red. Overdue items glow faint orange.`
          + ` Keyboard: Enter adds • Ctrl/Cmd+F focuses search • Ctrl/Cmd+Z undo • ESC exits edit.`
        : `Reorder is available only when <b>Sort: Manual</b>, <b>Filter: All</b>, Search is empty, and Done is visible.`
          + ` (This prevents accidental reordering in a filtered view.)`;
    }

    function renderChecklist(){
      computeStats();
      updateChecklistHint();

      checkListEl.innerHTML = "";
      const view = filteredSortedList();
      if (!view.length){
        const empty = document.createElement("div");
        empty.className = "tinyHint";
        empty.textContent = state.checklist.length ? "No matches (adjust filter/search)." : "No items yet. Add one above.";
        checkListEl.appendChild(empty);
        return;
      }

      const manualOk = canManualReorder();

      // Map from id -> absolute index in base list (needed for undo + moves)
      const baseIndex = new Map();
      state.checklist.forEach((it, idx)=> baseIndex.set(it.id, idx));

      view.forEach((item) => {
        const overdue = isOverdue(item);
        const dueSoon = isDueSoon(item, 24);

        const row = document.createElement("div");
        row.className =
          "checkItem"
          + (item.done ? " done" : "")
          + (item.priority ? " priority" : "")
          + (overdue ? " overdue" : "")
          + (!overdue && dueSoon ? " duesoon" : "");

        row.draggable = manualOk;
        row.dataset.id = item.id;

        const dueLabel = item.deadline ? formatDueShort(item.deadline) : "";
        const hasNote = (item.notes || "").trim().length > 0;

        row.innerHTML = `
          <div class="dragHandle" title="${manualOk ? "Drag to reorder" : "Reorder locked (change filter/sort)"}" aria-hidden="true">
            <div class="dots"></div>
          </div>
          <input type="checkbox" ${item.done ? "checked" : ""} aria-label="Toggle item">
          <div class="checkMain">
            <div class="checkLine">
              <div class="txt"></div>
              <div class="checkActions">
                <button class="iconBtn red" data-act="priority" type="button" title="Toggle priority">PRI</button>
                <button class="iconBtn gold" data-act="deadline" type="button" title="Set deadline">DUE</button>
                <button class="iconBtn blue" data-act="note" type="button" title="Add note">NOTE</button>
                <button class="iconBtn" data-act="edit" type="button" title="Edit text">EDIT</button>
                <button class="iconBtn red" data-act="del" type="button" title="Delete">DEL</button>
              </div>
            </div>
            <div class="badgeRow">
              ${item.priority && !item.done ? `<span class="badge pri">PRIORITY</span>` : ``}
              ${dueLabel && !overdue ? `<span class="badge due">DUE ${escapeHtml(dueLabel)}</span>` : ``}
              ${dueLabel && overdue ? `<span class="badge overdue">OVERDUE ${escapeHtml(dueLabel)}</span>` : ``}
              ${hasNote ? `<span class="badge note">NOTE</span>` : ``}
            </div>

            <div class="deadlineRow" data-row="deadline">
              <input type="datetime-local" value="${escapeHtml(toLocalInputValueFromISO(item.deadline))}">
              <button class="iconBtn gold" data-act="saveDeadline" type="button">SAVE</button>
              <button class="iconBtn" data-act="clearDeadline" type="button">CLEAR</button>
              <button class="iconBtn" data-act="cancelDeadline" type="button">CLOSE</button>
            </div>

            <div class="inlineEditRow" data-row="edit">
              <input type="text" value="${escapeHtml(item.text)}" />
              <button class="iconBtn blue" data-act="saveEdit" type="button">SAVE</button>
              <button class="iconBtn" data-act="cancelEdit" type="button">CLOSE</button>
            </div>

            <div class="inlineEditRow" data-row="note">
              <textarea placeholder="Notes (optional)…">${escapeHtml(item.notes||"")}</textarea>
              <button class="iconBtn blue" data-act="saveNote" type="button">SAVE</button>
              <button class="iconBtn" data-act="cancelNote" type="button">CLOSE</button>
            </div>

            <div class="checkActions" style="justify-content:flex-start; gap:6px;">
              <button class="iconBtn" data-act="up" type="button" ${manualOk ? "" : "disabled"} title="Move up (manual sort only)">▲</button>
              <button class="iconBtn" data-act="down" type="button" ${manualOk ? "" : "disabled"} title="Move down (manual sort only)">▼</button>
            </div>
          </div>
        `;

        row.querySelector(".txt").textContent = item.text;

        // checkbox toggle
        const cb = row.querySelector('input[type="checkbox"]');
        cb.addEventListener("change", () => {
          const idx = state.checklist.findIndex(it => it.id === item.id);
          if (idx < 0) return;
          state.checklist[idx].done = cb.checked;
          state.checklist[idx].updatedAt = Date.now();
          saveState();
          renderChecklist();
        });

        function toggleRowSection(key, on){
          const el = row.querySelector(`[data-row="${key}"]`);
          if (!el) return;
          const isOn = el.classList.contains("on");
          const next = (typeof on === "boolean") ? on : !isOn;
          // close other sections when opening a new one
          ["deadline","edit","note"].forEach(k=>{
            const sec = row.querySelector(`[data-row="${k}"]`);
            if (!sec) return;
            sec.classList.toggle("on", (k===key) ? next : false);
          });
          if (next){
            const focusable = el.querySelector("input,textarea");
            if (focusable) focusable.focus();
          }
        }

        // action buttons
        row.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-act]");
          if (!btn) return;
          const act = btn.dataset.act;

          const idx = state.checklist.findIndex(it => it.id === item.id);
          if (idx < 0) return;

          if (act === "priority"){
            state.checklist[idx].priority = !state.checklist[idx].priority;
            state.checklist[idx].updatedAt = Date.now();
            saveState();
            renderChecklist();
            return;
          }

          if (act === "deadline"){
            toggleRowSection("deadline");
            return;
          }
          if (act === "saveDeadline"){
            const input = row.querySelector('[data-row="deadline"] input[type="datetime-local"]');
            const iso = toISOFromLocalInputValue(input.value);
            state.checklist[idx].deadline = iso;
            state.checklist[idx].updatedAt = Date.now();
            saveState();
            renderChecklist();
            return;
          }
          if (act === "clearDeadline"){
            state.checklist[idx].deadline = "";
            state.checklist[idx].updatedAt = Date.now();
            saveState();
            renderChecklist();
            return;
          }
          if (act === "cancelDeadline"){
            toggleRowSection("deadline", false);
            return;
          }

          if (act === "edit"){
            toggleRowSection("edit");
            return;
          }
          if (act === "saveEdit"){
            const input = row.querySelector('[data-row="edit"] input[type="text"]');
            const t = (input.value || "").trim();
            if (t){
              state.checklist[idx].text = t;
              state.checklist[idx].updatedAt = Date.now();
              saveState();
              renderChecklist();
            } else {
              showToast(`Text can’t be blank.`, false);
            }
            return;
          }
          if (act === "cancelEdit"){
            toggleRowSection("edit", false);
            return;
          }

          if (act === "note"){
            toggleRowSection("note");
            return;
          }
          if (act === "saveNote"){
            const ta = row.querySelector('[data-row="note"] textarea');
            state.checklist[idx].notes = (ta.value || "").trim();
            state.checklist[idx].updatedAt = Date.now();
            saveState();
            renderChecklist();
            return;
          }
          if (act === "cancelNote"){
            toggleRowSection("note", false);
            return;
          }

          if (act === "del"){
            const abs = baseIndex.get(item.id);
            const removed = state.checklist.splice(abs, 1)[0];
            saveState();
            setUndo({ type:"deleteOne", payload:{ item: removed, index: abs }, when: Date.now() });
            renderChecklist();
            showToast(`<b>Deleted</b> 1 item.`);
            return;
          }

          // reorder controls (manual only)
          if (act === "up" && manualOk){
            const abs = state.checklist.findIndex(it => it.id === item.id);
            if (abs > 0){
              const t = state.checklist.splice(abs, 1)[0];
              state.checklist.splice(abs-1, 0, t);
              saveState();
              renderChecklist();
            }
            return;
          }
          if (act === "down" && manualOk){
            const abs = state.checklist.findIndex(it => it.id === item.id);
            if (abs >= 0 && abs < state.checklist.length - 1){
              const t = state.checklist.splice(abs, 1)[0];
              state.checklist.splice(abs+1, 0, t);
              saveState();
              renderChecklist();
            }
            return;
          }
        });

        // ESC closes any open section inside row
        row.addEventListener("keydown", (e)=>{
          if (e.key === "Escape"){
            toggleRowSection("deadline", false);
            toggleRowSection("edit", false);
            toggleRowSection("note", false);
            row.blur?.();
          }
        });

        // Drag/drop handlers
        if (manualOk){
          row.addEventListener("dragstart", (e)=>{
            dragId = item.id;
            row.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
            try{ e.dataTransfer.setData("text/plain", dragId); }catch(err){}
          });
          row.addEventListener("dragend", ()=>{
            dragId = null;
            row.classList.remove("dragging");
            checkListEl.querySelectorAll(".dropHint").forEach(el=>el.classList.remove("dropHint"));
          });
          row.addEventListener("dragover", (e)=>{
            if (!dragId) return;
            e.preventDefault();
            row.classList.add("dropHint");
          });
          row.addEventListener("dragleave", ()=>{
            row.classList.remove("dropHint");
          });
          row.addEventListener("drop", (e)=>{
            e.preventDefault();
            row.classList.remove("dropHint");
            const targetId = item.id;
            if (!dragId || dragId === targetId) return;

            const fromIndex = state.checklist.findIndex(it => it.id === dragId);
            const toIndex = state.checklist.findIndex(it => it.id === targetId);
            if (fromIndex < 0 || toIndex < 0) return;

            // insert before target
            const moving = state.checklist.splice(fromIndex, 1)[0];
            const insertAt = (fromIndex < toIndex) ? (toIndex - 1) : toIndex;
            state.checklist.splice(insertAt, 0, moving);
            saveState();
            renderChecklist();
          });
        }

        checkListEl.appendChild(row);
      });
    }

    // Init prefs if missing
    state.checklistPrefs = { ...structured(defaultState.checklistPrefs), ...(state.checklistPrefs||{}) };
    saveState();
    renderChecklist();

    // Keyboard shortcuts for checklist module
    window.addEventListener("keydown", (e) => {
      const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
      const mod = isMac ? e.metaKey : e.ctrlKey;

      if (mod && e.key.toLowerCase() === "f"){
        // focus checklist search (prefer when not inside google box)
        e.preventDefault();
        checkSearchEl.focus();
      }

      if (mod && e.key.toLowerCase() === "z"){
        e.preventDefault();
        applyUndo();
      }
    });

    /************************************************************
     * Blue/Gold auto mode (anchor-date based)
     ************************************************************/
    function getWeekModeForDate(date){
      if (!isValidISODate(state.blueAnchor)) return null;
      const anchor = new Date(state.blueAnchor + "T00:00:00");
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());

      const toMonday = (x) => {
        const dd = new Date(x.getFullYear(), x.getMonth(), x.getDate());
        const dow = dd.getDay();
        const diff = (dow + 6) % 7;
        dd.setDate(dd.getDate() - diff);
        return dd;
      };

      const aMon = toMonday(anchor);
      const dMon = toMonday(d);

      const weeksDiff = Math.round((dMon - aMon) / (7*24*60*60*1000));
      return (weeksDiff % 2 === 0) ? "blue" : "gold";
    }

    function dayKeyFromDate(d){
      return dayKeys[d.getDay()];
    }

    function isClassBlock(block){
      return ["A","B","C","D","E","F","G","H"].includes(block);
    }

    function blockLabel(block, weekForDate){
      const lunchish = [
        "MS/US Lunch +MS/US Clubs",
        "MS/US SuperLunch +Affinity Groups",
        "H/X1",
        "X3",
        "Educators’ Mtg.",
        "Reading Period",
        "Bulletin"
      ];
      if (lunchish.includes(block)) return { label:block, named:false, blockKey:null };

      if (block === "H"){
        const mode = state.officeHoursMode || "none";
        if ((mode === "both") ||
            (mode === "blue" && weekForDate === "blue") ||
            (mode === "gold" && weekForDate === "gold")){
          return { label:"Office Hours", named:true, blockKey:"H" };
        }
      }
      const hasName = !!(state.blocks[block] && state.blocks[block].trim());
      return { label: hasName ? `${state.blocks[block]} (${block})` : block, named: hasName, blockKey:block };
    }

    function buildPeriodsForDate(dateObj){
      const dk = dayKeyFromDate(dateObj);
      if (dk === "sunday" || dk === "saturday") return { periods: [], week:null, day:dk };

      const week = getWeekModeForDate(dateObj);
      if (!week) return { periods: [], week:null, day:dk };

      const src = scheduleByWeek[week]?.[dk] || [];
      const periods = src.map(p => {
        const range = parseRange(p.time);
        const meta = blockLabel(p.block, week);
        return {
          ...p,
          label: meta.label,
          named: meta.named,
          blockKey: meta.blockKey,
          range
        };
      }).filter(p => p.range);

      return { periods, week, day:dk };
    }

    /************************************************************
     * Center holo schedule + energy + countdown + time marker
     ************************************************************/
    function findNextClass(periods, minutesNow){
      const classes = periods.filter(p => isClassBlock(p.block));
      let best = null;
      for (const p of classes){
        if (p.range.start > minutesNow){
          if (!best || p.range.start < best.range.start) best = p;
        }
      }
      return best;
    }

    function formatCountdown(totalSec){
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return `${m}:${pad2(s)}`;
    }

    function updateCountdown(textOrNull, warn){
      if (textOrNull === null){
        countdownText.textContent = "—";
        countdownBox.classList.remove("warn");
        return;
      }
      countdownText.textContent = textOrNull;
      if (warn) countdownBox.classList.add("warn");
      else countdownBox.classList.remove("warn");
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function renderCenterScheduleAndTimers(){
      const view = new Date(state.viewDate + "T00:00:00");
      const now = new Date();
      const isToday = isoDate(now) === state.viewDate;

      const { periods, week, day } = buildPeriodsForDate(view);
      const dayName = day.charAt(0).toUpperCase() + day.slice(1);
      const weekName = week ? week.toUpperCase() : "—";

      if (!week && (day === "saturday" || day === "sunday")){
        dayModePill.textContent = `Weekend • ${dayName}`;
      } else if (!week){
        dayModePill.textContent = `Auto needs anchor`;
      } else {
        dayModePill.textContent = `${weekName} • ${dayName}`;
      }

      const minutesNow = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;

      holoTag.textContent = `Daily Schedule • ${state.viewDate}`;
      holoStatus.textContent = week ? `${weekName} • ${dayName}` : (dayName);

      // Default: hide time marker unless today & schedule present
      timeMarker.classList.remove("on");

      if (!periods.length){
        holoList.innerHTML = `
          <div class="periodCard misc">
            <div class="t">—</div>
            <div class="lbl">${(day==="saturday"||day==="sunday") ? "Weekend." : "Set Blue anchor date + save block names (and links, if you want)."} </div>
          </div>
        `;
        energyFill.style.width = "0%";
        energyPct.textContent = "0%";
        energyNote.textContent = (day==="saturday"||day==="sunday") ? "Standby" : "Awaiting schedule…";
        updateCountdown(null, false);
        return;
      }

      // render block-cards
      holoList.innerHTML = "";
      const maxShow = Math.min(periods.length, 12);
      for (let i=0; i<maxShow; i++){
        const p = periods[i];
        const isNow = isToday && (minutesNow >= p.range.start && minutesNow < p.range.end);

        const card = document.createElement("div");
        const isMisc = !isClassBlock(p.block);
        const named = !!p.named;

        card.className = "periodCard"
          + (isMisc ? " misc" : "")
          + (!isMisc && named ? " named" : "")
          + (isNow ? " now" : "");

        const link = (p.blockKey && (state.links[p.blockKey] || "").trim()) || "";
        const safeLabel = escapeHtml(p.label);
        const safeTime = escapeHtml(p.time);

        let labelHTML = safeLabel;

        if (!isMisc && named && link){
          // clickable named class period
          labelHTML = `
            <a class="periodLink" href="${escapeHtml(link)}" target="_blank" rel="noopener">
              <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${safeLabel}</span>
              <span class="linkBadge">OPEN</span>
            </a>
          `;
        }

        card.innerHTML = `
          <div class="t">${safeTime}</div>
          <div class="lbl">${labelHTML}</div>
        `;

        holoList.appendChild(card);
      }

      // Energy + countdown (only for today)
      if (!isToday){
        energyFill.style.width = "0%";
        energyPct.textContent = "—";
        energyNote.textContent = "Energy grid is live only for today";
        updateCountdown("—", false);
        return;
      }

      const lastEnd = Math.max(...periods.map(p => p.range.end));
      const firstStart = Math.min(...periods.map(p => p.range.start));
      const clamped = clamp(minutesNow, firstStart, lastEnd);
      const prog = (clamped - firstStart) / (lastEnd - firstStart);
      const pct = Math.round(prog * 100);

      energyFill.style.width = `${pct}%`;
      energyPct.textContent = `${pct}%`;

      if (minutesNow < firstStart) energyNote.textContent = "Pre-start";
      else if (minutesNow >= lastEnd) energyNote.textContent = "Complete";
      else energyNote.textContent = "In progress";

      const next = findNextClass(periods, minutesNow);
      if (!next){
        updateCountdown("No more classes", false);
      } else {
        const deltaSec = Math.max(0, Math.round((next.range.start - minutesNow) * 60));
        const warn = deltaSec > 0 && deltaSec <= 600; // <= 10 minutes
        updateCountdown(formatCountdown(deltaSec), warn);
      }

      // Time marker: slide through visible schedule region
      const listEl = holoList;
      const wrap = listEl.parentElement;
      if (wrap && listEl){
        const totalSpan = (lastEnd - firstStart) || 1;
        const ratio = (clamped - firstStart) / totalSpan;
        const visibleH = listEl.clientHeight;

        const y = ratio * (visibleH - 12) + 10; // small padding
        timeMarker.style.top = `${y}px`;
        timeMarkerTag.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
        timeMarker.classList.add("on");
      }
    }

    setInterval(() => {
      renderCenterScheduleAndTimers();
      // update overdue/dueSoon visuals without needing any interaction
      renderChecklist();
    }, 2500);

    renderCenterScheduleAndTimers();

    /************************************************************
     * Export / Import JSON (schedule + checklist + links)
     ************************************************************/
    function openModal(mode){
      overlay.style.display = "flex";

      if (mode === "export"){
        modalTitle.textContent = "Export";
        modalHint.textContent = "Copy this JSON to move your schedule + links + checklist to another computer.";
        jsonBox.value = JSON.stringify(state, null, 2);
        applyJsonBtn.style.display = "none";
        jsonBox.readOnly = true;
        return;
      }

      if (mode === "exportChecklist"){
        modalTitle.textContent = "Export Checklist";
        modalHint.textContent = "Copy this JSON if you only want to move the checklist.";
        jsonBox.value = JSON.stringify({ checklist: state.checklist, checklistPrefs: state.checklistPrefs }, null, 2);
        applyJsonBtn.style.display = "none";
        jsonBox.readOnly = true;
        return;
      }

      modalTitle.textContent = "Import";
      modalHint.textContent = "Paste JSON exported from this dashboard and click Apply.";
      jsonBox.value = "";
      applyJsonBtn.style.display = "";
      jsonBox.readOnly = false;
    }
    function closeModalFn(){ overlay.style.display = "none"; }

    exportBtn.addEventListener("click", () => openModal("export"));
    importBtn.addEventListener("click", () => openModal("import"));
    closeModal.addEventListener("click", closeModalFn);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModalFn(); });

    copyJsonBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(jsonBox.value);
        flashPill("Copied");
      }catch(e){
        jsonBox.select();
        document.execCommand("copy");
        flashPill("Copied");
      }
    });

    applyJsonBtn.addEventListener("click", () => {
      try{
        const obj = JSON.parse(jsonBox.value);
        if (typeof obj !== "object" || !obj) throw new Error("Invalid JSON");

        // Allow importing a checklist-only file as a convenience
        if (obj.checklist && !obj.blocks && !obj.blueAnchor && !obj.links){
          state.checklist = migrateChecklistItems(obj.checklist);
          state.checklistPrefs = { ...structured(defaultState.checklistPrefs), ...(obj.checklistPrefs||{}) };
          saveState();
          hydrateChecklistPrefsUI();
          renderChecklist();
          renderCenterScheduleAndTimers();
          closeModalFn();
          flashPill("Imported");
          return;
        }

        state = {
          ...structured(defaultState),
          ...obj,
          blocks: { ...structured(defaultState.blocks), ...(obj.blocks||{}) },
          links:  { ...structured(defaultState.links),  ...(obj.links||{}) },
          checklistPrefs: { ...structured(defaultState.checklistPrefs), ...(obj.checklistPrefs||{}) },
          checklist: migrateChecklistItems(obj.checklist)
        };

        if (!isValidISODate(state.viewDate)) state.viewDate = isoDate(new Date());
        saveState();
        hydrateSetupUI();
        hydrateChecklistPrefsUI();
        viewDateEl.value = state.viewDate;
        renderChecklist();
        renderCenterScheduleAndTimers();
        closeModalFn();
        flashPill("Imported");
      }catch(e){
        alert("Import failed. Make sure you pasted valid JSON exported from this dashboard.");
      }
    });

    /************************************************************
     * Google search focus with /
     ************************************************************/
    window.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement !== document.getElementById("googleQ")){
        e.preventDefault();
        document.getElementById("googleQ").focus();
      }
    });

    /************************************************************
     * Resize relayout for ring + canvases
     ************************************************************/
    window.addEventListener("resize", () => {
      layoutNodes();
      resizeMatrix();
      resizeLightning();
    });

    /************************************************************
     * MATRIX / ELECTRIC CASCADE BACKGROUND (canvas)
     ************************************************************/
    const matrixCanvas = document.getElementById("matrixBg");
    const mtx = matrixCanvas.getContext("2d", { alpha:true });

    let matrixCols = [];
    let matrixW = 0, matrixH = 0, matrixDPR = 1;
    let matrixFontPx = 14;
    let matrixStep = 16;

    // “Electric drops”: mix sparse glyphs + droplet chars
    const glyphs = "01░▒▓╌╎╍╏┆┇┊┋⋮⋯⟡⟢⟣⟠⟟⟞·";
    function randGlyph(){
      return glyphs[Math.floor(Math.random() * glyphs.length)];
    }

    function resizeMatrix(){
      matrixDPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      matrixW = Math.floor(window.innerWidth);
      matrixH = Math.floor(window.innerHeight);
      matrixCanvas.width = Math.floor(matrixW * matrixDPR);
      matrixCanvas.height = Math.floor(matrixH * matrixDPR);
      matrixCanvas.style.width = matrixW + "px";
      matrixCanvas.style.height = matrixH + "px";

      mtx.setTransform(matrixDPR,0,0,matrixDPR,0,0);

      // responsive sizing
      matrixFontPx = Math.max(12, Math.min(16, Math.floor(matrixW / 90)));
      matrixStep = Math.floor(matrixFontPx * 1.25);

      const cols = Math.floor(matrixW / matrixStep);
      matrixCols = new Array(cols).fill(0).map(() => ({
        y: Math.random() * matrixH,
        speed: 0.7 + Math.random() * 1.8,
        density: 0.08 + Math.random() * 0.22,
        glow: 0.08 + Math.random() * 0.20
      }));
      mtx.font = `${matrixFontPx}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace`;
    }

    function stepMatrix(){
      // fade with slight tint
      mtx.fillStyle = "rgba(7, 11, 26, 0.08)";
      mtx.fillRect(0,0,matrixW,matrixH);

      for (let i=0; i<matrixCols.length; i++){
        const col = matrixCols[i];
        const x = i * matrixStep;

        // occasionally skip drawing to keep it subtle
        if (Math.random() > col.density) continue;

        const ch = randGlyph();
        const y = col.y;

        // glow layer
        mtx.shadowBlur = 14;
        mtx.shadowColor = `rgba(45,125,255,${0.22 + col.glow})`;
        mtx.fillStyle = `rgba(123,231,255,${0.18 + col.glow})`;
        mtx.fillText(ch, x, y);

        // bright core
        mtx.shadowBlur = 0;
        mtx.fillStyle = `rgba(75,255,211,${0.07 + col.glow * 0.7})`;
        mtx.fillText(ch, x, y);

        col.y += col.speed * matrixStep * 0.22;

        if (col.y > matrixH + 50){
          col.y = -Math.random() * 200;
          col.speed = 0.7 + Math.random() * 1.8;
          col.density = 0.08 + Math.random() * 0.22;
          col.glow = 0.08 + Math.random() * 0.20;
        }
      }
      requestAnimationFrame(stepMatrix);
    }

    resizeMatrix();
    stepMatrix();

    /************************************************************
     * ELECTRIC LIGHTNING (canvas overlay)
     ************************************************************/
    const fxCanvas = document.getElementById("fxLightning");
    const fx = fxCanvas.getContext("2d", { alpha:true });

    let fxW=0, fxH=0, fxDPR=1;
    function resizeLightning(){
      fxDPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      fxW = window.innerWidth;
      fxH = window.innerHeight;
      fxCanvas.width = Math.floor(fxW * fxDPR);
      fxCanvas.height = Math.floor(fxH * fxDPR);
      fxCanvas.style.width = fxW + "px";
      fxCanvas.style.height = fxH + "px";
      fx.setTransform(fxDPR,0,0,fxDPR,0,0);
    }
    resizeLightning();

    function rectOf(el){
      const r = el.getBoundingClientRect();
      return { x:r.left, y:r.top, w:r.width, h:r.height };
    }

    function jitter(n, amt){ return n + (Math.random()*2-1)*amt; }

    function makeBolt(x0,y0,x1,y1,segments=16,spread=18){
      const pts = [];
      for (let i=0;i<=segments;i++){
        const t = i/segments;
        const x = x0 + (x1-x0)*t;
        const y = y0 + (y1-y0)*t;
        // perpendicular jitter
        const dx = x1-x0, dy = y1-y0;
        const len = Math.hypot(dx,dy) || 1;
        const px = -dy/len, py = dx/len;
        const amp = (1 - Math.abs(0.5 - t)*2) * spread; // bigger in middle
        pts.push({
          x: jitter(x + px * (Math.random()*2-1) * amp, 1.8),
          y: jitter(y + py * (Math.random()*2-1) * amp, 1.8)
        });
      }
      return pts;
    }

    function branchFrom(pts, branchChance=0.25){
      if (Math.random() > branchChance) return null;
      const idx = Math.floor(pts.length * (0.35 + Math.random()*0.4));
      const p = pts[idx];
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*90;
      const x1 = p.x + Math.cos(angle)*dist;
      const y1 = p.y + Math.sin(angle)*dist;
      return makeBolt(p.x,p.y,x1,y1, 8+Math.floor(Math.random()*6), 10+Math.random()*10);
    }

    const bolts = []; // {pts, born, life, w, branches:[pts...]}

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function spawnBorderBolt(targetEl, edge="random"){
      const r = rectOf(targetEl);
      const inset = 2;
      const pick = edge === "random" ? ["top","right","bottom","left"][Math.floor(Math.random()*4)] : edge;

      let x0,y0,x1,y1;
      if (pick === "top"){
        x0 = r.x + inset + Math.random()*(r.w - inset*2);
        y0 = r.y + inset;
        x1 = r.x + inset + Math.random()*(r.w - inset*2);
        y1 = r.y + inset;
      } else if (pick === "bottom"){
        x0 = r.x + inset + Math.random()*(r.w - inset*2);
        y0 = r.y + r.h - inset;
        x1 = r.x + inset + Math.random()*(r.w - inset*2);
        y1 = r.y + r.h - inset;
      } else if (pick === "left"){
        x0 = r.x + inset;
        y0 = r.y + inset + Math.random()*(r.h - inset*2);
        x1 = r.x + inset;
        y1 = r.y + inset + Math.random()*(r.h - inset*2);
      } else {
        x0 = r.x + r.w - inset;
        y0 = r.y + inset + Math.random()*(r.h - inset*2);
        x1 = r.x + r.w - inset;
        y1 = r.y + inset + Math.random()*(r.h - inset*2);
      }

      // travel along edge
      if (pick === "top" || pick === "bottom"){
        x1 = x0 + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random()*180);
        x1 = clamp(x1, r.x + inset, r.x + r.w - inset);
      } else {
        y1 = y0 + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random()*180);
        y1 = clamp(y1, r.y + inset, r.y + r.h - inset);
      }

      const pts = makeBolt(x0,y0,x1,y1, 14, 14);
      const branches = [];
      const b1 = branchFrom(pts, 0.55);
      const b2 = branchFrom(pts, 0.35);
      if (b1) branches.push(b1);
      if (b2) branches.push(b2);

      bolts.push({
        pts,
        branches,
        born: performance.now(),
        life: 280 + Math.random()*520,
        w: 1.2 + Math.random()*1.4
      });
    }

    function spawnRingArc(){
      const ringRect = rectOf(document.getElementById("ring"));
      const cx = ringRect.x + ringRect.w/2;
      const cy = ringRect.y + ringRect.h/2;
      const rad = ringRect.w/2 - 18;
      const a0 = Math.random() * Math.PI * 2;
      const a1 = a0 + (Math.random() > 0.5 ? 1 : -1) * (0.7 + Math.random()*1.0);
      const x0 = cx + Math.cos(a0)*rad;
      const y0 = cy + Math.sin(a0)*rad;
      const x1 = cx + Math.cos(a1)*rad;
      const y1 = cy + Math.sin(a1)*rad;

      const pts = makeBolt(x0,y0,x1,y1, 18, 18);
      bolts.push({
        pts,
        branches: [],
        born: performance.now(),
        life: 240 + Math.random()*380,
        w: 1.2 + Math.random()*1.2
      });
    }

    function drawBoltPath(pts, alpha, width){
      fx.beginPath();
      fx.moveTo(pts[0].x, pts[0].y);
      for (let i=1;i<pts.length;i++){
        fx.lineTo(pts[i].x, pts[i].y);
      }

      // glow underlay
      fx.globalAlpha = alpha * 0.65;
      fx.lineWidth = width * 5.0;
      fx.strokeStyle = "rgba(45,125,255,1)";
      fx.shadowBlur = 20;
      fx.shadowColor = "rgba(45,125,255,0.8)";
      fx.stroke();

      // bright core
      fx.globalAlpha = alpha;
      fx.lineWidth = width;
      fx.strokeStyle = "rgba(123,231,255,1)";
      fx.shadowBlur = 0;
      fx.stroke();
    }

    function stepLightning(){
      fx.clearRect(0,0,fxW,fxH);
      const now = performance.now();

      for (let i=bolts.length-1;i>=0;i--){
        const b = bolts[i];
        const age = now - b.born;
        const t = age / b.life;
        if (t >= 1){
          bolts.splice(i,1);
          continue;
        }
        // quick flash curve
        const alpha = (t < 0.15) ? (t/0.15) : (t < 0.55 ? 1 : (1 - (t-0.55)/0.45));
        drawBoltPath(b.pts, alpha, b.w);

        for (const br of b.branches){
          drawBoltPath(br, alpha * 0.8, Math.max(0.9, b.w*0.85));
        }
      }

      requestAnimationFrame(stepLightning);
    }
    stepLightning();

    // periodic scheduling (random-ish, unobtrusive)
    const bayEl = document.getElementById("bay");
    const cockpitEl = document.getElementById("cockpit");
    const topbarEl = document.querySelector(".topbar");

    function scheduleSparks(){
      const burst = Math.random() < 0.65;
      const targets = [bayEl, cockpitEl, topbarEl];

      const count = burst ? (1 + Math.floor(Math.random()*3)) : 1;
      for (let i=0;i<count;i++){
        const t = targets[Math.floor(Math.random()*targets.length)];
        spawnBorderBolt(t, "random");
      }

      if (Math.random() < 0.35){
        spawnRingArc();
      }

      const next = 1200 + Math.random()*3800;
      setTimeout(scheduleSparks, next);
    }
    setTimeout(scheduleSparks, 900);

    /************************************************************
     * Keyboard: ESC closes modal
     ************************************************************/
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.style.display === "flex"){
        overlay.style.display = "none";
      }
    });
  </script>
</body>
</html>
